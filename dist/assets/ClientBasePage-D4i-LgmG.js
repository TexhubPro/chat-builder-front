import{x as ee,A as S,l as se,n as te,r,q as E,j as e,s as F}from"./index-BKExW_na.js";import{D as ae,c as m,b as x,I as k,h as O,m as ne,d as le,e as ie,s as y}from"./DashboardLayout-DDZNcain.js";import{b as re,c as D}from"./usePageSeo-8KitHnL0.js";import{a as ce}from"./chunk-VF35X3H6-B4TsPbG8.js";import{i as oe}from"./chunk-SQIAVXJX-CJKqvBGK.js";import{t as H,a as f}from"./chunk-ML27DD5T-NeMMzR39.js";import{c as P}from"./chunk-EIRINNCE-DXQX58KB.js";import{m as de}from"./chunk-R7OT77UN-DRNPAq56.js";import"./index-zleLmW-F.js";import"./index-Dj2uZsLI.js";import"./useLabel-FUFqMuRp.js";import"./chunk-ICU6NNET-lVXZrmBV.js";import"./useListState-DDHPv_Kn.js";async function ue(l){return(l.headers.get("content-type")??"").includes("application/json")?l.json():null}async function G(l,a,i={}){const s=new Headers(i.headers??{});s.has("Accept")||s.set("Accept","application/json"),typeof i.body<"u"&&i.body!==null&&!s.has("Content-Type")&&s.set("Content-Type","application/json"),s.set("Authorization",`Bearer ${a}`);const d=await fetch(`${ee}${l}`,{...i,headers:s}),c=await ue(d);if(!d.ok){const g=typeof c=="object"&&c!==null&&"message"in c&&typeof c.message=="string"?c.message:"Request failed.";throw new S(g,d.status,c)}return c}function me(l){const a=new URLSearchParams;Object.entries(l).forEach(([s,d])=>{typeof d>"u"||a.set(s,String(d))});const i=a.toString();return i===""?"":`?${i}`}async function xe(l,a={}){return G(`/client-base${me({search:a.search,status:a.status&&a.status!=="all"?a.status:void 0,limit:a.limit})}`,l,{method:"GET"})}async function pe(l,a){return G(`/client-base/${a}`,l,{method:"GET"})}function R(l){const a=l.trim();if(a==="")return"?";const i=a.split(/\s+/u).filter(Boolean),s=i[0]?.[0]??"",d=i[1]?.[0]??"",c=`${s}${d}`.trim().toUpperCase();return c===""?a.slice(0,1).toUpperCase():c}function T(l,a){if(!l)return"-";const i=new Date(l);return Number.isNaN(i.getTime())?"-":new Intl.DateTimeFormat(a==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}).format(i)}function U(l,a,i){return new Intl.NumberFormat(i==="ru"?"ru-RU":"en-US",{minimumFractionDigits:0,maximumFractionDigits:2}).format(l)+` ${a}`}function he(l){switch(l){case"order":return"solar:cart-3-linear";case"appointment":return"solar:calendar-linear";case"task":return"solar:checklist-minimalistic-linear";case"question":return"solar:question-circle-linear";default:return"solar:history-linear"}}function Ae(){const{user:l,logout:a}=se(),{locale:i,messages:s}=te(),[d,c]=r.useState(!1),[g,B]=r.useState(!0),[Q,L]=r.useState(!1),[b,J]=r.useState(""),[v,K]=r.useState("all"),[A,j]=r.useState(null),[C,M]=r.useState([]),[N,V]=r.useState({all:0,active:0,archived:0,blocked:0}),[W,q]=r.useState(!1),[o,$]=r.useState(null),[u,z]=r.useState({orders:[],appointments:[],tasks:[],questions:[],timeline:[]});re({title:`${s.clientBase.title} | ${s.app.name}`,description:s.clientBase.subtitle,locale:i});const X=async()=>{c(!0);try{await a()}finally{c(!1)}},w=r.useCallback(async()=>{const t=E();if(!t){j(s.clientBase.unauthorized),B(!1);return}B(!0),j(null);try{const h=await xe(t,{search:b.trim()===""?void 0:b.trim(),status:v,limit:120});M(fe(h.clients)),V(h.counts)}catch(h){j(h instanceof S?h.message:s.clientBase.loadFailed)}finally{B(!1)}},[s.clientBase.loadFailed,s.clientBase.unauthorized,b,v]);r.useEffect(()=>{const t=window.setTimeout(()=>{w()},220);return()=>{window.clearTimeout(t)}},[w]);const Y=r.useCallback(async t=>{const h=E();if(!h){j(s.clientBase.unauthorized);return}q(!0),L(!0),j(null);try{const p=await pe(h,t);$(p.client),z({orders:p.history.orders.map(n=>({id:n.id,service_name:n.service_name,status:n.status,total_price:n.total_price,currency:n.currency,ordered_at:n.ordered_at,notes:n.notes})),appointments:p.history.appointments.map(n=>({id:n.id,title:n.title,status:n.status,starts_at:n.starts_at,timezone:n.timezone})),tasks:p.history.tasks.map(n=>({id:n.id,description:n.description,status:n.status,priority:n.priority,created_at:n.created_at})),questions:p.history.questions.map(n=>({id:n.id,description:n.description,status:n.status,created_at:n.created_at})),timeline:p.history.timeline})}catch(p){j(p instanceof S?p.message:s.clientBase.detailsFailed)}finally{L(!1)}},[s.clientBase.detailsFailed,s.clientBase.unauthorized]),_=r.useMemo(()=>({all:N.all,active:N.active,archived:N.archived}),[N]),I=r.useCallback(t=>{switch(t){case"archived":return s.clientBase.statusArchived;case"blocked":return s.clientBase.statusBlocked;default:return s.clientBase.statusActive}},[s.clientBase.statusActive,s.clientBase.statusArchived,s.clientBase.statusBlocked]),Z=r.useCallback(t=>{switch(t){case"order":return s.clientBase.historyTypeOrder;case"appointment":return s.clientBase.historyTypeAppointment;case"task":return s.clientBase.historyTypeTask;case"question":return s.clientBase.historyTypeQuestion;default:return t}},[s.clientBase.historyTypeAppointment,s.clientBase.historyTypeOrder,s.clientBase.historyTypeQuestion,s.clientBase.historyTypeTask]);return e.jsxs(ae,{title:s.clientBase.title,user:l,onLogout:X,isLoggingOut:d,defaultSelectedKey:"client-base",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("p",{className:"text-sm text-default-500",children:s.clientBase.subtitle}),e.jsx(D,{size:"sm",variant:"flat",onPress:()=>{w()},children:s.clientBase.refreshButton})]}),A?e.jsx(ce,{color:"danger",variant:"faded",title:s.clientBase.errorTitle,description:A}):null,e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(x,{className:"gap-3 sm:flex-row sm:items-center",children:[e.jsx(oe,{value:b,onValueChange:J,placeholder:s.clientBase.searchPlaceholder,startContent:e.jsx(k,{icon:"solar:magnifer-linear",width:16})}),e.jsxs(H,{selectedKey:v,onSelectionChange:t=>{K(String(t))},size:"sm",radius:"full",color:"primary",variant:"solid",classNames:{tabList:"bg-default-100"},children:[e.jsx(f,{title:`${s.clientBase.statusAll} (${_.all})`},"all"),e.jsx(f,{title:`${s.clientBase.statusActive} (${_.active})`},"active"),e.jsx(f,{title:`${s.clientBase.statusArchived} (${_.archived})`},"archived")]})]})}),g?e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsx(x,{className:"flex min-h-[240px] items-center justify-center",children:e.jsx(F,{label:s.clientBase.loading,size:"sm"})})}):C.length===0?e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsx(x,{className:"flex min-h-[220px] items-center justify-center text-sm text-default-500",children:s.clientBase.empty})}):e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 xl:grid-cols-3",children:C.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(x,{className:"space-y-2.5 p-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(O,{src:t.avatar??void 0,name:t.name,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:R(t.name)}),className:"h-10 w-10 shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-base font-semibold text-foreground",children:t.name}),e.jsx("p",{className:"truncate text-sm text-default-500",children:t.phone})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(P,{size:"sm",variant:"flat",color:t.status==="blocked"?"danger":t.status==="archived"?"default":"success",children:I(t.status)}),e.jsx(D,{isIconOnly:!0,size:"sm",variant:"light",radius:"full","aria-label":s.clientBase.viewHistoryButton,onPress:()=>{Y(t.id)},children:e.jsx(k,{icon:"solar:history-linear",width:18})})]})]}),e.jsxs("div",{className:"rounded-large bg-default-100 px-3 py-2 text-sm",children:[e.jsx("p",{className:"text-default-500",children:s.clientBase.totalSpent}),e.jsx("p",{className:"font-semibold text-foreground",children:U(t.stats.total_spent,t.stats.currency,i)})]})]})},t.id))})]}),e.jsx(ne,{isOpen:W,onOpenChange:t=>{t||(q(!1),$(null),z({orders:[],appointments:[],tasks:[],questions:[],timeline:[]}))},size:"4xl",scrollBehavior:"inside",children:e.jsxs(le,{children:[e.jsx(de,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold",children:s.clientBase.modalTitle}),e.jsx("p",{className:"text-sm font-normal text-default-500",children:s.clientBase.modalSubtitle})]})}),e.jsx(ie,{className:"pb-5",children:Q?e.jsx("div",{className:"flex min-h-[220px] items-center justify-center",children:e.jsx(F,{label:s.clientBase.modalLoading,size:"sm"})}):o?e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{shadow:"none",className:"border border-default-200 bg-default-50",children:e.jsxs(x,{className:"gap-3 sm:flex-row sm:items-center",children:[e.jsx(O,{src:o.avatar??void 0,name:o.name,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:R(o.name)}),className:"h-12 w-12"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-base font-semibold",children:o.name}),e.jsxs("p",{className:"truncate text-sm text-default-600",children:[s.clientBase.phoneLabel,": ",o.phone]}),o.email?e.jsxs("p",{className:"truncate text-sm text-default-600",children:[s.clientBase.emailLabel,": ",o.email]}):null,o.notes?e.jsxs("p",{className:"line-clamp-2 text-sm text-default-500",children:[s.clientBase.notesLabel,": ",o.notes]}):null]}),e.jsxs(P,{size:"sm",variant:"flat",color:o.status==="blocked"?"danger":o.status==="archived"?"default":"success",children:[s.clientBase.statusLabel,": ",I(o.status)]})]})}),e.jsxs(H,{size:"sm",radius:"full",variant:"bordered",children:[e.jsx(f,{title:s.clientBase.timelineTab,children:u.timeline.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noTimeline}):e.jsx(y,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.timeline.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsx(x,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"flex items-center gap-1.5 text-xs text-default-500",children:[e.jsx(k,{icon:he(t.type),width:14}),Z(t.type)]}),e.jsx("p",{className:"line-clamp-2 text-sm font-medium text-foreground",children:t.title}),t.description?e.jsx("p",{className:"line-clamp-2 text-xs text-default-500",children:t.description}):null]}),e.jsx("span",{className:"shrink-0 text-xs text-default-500",children:T(t.happened_at,i)})]})})},`${t.type}-${t.id}`))})})},"timeline"),e.jsx(f,{title:s.clientBase.ordersTab,children:u.orders.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noOrders}):e.jsx(y,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.orders.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(x,{className:"space-y-1 p-3",children:[e.jsxs("p",{className:"text-sm font-semibold text-foreground",children:[s.clientBase.orderServiceLabel,": ",t.service_name]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.orderAmountLabel,":"," ",U(t.total_price,t.currency,i)]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.orderStatusLabel,": ",t.status]}),e.jsx("p",{className:"text-xs text-default-500",children:T(t.ordered_at,i)})]})},t.id))})})},"orders"),e.jsx(f,{title:s.clientBase.appointmentsTab,children:u.appointments.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noAppointments}):e.jsx(y,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.appointments.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(x,{className:"space-y-1 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t.title}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.appointmentDateLabel,":"," ",T(t.starts_at,i)]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.appointmentStatusLabel,": ",t.status]})]})},t.id))})})},"appointments"),e.jsx(f,{title:s.clientBase.tasksTab,children:u.tasks.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noTasks}):e.jsx(y,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.tasks.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(x,{className:"space-y-1 p-3",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.description}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.taskStatusLabel,": ",t.status]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.taskPriorityLabel,": ",t.priority]})]})},t.id))})})},"tasks"),e.jsx(f,{title:s.clientBase.questionsTab,children:u.questions.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noQuestions}):e.jsx(y,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.questions.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(x,{className:"space-y-1 p-3",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.description}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.questionStatusLabel,": ",t.status]})]})},t.id))})})},"questions")]})]}):null})]})})]})}function fe(l){return l.map(a=>({...a,stats:{...a.stats,currency:a.stats.currency.trim()===""?"TJS":a.stats.currency}}))}export{Ae as default};
