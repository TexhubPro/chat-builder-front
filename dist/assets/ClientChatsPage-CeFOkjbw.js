import{A as y,l as ut,n as ht,r,B as F,j as e,z as fe}from"./index-Cl4obW8r.js";import{D as mt,v as Re,w as Le,I as z,q as $e,B as U,C as ft,y as Pe,z as Ee,x as pt}from"./DashboardLayout-C4OrwLBC.js";import{b as xt,c as R}from"./usePageSeo-C-NJn5fi.js";import{a as gt}from"./chunk-VF35X3H6-DenNg_FE.js";import{t as bt,a as yt}from"./chunk-ML27DD5T-dmIp4L9i.js";import{i as P}from"./chunk-SQIAVXJX-B8YR62C3.js";import{d as Ct}from"./index-L9Vv239F.js";import{s as _t}from"./chunk-I3A4XRYQ-qoKzwi0V.js";import{m as jt,a as vt}from"./chunk-R7OT77UN-MKUcjduT.js";import{t as wt}from"./chunk-WEIB4WXA-CPOc3NhX.js";import"./index-CqnmybEa.js";import"./useListState-_PN8grmZ.js";import"./useLabel-CHYhfvUF.js";import"./chunk-ICU6NNET-DePoEaEU.js";import"./useToggleState-BuGWtfOh.js";const Nt="http://127.0.0.1:8000/api".replace(/\/$/,"");async function St(l){return(l.headers.get("content-type")??"").includes("application/json")?l.json():null}async function k(l,c,n={}){const s=new Headers(n.headers??{}),C=typeof FormData<"u"&&n.body instanceof FormData;s.has("Accept")||s.set("Accept","application/json"),typeof n.body<"u"&&n.body!==null&&!C&&!s.has("Content-Type")&&s.set("Content-Type","application/json"),s.set("Authorization",`Bearer ${c}`);const j=await fetch(`${Nt}${l}`,{...n,headers:s}),w=await St(j);if(!j.ok){const K=typeof w=="object"&&w!==null&&"message"in w&&typeof w.message=="string"?w.message:"Request failed.";throw new y(K,j.status,w)}return w}function He(l){const c=new URLSearchParams;Object.entries(l).forEach(([s,C])=>{typeof C>"u"||c.set(s,String(C))});const n=c.toString();return n===""?"":`?${n}`}async function It(l,c={}){const n=He({channel:c.channel,search:c.search,limit:c.limit});return k(`/chats${n}`,l,{method:"GET"})}async function kt(l,c,n=120){return k(`/chats/${c}${He({limit:n})}`,l,{method:"GET"})}async function Tt(l,c){return k(`/chats/${c}/read`,l,{method:"POST"})}async function Be(l,c,n){if(n.file instanceof File){const s=new FormData;return typeof n.text=="string"&&s.set("text",n.text),typeof n.sender_type=="string"&&s.set("sender_type",n.sender_type),typeof n.direction=="string"&&s.set("direction",n.direction),typeof n.message_type=="string"&&s.set("message_type",n.message_type),s.set("file",n.file),k(`/chats/${c}/messages`,l,{method:"POST",body:s})}return k(`/chats/${c}/messages`,l,{method:"POST",body:JSON.stringify(n)})}async function At(l,c,n){return k(`/chats/${c}/assistant-reply`,l,{method:"POST",body:JSON.stringify(n)})}async function Mt(l,c){return k(`/chats/${c}/insights`,l,{method:"GET"})}async function Ot(l,c,n){return k(`/chats/${c}/ai-enabled`,l,{method:"PATCH",body:JSON.stringify({enabled:n})})}async function Ft(l,c,n){return k(`/chats/${c}/orders`,l,{method:"POST",body:JSON.stringify(n)})}const Dt=["all","instagram","telegram","widget","api","assistant"],zt=4*1024*1024,E={phone:"",serviceName:"",address:"",amount:"",note:""};function Rt(l){return l.startsWith("image/")?"image":l.startsWith("video/")?"video":l.startsWith("audio/")?"audio":"file"}function qe(l,c){if(!l)return"";const n=new Date(l);return Number.isNaN(n.getTime())?"":new Date().toDateString()===n.toDateString()?new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{hour:"2-digit",minute:"2-digit"}).format(n):new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"short"}).format(n)}function Lt(l,c){if(!l)return"";const n=new Date(l);return Number.isNaN(n.getTime())?"":new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}).format(n)}function se(l){const c=[...l];return c.sort((n,s)=>{const C=Date.parse(n.last_message_at??n.updated_at??n.created_at??"");return Date.parse(s.last_message_at??s.updated_at??s.created_at??"")-C}),c}function J(l){const c=(l??"").trim();if(c==="")return"?";const n=c.split(/\s+/u).filter(Boolean),s=n[0]?.[0]??"",C=n[1]?.[0]??"",j=`${s}${C}`.trim().toUpperCase();return j===""?c.slice(0,1).toUpperCase():j}function $t(l){if(l.text&&l.text.trim()!=="")return l.text;switch(l.message_type){case"image":return"[Image]";case"video":return"[Video]";case"voice":return"[Voice]";case"audio":return"[Audio]";case"link":return"[Link]";case"file":return"[File]";default:return"[Message]"}}function Ve(l){if(!l||!l.metadata||typeof l.metadata!="object")return!0;const c=l.metadata.is_active;if(typeof c=="boolean")return c;if(typeof c=="number")return c===1;if(typeof c=="string"){const n=c.trim().toLowerCase();if(["1","true","yes","on"].includes(n))return!0;if(["0","false","no","off"].includes(n))return!1}return!0}function es(){const{user:l,logout:c}=ut(),{locale:n,messages:s}=ht(),[C,j]=r.useState(!1),[w,K]=r.useState(!0),[Ue,pe]=r.useState(!1),[T,G]=r.useState(!1),[Je,W]=r.useState(!1),[Ke,xe]=r.useState(!1),[Ge,B]=r.useState(!1),[q,ge]=r.useState(!1),[ae,be]=r.useState(!1),[We,Q]=r.useState(0),[ye,ne]=r.useState(!1),[ie,Qe]=r.useState("all"),[X,Xe]=r.useState(""),[Ce,_e]=r.useState("auto"),[je,L]=r.useState([]),[re,ve]=r.useState([]),[we,Ne]=r.useState(!0),[f,le]=r.useState(null),[u,N]=r.useState(null),[$,A]=r.useState([]),[D,Y]=r.useState(""),[M,oe]=r.useState(null),[b,v]=r.useState(E),[V,ce]=r.useState(null),[Se,p]=r.useState(null),de=r.useRef(null),Ie=r.useRef(null),ke=r.useRef(0),ue=r.useRef({}),he=We>0;xt({title:`${s.clientChats.title} | ${s.app.name}`,description:s.clientChats.subtitle,locale:n});const Ye=async()=>{j(!0);try{await c()}finally{j(!1)}},S=r.useCallback(t=>{L(a=>{const i=[t,...a.filter(d=>d.id!==t.id)];return se(i)}),N(a=>a?.id===t.id?t:a)},[]),Z=r.useCallback(async(t,a,i=!1)=>{const d=F();if(!d){p(s.clientChats.unauthorized);return}i||pe(!0);try{const o=await kt(d,t,150);if(N(o.chat),A(o.messages),ve(o.assistants.map(m=>({id:m.id,name:m.name,is_active:m.is_active}))),Ne(o.subscription?.has_active_subscription??!0),a&&o.chat.unread_count>0){const m=await Tt(d,t);N(m.chat),S(m.chat)}else S(o.chat)}catch(o){if(o instanceof y&&o.status===401){p(s.clientChats.unauthorized);return}p(o instanceof y?o.message:s.clientChats.loadFailed)}finally{i||pe(!1)}},[s.clientChats.loadFailed,s.clientChats.unauthorized,S]),ee=r.useCallback(async(t=!0,a=!1)=>{const i=F();if(!i){p(s.clientChats.unauthorized);return}a||K(!0);try{const d=await It(i,{channel:ie,search:X.trim()===""?void 0:X.trim(),limit:90});L(se(d.chats)),ve(d.assistants.map(o=>({id:o.id,name:o.name,is_active:o.is_active}))),Ne(d.subscription?.has_active_subscription??!0),le(o=>t&&o!==null&&d.chats.some(m=>m.id===o)?o:null),d.chats.length===0&&(N(null),A([]),ne(!1))}catch(d){if(d instanceof y&&d.status===401){p(s.clientChats.unauthorized);return}p(d instanceof y?d.message:s.clientChats.loadFailed)}finally{a||K(!1)}},[ie,s.clientChats.loadFailed,s.clientChats.unauthorized,X]);r.useEffect(()=>{ee(!1)},[ee]),r.useEffect(()=>{if(f===null){N(null),A([]);return}Z(f,!0)},[Z,f]),r.useEffect(()=>{W(!1),oe(null),B(!1),v(E),ce(null),ue.current={}},[f]),r.useEffect(()=>{const t=window.setInterval(()=>{ee(!0,!0),f!==null&&Z(f,!1,!0)},6e3);return()=>{window.clearInterval(t)}},[Z,ee,f]),r.useEffect(()=>{if(!u){_e("auto");return}_e(u.assistant?.id?String(u.assistant.id):"auto")},[u]),r.useEffect(()=>{de.current&&de.current.scrollIntoView({behavior:"smooth",block:"end"})},[$]),r.useEffect(()=>{if(V===null)return;const t=ue.current[V];if(!t)return;t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"});const a=window.setTimeout(()=>{ce(i=>i===V?null:i)},2200);return()=>{window.clearTimeout(a)}},[$,V]);const Te=r.useCallback(()=>(ke.current+=1,-ke.current),[]),H=r.useCallback(t=>{const a=Te(),i=new Date().toISOString(),d={id:a,chat_id:f??0,assistant_id:t.assistant_id??u?.assistant?.id??null,sender_type:t.sender_type,direction:t.direction,status:t.status??"sent",channel_message_id:t.channel_message_id??null,message_type:t.message_type??"text",text:t.text,media_url:t.media_url??null,media_mime_type:t.media_mime_type??null,media_size:t.media_size??null,link_url:t.link_url??null,attachments:t.attachments??null,payload:t.payload??null,sent_at:t.sent_at??i,delivered_at:t.delivered_at??null,read_at:t.read_at??null,failed_at:t.failed_at??null,created_at:t.created_at??i};return A(o=>[...o,d]),a},[Te,u?.assistant?.id,f]),Ae=async()=>{if(!f||T)return;const t=F();if(!t){p(s.clientChats.unauthorized);return}const a=D.trim();if(a!==""){p(null),G(!0);try{const i=await Be(t,f,{text:a,sender_type:"agent",direction:"outbound",message_type:"text"});Y(""),i.chat_message&&A(d=>[...d,i.chat_message]),S(i.chat)}catch(i){i instanceof y&&i.status===401?p(s.clientChats.unauthorized):p(i instanceof y?i.message:s.clientChats.sendFailed)}finally{G(!1)}}},Me=async()=>{if(!f||T)return;const t=F();if(!t){p(s.clientChats.unauthorized);return}const a=D.trim();if(a==="")return;const i=Ce==="auto"?void 0:Number(Ce);p(null);const d=i!==void 0?re.find(h=>h.id===i)??null:(u?.assistant?.id?re.find(h=>h.id===u.assistant?.id)??null:null)??re.find(h=>h.is_active)??null,o=H({sender_type:"customer",direction:"inbound",message_type:"text",text:a,assistant_id:d?.id??u?.assistant?.id??null,status:"read",read_at:new Date().toISOString()}),m=new Date().toISOString();if(N(h=>h&&{...h,last_message_preview:a,last_message_at:m}),L(h=>se(h.map(g=>g.id===f?{...g,last_message_preview:a,last_message_at:m}:g))),Y(""),!we||!d?.is_active){H({sender_type:"system",direction:"outbound",message_type:"text",text:we?n==="ru"?"Ассистент не запущен. Запустите ассистента, чтобы получить ответ.":"Assistant is not running. Start the assistant to get a reply.":n==="ru"?"Подписка неактивна. Купите или продлите тариф, чтобы ассистент отвечал.":"Subscription is inactive. Purchase or renew a plan to get assistant replies.",assistant_id:d?.id??u?.assistant?.id??null});return}Q(h=>h+1);try{const h=await At(t,f,{prompt:a,assistant_id:d?.id});A(g=>[...g.map(_=>_.id===o?h.incoming_message:_),h.assistant_message]),S(h.chat)}catch(h){if(h instanceof y&&h.status===401)p(s.clientChats.unauthorized);else{const g=h instanceof y?h.message:s.clientChats.assistantReplyFailed;H({sender_type:"system",direction:"outbound",message_type:"text",text:g,assistant_id:d?.id??u?.assistant?.id??null})}}finally{Q(h=>Math.max(0,h-1))}},Ze=r.useCallback(()=>{T||Ie.current?.click()},[T]),et=r.useCallback(async t=>{const a=t.target.files?.[0];if(t.target.value="",!a||!f||T)return;if(a.size>zt){p(n==="ru"?"Размер файла должен быть не больше 4 MB.":"File size must be 4 MB or less.");return}const i=F();if(!i){p(s.clientChats.unauthorized);return}p(null),G(!0);const d=u?.channel==="assistant",o=Rt(a.type),m=a.name.trim()!==""?a.name.trim():o==="image"?"[Image]":o==="video"?"[Video]":o==="audio"?"[Audio]":"[File]",h=H({sender_type:d?"customer":"agent",direction:d?"inbound":"outbound",message_type:o,text:m,assistant_id:u?.assistant?.id??null,status:d?"read":"sent",read_at:d?new Date().toISOString():null}),g=new Date().toISOString();N(x=>x&&{...x,last_message_preview:m,last_message_at:g}),L(x=>se(x.map(_=>_.id===f?{..._,last_message_preview:m,last_message_at:g}:_))),d&&Q(x=>x+1);try{const x=await Be(i,f,{text:D.trim()===""?void 0:D.trim(),sender_type:d?"customer":"agent",direction:d?"inbound":"outbound",message_type:"file",file:a});A(_=>{const O=_.map(te=>te.id===h&&x.chat_message?x.chat_message:te);return x.assistant_message&&O.push(x.assistant_message),O}),Y(""),S(x.chat)}catch(x){A(_=>_.map(O=>O.id===h?{...O,status:"failed",failed_at:new Date().toISOString()}:O)),x instanceof y&&x.status===401?p(s.clientChats.unauthorized):p(x instanceof y?x.message:s.clientChats.sendFailed)}finally{d&&Q(x=>Math.max(0,x-1)),G(!1)}},[D,T,n,s.clientChats.sendFailed,s.clientChats.unauthorized,H,u?.channel,u?.assistant?.id,f,S]),tt=r.useCallback(t=>{switch(t){case"instagram":return s.clientChats.instagramTab;case"telegram":return s.clientChats.telegramTab;case"widget":return s.clientChats.widgetTab;case"api":return s.clientChats.apiTab;default:return t}},[s.clientChats.apiTab,s.clientChats.instagramTab,s.clientChats.telegramTab,s.clientChats.widgetTab]),st=r.useMemo(()=>({all:s.clientChats.allChatsTab,instagram:s.clientChats.instagramTab,telegram:s.clientChats.telegramTab,widget:s.clientChats.widgetTab,api:s.clientChats.apiTab,assistant:s.clientChats.assistantTab}),[s.clientChats.allChatsTab,s.clientChats.apiTab,s.clientChats.assistantTab,s.clientChats.instagramTab,s.clientChats.telegramTab,s.clientChats.widgetTab]),Oe=r.useMemo(()=>[...$].reverse().find(i=>i.id>0)?.id,[$]),at=r.useCallback(t=>{switch(t){case"task":return s.clientChats.historyTypeTask;case"question":return s.clientChats.historyTypeQuestion;case"order":return s.clientChats.historyTypeOrder;default:return t}},[s.clientChats.historyTypeOrder,s.clientChats.historyTypeQuestion,s.clientChats.historyTypeTask]),Fe=r.useCallback(async t=>{const a=F();if(!a){p(s.clientChats.unauthorized);return}xe(!0);try{const i=await Mt(a,t);oe({client:i.client,contacts:i.contacts,history:i.history})}catch(i){p(i instanceof y?i.message:s.clientChats.loadFailed)}finally{xe(!1)}},[s.clientChats.loadFailed,s.clientChats.unauthorized]),nt=r.useCallback(()=>{f&&(p(null),W(!0),Fe(f))},[Fe,f]),it=r.useCallback(async t=>{if(!f||!u||ae)return;const a=F();if(!a){p(s.clientChats.unauthorized);return}const i=Ve(u),d=(o,m)=>({...o,metadata:{...o.metadata??{},is_active:m}});p(null),be(!0),N(o=>!o||o.id!==f?o:d(o,t)),L(o=>o.map(m=>m.id===f?d(m,t):m));try{const o=await Ot(a,f,t);S(o.chat)}catch(o){N(m=>!m||m.id!==f?m:d(m,i)),L(m=>m.map(h=>h.id===f?d(h,i):h)),p(o instanceof y?o.message:s.clientChats.sendFailed)}finally{be(!1)}},[ae,s.clientChats.sendFailed,s.clientChats.unauthorized,u,f,S]),rt=r.useCallback(()=>{const t=M?.contacts.find(i=>i.key==="phone")?.value??"",a=M?.contacts.find(i=>i.key==="address")?.value??"";v({...E,phone:t,address:a}),p(null),B(!0)},[M?.contacts]),lt=r.useCallback(async()=>{if(!f||q)return;const t=F();if(!t){p(s.clientChats.unauthorized);return}const a=b.phone.trim(),i=b.serviceName.trim(),d=b.address.trim(),o=b.amount.trim(),m=b.note.trim();if(a===""||i===""||d===""){p(s.clientChats.orderModalRequiredFields);return}let h;if(o!==""){const g=Number(o);if(!Number.isFinite(g)||g<0){p(s.clientChats.orderModalInvalidAmount);return}h=g}p(null),ge(!0);try{const g=await Ft(t,f,{phone:a,service_name:i,address:d,amount:h,note:m===""?void 0:m,chat_message_id:Oe});v(E),B(!1),oe(x=>{const O=(x?.history??[]).filter(te=>te.id!==g.order.id);return{client:g.client??x?.client??null,contacts:g.contacts,history:[g.order,...O]}})}catch(g){p(g instanceof y?g.message:s.clientChats.sendFailed)}finally{ge(!1)}},[q,Oe,s.clientChats.orderModalInvalidAmount,s.clientChats.orderModalRequiredFields,s.clientChats.sendFailed,s.clientChats.unauthorized,b.address,b.amount,b.note,b.phone,b.serviceName,f]),ot=r.useCallback(t=>{t.chat_message_id&&(ce(t.chat_message_id),W(!1))},[]),I=u?.channel==="assistant",me=u?.assistant?.name?.trim()||u?.name?.trim()||"Assistant",ct=!!u?.assistant?.is_active,De=Ve(u),ze=T||he,dt=I?he:T;return e.jsxs(mt,{title:s.clientChats.title,user:l,onLogout:Ye,isLoggingOut:C,defaultSelectedKey:"client-chats",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{ref:Ie,type:"file",className:"hidden",onChange:t=>{et(t)}}),Se?e.jsx(gt,{color:"danger",variant:"faded",title:s.clientChats.errorTitle,description:Se}):null,e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[360px_minmax(0,1fr)]",children:[e.jsx(Re,{shadow:"none",className:`border border-default-200 bg-white ${ye?"hidden lg:flex":"flex"}`,children:e.jsxs(Le,{className:"p-0",children:[e.jsxs("div",{className:"space-y-3 border-b border-default-200 px-4 py-4",children:[e.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.subtitle}),e.jsx("div",{className:"max-w-full overflow-x-auto rounded-full bg-default-100 p-1",children:e.jsx(bt,{selectedKey:ie,onSelectionChange:t=>{Qe(String(t)),p(null)},size:"sm",radius:"sm",variant:"light",classNames:{base:"min-w-max",tabList:"bg-transparent p-0 flex-nowrap min-w-max gap-1",tab:" px-4 rounded-full border-none data-[selected=true]:bg-white data-[selected=true]:border-default-300 data-[selected=true]:shadow-none",tabContent:"text-default-600 group-data-[selected=true]:text-foreground",cursor:"hidden"},children:Dt.map(t=>e.jsx(yt,{title:e.jsx("span",{className:"whitespace-nowrap",children:st[t]})},t))})}),e.jsx(P,{size:"sm",value:X,radius:"full",onChange:t=>Xe(t.target.value),placeholder:s.clientChats.searchPlaceholder,startContent:e.jsx(z,{icon:"solar:magnifer-linear",width:16})})]}),e.jsx($e,{className:"",children:w?e.jsx("div",{className:"flex h-full items-center justify-center py-12",children:e.jsx(fe,{size:"sm",label:s.clientChats.loadingChats})}):je.length===0?e.jsx("div",{className:"px-4 py-8 text-sm text-default-500",children:s.clientChats.emptyChats}):e.jsx("div",{className:"divide-y divide-default-100",children:je.map(t=>{const a=t.id===f,i=t.name?.trim()||`#${t.id}`;return e.jsx("button",{type:"button",onClick:()=>{le(t.id),ne(!0),p(null)},className:`w-full px-4 py-3 text-left transition ${a?"bg-primary-50":"bg-transparent hover:bg-default-50"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(U,{src:t.channel==="assistant"?void 0:t.avatar??void 0,name:i,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:J(i)}),className:"h-9 w-9 shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"mb-1 flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex items-center gap-1.5",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:i}),t.unread_count>0?e.jsx("span",{className:"inline-flex h-4 min-w-4 items-center justify-center rounded-full bg-primary px-1 text-[10px] font-semibold leading-none text-white",children:t.unread_count>99?"99+":t.unread_count}):null]}),e.jsx("span",{className:"shrink-0 text-xs text-default-500",children:qe(t.last_message_at,n)})]}),e.jsx("p",{className:"mb-2 truncate text-xs text-default-500",children:t.last_message_preview??s.clientChats.noPreview})]})]})},t.id)})})})]})}),e.jsx(Re,{shadow:"none",className:`border border-default-200 bg-white ${ye?"flex":"hidden lg:flex"}`,children:e.jsx(Le,{className:"p-0",children:u?e.jsxs("div",{className:"flex h-[calc(100vh-180px)] flex-col bg-white",children:[e.jsx("div",{className:"space-y-3 border-b border-default-200 px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsx(R,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{le(null),ne(!1)},"aria-label":s.clientChats.backToList,children:e.jsx(z,{icon:"solar:alt-arrow-left-linear",width:18})}),e.jsx(U,{src:u.avatar??void 0,name:u.name??`#${u.id}`,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:J(u.name??`#${u.id}`)}),className:"h-9 w-9 shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground sm:text-base",children:u.name?.trim()||`#${u.id}`}),e.jsx("p",{className:"text-xs text-default-500",children:I?`Assistant · ${ct?n==="ru"?"Онлайн":"Online":n==="ru"?"Оффлайн":"Offline"}`:`${s.clientChats.channelLabel}: ${tt(u.channel)}`})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(R,{isIconOnly:!0,size:"sm",variant:"light",onPress:nt,"aria-label":s.clientChats.chatInfoButton,children:e.jsx(z,{icon:"solar:info-circle-linear",width:18,className:"text-default-500"})})})]})}),e.jsx($e,{className:"flex-1 bg-default-50 px-3 py-4 sm:px-4",children:Ue?e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(fe,{size:"sm",label:s.clientChats.loadingMessages})}):$.length===0?e.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.emptyMessages}):e.jsxs("div",{className:"mx-auto w-full max-w-[980px] space-y-5",children:[$.map(t=>{const a=I?t.sender_type==="customer"||t.sender_type==="agent":t.direction==="outbound",i=I?me:u.name?.trim()||`#${u.id}`,d=I?void 0:u.avatar??void 0,o=qe(t.sent_at??t.created_at,n),m=$t(t);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-end gap-2 ${a?"flex-row-reverse":"flex-row"}`,children:[a?null:e.jsx(U,{src:d,name:i,showFallback:!0,fallback:e.jsx("span",{className:"text-[11px] font-semibold text-default-700",children:J(i)}),className:"h-8 w-8 shrink-0"}),e.jsxs("div",{ref:h=>{ue.current[t.id]=h},className:`rounded-2xl border px-3 py-2 transition ${V===t.id?"ring-2 ring-primary-300 ring-offset-1 ring-offset-background":""} max-w-[88%] min-w-[148px] border-default-200 bg-default-100 sm:max-w-[74%]`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words text-sm text-foreground",children:m}),t.media_url?e.jsx("a",{href:t.media_url,target:"_blank",rel:"noreferrer",className:"mt-2 block text-xs text-primary hover:underline",children:t.media_url}):null,t.link_url?e.jsx("a",{href:t.link_url,target:"_blank",rel:"noreferrer",className:"mt-2 block text-xs text-primary hover:underline",children:t.link_url}):null,e.jsx("p",{className:"mt-1 text-right text-[11px] leading-none text-default-500",children:o})]})]})},t.id)}),I&&he?e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(U,{src:void 0,name:me,showFallback:!0,fallback:e.jsx("span",{className:"text-[11px] font-semibold text-default-700",children:J(me)}),className:"h-8 w-8 shrink-0"}),e.jsx("div",{className:"inline-flex w-auto rounded-2xl border border-default-200 bg-default-100 px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-1.5 py-1",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-default-400"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-default-400",style:{animationDelay:"120ms"}}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-default-400",style:{animationDelay:"240ms"}})]})})]})}):null,e.jsx("div",{ref:de})]})}),e.jsx(Ct,{}),e.jsx("div",{className:"border-t border-default-200 bg-white px-2 pt-2 pb-1 sm:px-2 sm:pb-2",children:e.jsx("div",{className:"mx-auto w-full max-w-full",children:e.jsxs("div",{className:"flex items-center gap-2 rounded-xl border border-default-200 bg-white px-2 py-0.5",children:[e.jsx(R,{isIconOnly:!0,size:"sm",variant:"light",onPress:Ze,isDisabled:ze,"aria-label":"Attach file",children:e.jsx(z,{icon:"solar:paperclip-linear",width:17})}),e.jsx(P,{value:D,onValueChange:Y,onKeyDown:t=>{if(t.key==="Enter"){if(t.preventDefault(),I){Me();return}Ae()}},placeholder:s.clientChats.messagePlaceholder,variant:"flat",className:"flex-1 bg-transparent hover:bg-transparent focus:bg-transparent",classNames:{inputWrapper:"bg-transparent shadow-none"}}),e.jsx(R,{isIconOnly:!0,size:"sm",color:"primary",radius:"md",onPress:()=>{if(I){Me();return}Ae()},isLoading:dt,isDisabled:ze||D.trim()==="","aria-label":I?s.clientChats.askAssistantButton:s.clientChats.sendButton,children:e.jsx(z,{icon:"solar:arrow-up-linear",width:16})})]})})})]}):e.jsx("div",{className:"flex h-[calc(100vh-180px)] items-center justify-center px-6",children:e.jsxs("div",{className:"max-w-sm space-y-2 text-center",children:[e.jsx(z,{icon:"solar:chat-round-line-outline",width:34,className:"mx-auto text-default-400"}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.clientChats.selectChatTitle}),e.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.selectChatDescription})]})})})})]})]}),e.jsx(ft,{isOpen:Je,onOpenChange:W,placement:"right",classNames:{base:"w-full sm:max-w-[460px]",wrapper:"shadow-none"},children:e.jsx(Pe,{children:()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-b border-default-200 px-4 py-3",children:e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:s.clientChats.chatInfoTitle}),e.jsx("p",{className:"text-xs text-default-500",children:s.clientChats.chatInfoDescription})]})})}),e.jsx(Ee,{className:"space-y-4 py-4",children:Ke?e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx(fe,{size:"sm"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 rounded-large border border-default-200 bg-default-50 px-3 py-2",children:[e.jsx(U,{src:u?.channel==="assistant"?void 0:u?.avatar??void 0,name:u?.name??"#",showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:J(u?.name)}),className:"h-10 w-10 shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:u?.name?.trim()||`#${u?.id??""}`}),e.jsxs("p",{className:"truncate text-xs text-default-500",children:[s.clientChats.chatInfoClient,":"," ",M?.client?.name?.trim()||"-"]})]})]}),e.jsx("div",{className:"rounded-large border border-default-200 bg-white px-3 py-2",children:e.jsx(_t,{size:"sm",isSelected:De,isDisabled:ae,onValueChange:t=>{it(t)},children:De?s.clientChats.chatInfoAiEnabled:s.clientChats.chatInfoAiDisabled})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.clientChats.chatInfoContactsTitle}),(M?.contacts.length??0)===0?e.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.chatInfoNoContacts}):e.jsx("div",{className:"space-y-2",children:(M?.contacts??[]).map(t=>e.jsxs("div",{className:"rounded-large border border-default-200 bg-white px-3 py-2",children:[e.jsx("p",{className:"text-[11px] uppercase tracking-wide text-default-500",children:t.label}),e.jsx("p",{className:"break-all text-sm text-foreground",children:t.value})]},t.key))})]}),e.jsx("div",{className:"pt-1",children:e.jsx(R,{color:"primary",onPress:rt,children:s.clientChats.chatInfoCreateOrderButton})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.clientChats.chatInfoHistoryTitle}),(M?.history.length??0)===0?e.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.chatInfoNoHistory}):e.jsx("div",{className:"space-y-2",children:(M?.history??[]).map(t=>{const a=typeof t.chat_message_id=="number"&&t.chat_message_id>0;return e.jsx("button",{type:"button",onClick:()=>ot(t),disabled:!a,className:`w-full rounded-large border border-default-200 px-3 py-2 text-left transition ${a?"bg-white hover:border-primary-300 hover:bg-primary-50/30":"cursor-default bg-default-50"}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:t.title}),e.jsxs("p",{className:"mt-0.5 text-xs text-default-500",children:[at(t.type)," ·"," ",Lt(t.created_at,n)]}),a?e.jsx("p",{className:"mt-1 text-[11px] text-primary",children:s.clientChats.chatInfoHistoryJumpHint}):null]}),a?e.jsx(z,{icon:"solar:alt-arrow-right-linear",width:16,className:"shrink-0 text-default-500"}):null]})},t.id)})})]})]})})]})})}),e.jsx(pt,{isOpen:Ge,onOpenChange:t=>{!t&&q||(B(t),t||v(E))},placement:"center",size:"lg",children:e.jsxs(Pe,{children:[e.jsx(jt,{className:"pb-1",children:s.clientChats.orderModalTitle}),e.jsxs(Ee,{className:"space-y-3",children:[e.jsx(P,{label:s.clientChats.orderModalPhoneLabel,placeholder:s.clientChats.orderModalPhonePlaceholder,value:b.phone,onValueChange:t=>{v(a=>({...a,phone:t}))},variant:"bordered"}),e.jsx(P,{label:s.clientChats.orderModalServiceLabel,placeholder:s.clientChats.orderModalServicePlaceholder,value:b.serviceName,onValueChange:t=>{v(a=>({...a,serviceName:t}))},variant:"bordered"}),e.jsx(P,{label:s.clientChats.orderModalAddressLabel,placeholder:s.clientChats.orderModalAddressPlaceholder,value:b.address,onValueChange:t=>{v(a=>({...a,address:t}))},variant:"bordered"}),e.jsx(P,{label:s.clientChats.orderModalAmountLabel,placeholder:s.clientChats.orderModalAmountPlaceholder,value:b.amount,onValueChange:t=>{v(a=>({...a,amount:t}))},variant:"bordered",inputMode:"decimal"}),e.jsx(wt,{label:s.clientChats.orderModalNoteLabel,placeholder:s.clientChats.orderModalNotePlaceholder,value:b.note,onValueChange:t=>{v(a=>({...a,note:t}))},variant:"bordered",minRows:3,maxRows:6})]}),e.jsxs(vt,{children:[e.jsx(R,{variant:"light",onPress:()=>{q||(B(!1),v(E))},children:s.clientChats.orderModalCancelButton}),e.jsx(R,{color:"primary",onPress:()=>{lt()},isLoading:q,children:s.clientChats.orderModalSubmitButton})]})]})})]})}export{es as default};
