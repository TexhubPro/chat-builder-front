import{t as fe,A as x,l as he,n as pe,g as xe,k as be,r as i,q as y,j as t,s as te}from"./index-DFt9vaGi.js";import{D as je,c as B,b as K,h as ye,I as U,m as ve,d as _e,e as Ne}from"./DashboardLayout-Ds61Xg-w.js";import{b as we,c as Ce,d as v}from"./usePageSeo-zMtdeAIZ.js";import{c as T}from"./chunk-EIRINNCE-CH2GcUft.js";import{s as ke}from"./chunk-I3A4XRYQ-Ip9gQi3L.js";import{d as Te}from"./index-DaMPhJ29.js";import{m as Se}from"./chunk-R7OT77UN-LecFBPqy.js";import{i as Ae}from"./chunk-SQIAVXJX-DXL5IOXk.js";import{m as ze}from"./chunk-5LXTSPS7-Bxyekykf.js";import"./useLabel-C9azh59v.js";import"./useToggleState-2DccyJzu.js";import"./chunk-KQW2TNLT-jIFc4Zc4.js";import"./chunk-ICU6NNET-Cscege8D.js";async function $e(g){return(g.headers.get("content-type")??"").includes("application/json")?g.json():null}async function S(g,u,m={}){const e=new Headers(m.headers??{});e.has("Accept")||e.set("Accept","application/json"),typeof m.body<"u"&&m.body!==null&&!e.has("Content-Type")&&e.set("Content-Type","application/json"),e.set("Authorization",`Bearer ${u}`);const b=await fetch(`${fe}${g}`,{...m,headers:e}),f=await $e(b);if(!b.ok){const P=typeof f=="object"&&f!==null&&"message"in f&&typeof f.message=="string"?f.message:"Request failed.";throw new x(P,b.status,f)}return f}async function se(g,u){const m=typeof u=="number"?`?assistant_id=${u}`:"";return S(`/assistant-channels${m}`,g,{method:"GET"})}async function De(g,u,m,e){return S(`/assistant-channels/${u}/${m}`,g,{method:"PATCH",body:JSON.stringify({enabled:e})})}async function Le(g,u,m){return S(`/assistant-channels/${u}/${m}`,g,{method:"DELETE"})}async function Fe(g,u){return S(`/assistant-channels/${u}/instagram/connect`,g,{method:"POST"})}async function Pe(g,u,m){return S(`/assistant-channels/${u}/telegram/connect`,g,{method:"POST",body:JSON.stringify({bot_token:m})})}function Ee(g){const u=(g??"").trim();if(u==="")return"?";const m=u.split(/\s+/u).filter(Boolean),e=m[0]?.[0]??"",b=m[1]?.[0]??"",f=`${e}${b}`.trim().toUpperCase();return f===""?u.slice(0,1).toUpperCase():f}function Qe(){const{user:g,logout:u}=he(),{locale:m,messages:e}=pe(),b=xe(),[f]=be(),[P,W]=i.useState(!1),[E,J]=i.useState(!0),[ne,G]=i.useState(!1),[H,O]=i.useState(!1),[A,V]=i.useState([]),[d,_]=i.useState(null),[N,p]=i.useState([]),[z,w]=i.useState(null),[ae,j]=i.useState({}),[ie,q]=i.useState(!1),[I,$]=i.useState(""),[D,Q]=i.useState(!1),[X,l]=i.useState(null),C=i.useMemo(()=>{const s=f.get("assistant_id");if(!s)return null;const n=Number.parseInt(s,10);return!Number.isFinite(n)||n<=0?null:n},[f]),M=f.get("instagram_status"),k=f.get("instagram_error");we({title:`${e.integrations.title} | ${e.app.name}`,description:e.integrations.subtitle,locale:m});const R=i.useMemo(()=>d!==null?A.find(s=>s.id===d)??null:null,[A,d]),re=i.useMemo(()=>({instagram:{title:e.integrations.channelInstagram,description:e.integrations.channelInstagramDescription,icon:"fa6-brands:instagram",iconClass:"bg-pink-100 text-pink-600"},telegram:{title:e.integrations.channelTelegram,description:e.integrations.channelTelegramDescription,icon:"solar:plain-2-linear",iconClass:"bg-blue-100 text-blue-600"},widget:{title:e.integrations.channelWidget,description:e.integrations.channelWidgetDescription,icon:"solar:widget-2-outline",iconClass:"bg-violet-100 text-violet-600"},api:{title:e.integrations.channelApi,description:e.integrations.channelApiDescription,icon:"solar:code-square-linear",iconClass:"bg-emerald-100 text-emerald-600"}}),[e.integrations.channelApi,e.integrations.channelApiDescription,e.integrations.channelInstagram,e.integrations.channelInstagramDescription,e.integrations.channelTelegram,e.integrations.channelTelegramDescription,e.integrations.channelWidget,e.integrations.channelWidgetDescription]),le=async()=>{W(!0);try{await u()}finally{W(!1)}},Y=i.useCallback(async()=>{const s=y();if(!s){l(e.integrations.unauthorized);return}J(!0);try{const n=await se(s);V(n.assistants),w(n.limits),p([]),_(null)}catch(n){n instanceof x&&n.status===401?l(e.integrations.unauthorized):l(n instanceof x?n.message:e.integrations.loadFailed)}finally{J(!1)}},[e.integrations.loadFailed,e.integrations.unauthorized]),L=i.useCallback(async s=>{const n=y();if(!n){l(e.integrations.unauthorized);return}G(!0);try{const a=await se(n,s);V(a.assistants),w(a.limits),p(a.channels),_(a.selected_assistant_id??s)}catch(a){a instanceof x&&a.status===401?l(e.integrations.unauthorized):l(a instanceof x?a.message:e.integrations.loadFailed)}finally{G(!1)}},[e.integrations.loadFailed,e.integrations.unauthorized]);i.useEffect(()=>{Y()},[Y]),i.useEffect(()=>{E||!(M!==null||k!==null||C!==null)||(k&&k.trim()!==""?l(k):l(null),M==="connected"&&C!==null&&(_(C),O(!0),L(C)),b("/integrations",{replace:!0}))},[C,k,M,E,L,b]);const oe=i.useCallback(s=>{l(null),_(s),O(!0),L(s)},[L]),ce=i.useCallback(()=>{_(null),p([]),O(!1),l(null)},[]),Z=i.useCallback(async(s,n)=>{if(!d)return;const a=y();if(!a){l(e.integrations.unauthorized);return}const c=`${d}:${s}`,o=N;j(r=>({...r,[c]:!0})),l(null),p(r=>r.map(h=>h.channel===s?{...h,is_connected:n?!0:h.is_connected,is_active:n}:h));try{const r=await De(a,d,s,n);p(h=>h.map(F=>F.channel===s?r.channel:F)),w(r.limits)}catch(r){p(o),l(r instanceof x?r.message:e.integrations.updateFailed)}finally{j(r=>{const h={...r};return delete h[c],h})}},[N,e.integrations.unauthorized,e.integrations.updateFailed,d]),de=i.useCallback(async s=>{if(!d)return;const n=y();if(!n){l(e.integrations.unauthorized);return}const a=`${d}:${s}`,c=N;j(o=>({...o,[a]:!0})),l(null),p(o=>o.map(r=>r.channel===s?{...r,id:null,assistant_id:null,name:null,external_account_id:null,is_connected:!1,is_active:!1,settings:{},metadata:{},updated_at:null}:r));try{const o=await Le(n,d,s);p(r=>r.map(h=>h.channel===s?o.channel:h)),w(o.limits)}catch(o){p(c),l(o instanceof x?o.message:e.integrations.updateFailed)}finally{j(o=>{const r={...o};return delete r[a],r})}},[N,e.integrations.unauthorized,e.integrations.updateFailed,d]),ue=i.useCallback(async()=>{if(!d)return;const s=y();if(!s){l(e.integrations.unauthorized);return}const n=`${d}:instagram`;j(a=>({...a,[n]:!0})),l(null);try{const a=await Fe(s,d);if(!a.authorization_url)throw new Error(e.integrations.updateFailed);window.location.assign(a.authorization_url)}catch(a){l(a instanceof x||a instanceof Error?a.message:e.integrations.updateFailed),j(c=>{const o={...c};return delete o[n],o})}},[e.integrations.unauthorized,e.integrations.updateFailed,d]),ge=i.useCallback(()=>{$(""),q(!0)},[]),ee=i.useCallback(()=>{D||(q(!1),$(""))},[D]),me=i.useCallback(async()=>{if(!d)return;const s=I.trim();if(s===""){l(e.integrations.telegramTokenRequired);return}const n=y();if(!n){l(e.integrations.unauthorized);return}const a=`${d}:telegram`;j(c=>({...c,[a]:!0})),Q(!0),l(null);try{const c=await Pe(n,d,s);p(o=>o.map(r=>r.channel==="telegram"?c.channel:r)),w(c.limits),q(!1),$("")}catch(c){l(c instanceof x?c.message:e.integrations.updateFailed)}finally{Q(!1),j(c=>{const o={...c};return delete o[a],o})}},[e.integrations.telegramTokenRequired,e.integrations.unauthorized,e.integrations.updateFailed,d,I]);return t.jsxs(je,{title:e.integrations.title,user:g,onLogout:le,isLoggingOut:P,defaultSelectedKey:"integrations",children:[t.jsxs("div",{className:"space-y-4",children:[X?t.jsx(Ce,{color:"danger",variant:"faded",title:e.integrations.errorTitle,description:X}):null,t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[340px_minmax(0,1fr)]",children:[t.jsx(B,{shadow:"none",className:`border border-default-200 bg-white ${H?"hidden lg:flex":"flex"}`,children:t.jsxs(K,{className:"space-y-4 p-4 sm:p-5",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.assistantsTitle}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.assistantsSubtitle})]}),E?t.jsx("div",{className:"flex items-center justify-center py-10",children:t.jsx(te,{size:"sm",label:e.integrations.loadingAssistants})}):A.length===0?t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.noAssistants}):t.jsx("div",{className:"space-y-2",children:A.map(s=>{const n=s.id===d;return t.jsx("button",{type:"button",onClick:()=>{oe(s.id)},className:`w-full rounded-large border px-3 py-3 text-left transition ${n?"border-primary-300 bg-primary-50":"border-default-200 bg-white hover:border-default-300 hover:bg-default-50"}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(ye,{name:s.name,showFallback:!0,fallback:t.jsx("span",{className:"text-xs font-semibold text-default-700",children:Ee(s.name)}),className:"h-10 w-10 shrink-0"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),t.jsx(T,{size:"sm",variant:"flat",color:s.is_active?"success":"default",className:"mt-1",children:s.is_active?e.integrations.assistantRunning:e.integrations.assistantStopped})]})]})},s.id)})})]})}),t.jsx(B,{shadow:"none",className:`border border-default-200 bg-white ${H?"flex":"hidden lg:flex"}`,children:t.jsx(K,{className:"p-0",children:R?t.jsxs("div",{className:"flex h-full flex-col",children:[t.jsxs("div",{className:"space-y-3 border-b border-default-200 px-4 py-4 sm:px-5",children:[t.jsx("div",{className:"flex items-center justify-between gap-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(v,{isIconOnly:!0,size:"sm",variant:"light",onPress:ce,"aria-label":e.integrations.backToAssistants,children:t.jsx(U,{icon:"solar:alt-arrow-left-linear",width:18})}),t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.channelsTitle})]})}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.channelsSubtitle}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx(T,{size:"sm",variant:"flat",color:"primary",children:R.name}),t.jsxs(T,{size:"sm",variant:"flat",color:"default",children:[e.integrations.activeIntegrationsLabel,":"," ",z?.active_integrations??0]}),t.jsxs(T,{size:"sm",variant:"flat",color:"default",children:[e.integrations.integrationLimitLabel,":"," ",z?.integrations_per_channel_limit??0]})]})]}),ne?t.jsx("div",{className:"flex flex-1 items-center justify-center py-14",children:t.jsx(te,{size:"sm",label:e.integrations.loadingChannels})}):t.jsx("div",{className:"grid gap-3 p-4 sm:grid-cols-2 sm:p-5",children:N.map(s=>{const n=s.channel,a=n==="api",c=re[n],o=`${R.id}:${s.channel}`,r=!!ae[o],h=s.external_account_id??s.name??null;return t.jsx(B,{shadow:"none",className:"border border-default-200 bg-default-50",children:t.jsxs(K,{className:"space-y-3 p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:`flex h-11 w-11 shrink-0 items-center justify-center rounded-full ${c?.iconClass??"bg-default-200 text-default-700"}`,children:t.jsx(U,{icon:c?.icon??"solar:link-linear",width:22})}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:c?.title??s.channel}),t.jsx("p",{className:"text-sm text-default-500",children:c?.description??""})]})]}),t.jsx(ke,{size:"sm",isSelected:s.is_connected&&s.is_active,isDisabled:r||a||!z?.has_active_subscription||!s.is_connected,onValueChange:F=>{Z(n,F)},"aria-label":e.integrations.toggleLabel})]}),t.jsx(Te,{}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(T,{size:"sm",variant:"flat",color:a?"warning":s.is_active?"success":"default",children:a?e.integrations.comingSoon:s.is_active?e.integrations.statusEnabled:e.integrations.statusDisabled}),t.jsxs("p",{className:"text-xs text-default-500",children:[e.integrations.accountLabel,":"," ",t.jsx("span",{className:"text-default-700",children:h??e.integrations.noConnection})]})]}),a?t.jsx(v,{color:"default",variant:"flat",className:"w-full",isDisabled:!0,children:e.integrations.comingSoon}):s.is_connected?t.jsx(v,{color:"danger",variant:"solid",className:"w-full",onPress:()=>{de(n)},isLoading:r,children:e.integrations.disconnectButton}):t.jsx(v,{color:"primary",variant:"solid",className:"w-full",onPress:()=>{if(n==="instagram"){ue();return}if(n==="telegram"){ge();return}Z(n,!0)},isLoading:r,isDisabled:!z?.has_active_subscription,children:e.integrations.connectButton})]})},s.channel)})})]}):t.jsx("div",{className:"flex h-[calc(100vh-220px)] items-center justify-center px-6",children:t.jsxs("div",{className:"max-w-md space-y-2 text-center",children:[t.jsx(U,{icon:"solar:link-circle-linear",width:36,className:"mx-auto text-default-400"}),t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.selectAssistantTitle}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.selectAssistantDescription})]})})})})]})]}),t.jsx(ve,{isOpen:ie,onOpenChange:s=>{s||ee()},children:t.jsxs(_e,{children:[t.jsx(Se,{children:e.integrations.telegramTokenModalTitle}),t.jsxs(Ne,{className:"space-y-3",children:[t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.telegramTokenModalDescription}),t.jsx(Ae,{autoFocus:!0,type:"password",label:e.integrations.telegramTokenLabel,placeholder:e.integrations.telegramTokenPlaceholder,value:I,onValueChange:$,autoComplete:"off"})]}),t.jsxs(ze,{children:[t.jsx(v,{variant:"light",onPress:ee,isDisabled:D,children:e.common.cancel}),t.jsx(v,{color:"primary",onPress:()=>{me()},isLoading:D,children:e.integrations.connectButton})]})]})})]})}export{Qe as default};
