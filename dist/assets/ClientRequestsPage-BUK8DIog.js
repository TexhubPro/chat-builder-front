import{t as ye,A,g as je,l as ve,n as Ne,r as i,q as k,j as t,s as _e}from"./index-C9lwm0RO.js";import{D as we,c as $,b as O,s as Ce,I as v,m as ne,d as ae,e as le}from"./DashboardLayout-CNFrOcaq.js";import{b as Ae,c as ie,d as R}from"./usePageSeo-DNlU2sGC.js";import{c as oe}from"./chunk-EIRINNCE-Bp8myULm.js";import{m as re}from"./chunk-R7OT77UN-C7bIi7hh.js";import{i as y}from"./chunk-SQIAVXJX-C1YuGKlr.js";import{s as Se,l as Te}from"./chunk-C3QHEOC2-CErSK2pk.js";import{s as De}from"./chunk-I3A4XRYQ-CtJ6RnJV.js";import{t as ke}from"./chunk-WEIB4WXA-48vgmJBZ.js";import{m as ce}from"./chunk-5LXTSPS7-CXnTtwrI.js";import"./index-BaAps9FY.js";import"./useLabel-B407BxOM.js";import"./chunk-KQW2TNLT-W8XIpxPA.js";import"./chunk-ICU6NNET-KIKolltN.js";import"./useListState-z0W8YwHt.js";import"./index-BKdJ1Z9u.js";import"./useToggleState-u3Gl4b88.js";async function Pe(r){return(r.headers.get("content-type")??"").includes("application/json")?r.json():null}async function W(r,d,u={}){const c=new Headers(u.headers??{});c.has("Accept")||c.set("Accept","application/json"),typeof u.body<"u"&&u.body!==null&&!c.has("Content-Type")&&c.set("Content-Type","application/json"),c.set("Authorization",`Bearer ${d}`);const e=await fetch(`${ye}${r}`,{...u,headers:c}),h=await Pe(e);if(!e.ok){const j=typeof h=="object"&&h!==null&&"message"in h&&typeof h.message=="string"?h.message:"Request failed.";throw new A(j,e.status,h)}return h}async function Le(r){return W("/client-requests",r,{method:"GET"})}async function K(r,d,u){return W(`/client-requests/${d}`,r,{method:"PATCH",body:JSON.stringify(u)})}async function Be(r,d){return W(`/client-requests/${d}`,r,{method:"DELETE"})}function Ie(r,d,u){return new Intl.NumberFormat(u==="ru"?"ru-RU":"en-US",{minimumFractionDigits:0,maximumFractionDigits:2}).format(r)+` ${d}`}function Fe(r,d){const u=new Date(r);if(Number.isNaN(u.getTime()))return{date:"",time:""};const c=new Intl.DateTimeFormat("en-CA",{timeZone:d,year:"numeric",month:"2-digit",day:"2-digit"}),e=new Intl.DateTimeFormat("en-GB",{timeZone:d,hour:"2-digit",minute:"2-digit",hourCycle:"h23"}),h=c.formatToParts(u),j=e.formatToParts(u),P=h.find(g=>g.type==="year")?.value??"",N=h.find(g=>g.type==="month")?.value??"",_=h.find(g=>g.type==="day")?.value??"",S=j.find(g=>g.type==="hour")?.value??"",T=j.find(g=>g.type==="minute")?.value??"";return{date:P&&N&&_?`${P}-${N}-${_}`:"",time:S&&T?`${S}:${T}`:""}}function ze(r,d,u){const c=new Date(r);return Number.isNaN(c.getTime())?"":new Intl.DateTimeFormat(u==="ru"?"ru-RU":"en-US",{timeZone:d,day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hourCycle:"h23"}).format(c)}function st(){const r=je(),{user:d,logout:u}=ve(),{locale:c,messages:e}=Ne(),[h,j]=i.useState(!1),[P,N]=i.useState(!0),[_,S]=i.useState(!1),[T,g]=i.useState(!1),[b,ue]=i.useState(!1),[V,de]=i.useState(!1),[H,L]=i.useState([]),[B,U]=i.useState(null),[D,I]=i.useState(null),[l,p]=i.useState(null),[Q,o]=i.useState(null),[X,F]=i.useState(null);Ae({title:`${e.clientRequests.title} | ${e.app.name}`,description:e.clientRequests.subtitle,locale:c});const me=async()=>{j(!0);try{await u()}finally{j(!1)}},Y=i.useCallback(async()=>{const s=k();if(!s){o(e.clientRequests.unauthorized),N(!1);return}N(!0);try{const n=await Le(s);ue(n.appointments_enabled),de(n.delivery_enabled),L(n.requests)}catch(n){o(n instanceof A?n.message:e.clientRequests.updateFailed)}finally{N(!1)}},[e.clientRequests.unauthorized,e.clientRequests.updateFailed]);i.useEffect(()=>{Y()},[Y]);const z=i.useMemo(()=>{const s=[{key:"new",label:e.clientRequests.columnNew},{key:"in_progress",label:e.clientRequests.columnInProgress}];return b&&s.push({key:"appointments",label:e.clientRequests.columnAppointments}),s.push({key:"completed",label:e.clientRequests.columnCompleted}),s},[b,e.clientRequests.columnAppointments,e.clientRequests.columnCompleted,e.clientRequests.columnInProgress,e.clientRequests.columnNew]),pe=i.useMemo(()=>{const s=new Map;return z.forEach(n=>{s.set(n.key,[])}),H.forEach(n=>{const a=s.get(n.board);a&&a.push(n)}),s},[z,H]),he=i.useMemo(()=>{if(V)return[{key:"new",label:e.clientRequests.statusNew},{key:"confirmed",label:e.clientRequests.statusConfirmed},{key:"handed_to_courier",label:e.clientRequests.statusHandedToCourier},{key:"delivered",label:e.clientRequests.statusDelivered},{key:"canceled",label:e.clientRequests.statusCanceled}];const s=[{key:"new",label:e.clientRequests.statusNew},{key:"in_progress",label:e.clientRequests.statusInProgress}];return b&&s.push({key:"appointments",label:e.clientRequests.statusAppointments}),s.push({key:"completed",label:e.clientRequests.statusCompleted}),s},[b,V,e.clientRequests.statusAppointments,e.clientRequests.statusCanceled,e.clientRequests.statusCompleted,e.clientRequests.statusConfirmed,e.clientRequests.statusDelivered,e.clientRequests.statusHandedToCourier,e.clientRequests.statusInProgress,e.clientRequests.statusNew]),G=i.useCallback(s=>{L(n=>n.map(a=>a.id===s.id?s:a))},[]),fe=i.useCallback(s=>{U(s);const n=!!s.appointment,a=n&&s.appointment?Fe(s.appointment.starts_at,s.appointment.timezone):{date:"",time:""};p({clientName:s.client.name,phone:s.client.phone,serviceName:s.service_name,address:s.address,amount:s.amount>0?String(s.amount):"",note:s.note,status:s.status,hasAppointment:n,appointmentDate:a.date,appointmentTime:a.time,appointmentDurationMinutes:s.appointment?.duration_minutes?String(s.appointment.duration_minutes):""}),o(null)},[]),Z=()=>{_||(U(null),p(null))},ge=async()=>{if(!B||!l||_)return;const s=k();if(!s){o(e.clientRequests.unauthorized);return}const n=l.clientName.trim(),a=l.phone.trim(),m=l.serviceName.trim(),w=l.address.trim(),C=l.amount.trim(),q=l.note.trim();if(n===""||a===""||m===""){o(e.clientRequests.requiredFields);return}let E;if(C!==""){const f=Number(C);if(!Number.isFinite(f)||f<0){o(e.clientRequests.invalidAmount);return}E=f}const x={status:l.status,client_name:n,phone:a,service_name:m,address:w===""?void 0:w,amount:E,note:q===""?void 0:q},J=!!B.appointment;if(b)if(l.hasAppointment){const f=l.appointmentDate.trim(),te=l.appointmentTime.trim(),se=l.appointmentDurationMinutes.trim();if(f===""||te===""||se===""){o(e.clientRequests.appointmentRequired);return}const M=Number(se);if(!Number.isFinite(M)||M<15||M>720){o(e.clientRequests.invalidDuration);return}x.book_appointment=!0,x.appointment_date=f,x.appointment_time=te,x.appointment_duration_minutes=Math.round(M)}else J&&(x.clear_appointment=!0);o(null),S(!0);try{const f=await K(s,B.id,x);G(f.request),F(e.clientRequests.updateSuccess),U(null),p(null)}catch(f){o(f instanceof A?f.message:e.clientRequests.updateFailed)}finally{S(!1)}},ee=i.useCallback(async(s,n)=>{const a=k();if(!a){o(e.clientRequests.unauthorized);return}o(null);try{const m=await K(a,s.id,{status:n});G(m.request)}catch(m){o(m instanceof A?m.message:e.clientRequests.updateFailed)}},[e.clientRequests.unauthorized,e.clientRequests.updateFailed,G]),qe=i.useCallback(async s=>{const n=k();if(!n){o(e.clientRequests.unauthorized);return}o(null);try{await K(n,s.id,{archived:!0}),L(a=>a.filter(m=>m.id!==s.id)),F(e.clientRequests.updateSuccess)}catch(a){o(a instanceof A?a.message:e.clientRequests.updateFailed)}},[e.clientRequests.unauthorized,e.clientRequests.updateFailed,e.clientRequests.updateSuccess]),xe=async()=>{if(!D||T)return;const s=k();if(!s){o(e.clientRequests.unauthorized);return}o(null),g(!0);try{await Be(s,D.id),L(n=>n.filter(a=>a.id!==D.id)),F(e.clientRequests.deleteSuccess),I(null)}catch(n){o(n instanceof A?n.message:e.clientRequests.deleteFailed)}finally{g(!1)}},Re=i.useCallback(s=>{switch(s){case"confirmed":return e.clientRequests.statusConfirmed;case"canceled":return e.clientRequests.statusCanceled;case"handed_to_courier":return e.clientRequests.statusHandedToCourier;case"delivered":return e.clientRequests.statusDelivered;case"appointments":return e.clientRequests.statusAppointments;case"in_progress":return e.clientRequests.statusInProgress;case"completed":return e.clientRequests.statusCompleted;default:return e.clientRequests.statusNew}},[e.clientRequests.statusAppointments,e.clientRequests.statusCanceled,e.clientRequests.statusCompleted,e.clientRequests.statusConfirmed,e.clientRequests.statusDelivered,e.clientRequests.statusHandedToCourier,e.clientRequests.statusInProgress,e.clientRequests.statusNew]),be=i.useCallback(s=>{if(!s)return"-";switch(s){case"instagram":return"Instagram";case"telegram":return"Telegram";case"widget":return c==="ru"?"Веб виджет":"Web widget";case"api":return"API";case"assistant":return c==="ru"?"Ассистент":"Assistant";default:return s}},[c]);return t.jsxs(we,{title:e.clientRequests.title,user:d,onLogout:me,isLoggingOut:h,defaultSelectedKey:"client-requests",children:[t.jsxs("div",{className:"space-y-4",children:[Q?t.jsx(ie,{color:"danger",variant:"faded",title:e.clientRequests.errorTitle,description:Q}):null,X?t.jsx(ie,{color:"success",variant:"faded",title:e.clientRequests.successTitle,description:X,onClose:()=>F(null)}):null,P?t.jsx($,{shadow:"none",className:"border border-default-200 bg-white",children:t.jsx(O,{className:"flex min-h-[240px] items-center justify-center",children:t.jsx(_e,{label:e.clientRequests.loading,size:"sm"})})}):H.length===0?t.jsx($,{shadow:"none",className:"border border-default-200 bg-white",children:t.jsx(O,{className:"min-h-[200px]",children:t.jsx("div",{className:"flex h-full items-center justify-center text-sm text-default-500",children:e.clientRequests.empty})})}):t.jsx("div",{className:`grid gap-4 ${z.length===4?"xl:grid-cols-4 md:grid-cols-2":"xl:grid-cols-3 md:grid-cols-2"}`,children:z.map(s=>{const n=pe.get(s.key)??[];return t.jsx($,{shadow:"none",className:"border border-default-200 bg-white",children:t.jsxs(O,{className:"p-0",children:[t.jsx("div",{className:"border-b border-default-200 px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.label}),t.jsx(oe,{size:"sm",variant:"flat",children:n.length})]})}),t.jsx(Ce,{className:"max-h-[calc(100vh-290px)] p-3",children:t.jsx("div",{className:"space-y-3",children:n.map(a=>{const m=!!a.appointment,w=a.board==="appointments",C=V&&!m,q=w&&a.status!=="completed"?"appointments":a.status,E=m&&a.appointment?ze(a.appointment.starts_at,a.appointment.timezone,c):"",x=C?a.status==="new"?"confirmed":a.status==="confirmed"||a.status==="in_progress"?"handed_to_courier":a.status==="handed_to_courier"?"delivered":null:a.status==="completed"?null:w?"completed":a.status==="new"?"in_progress":a.status==="in_progress"?b&&m?"appointments":"completed":a.status==="appointments"?"completed":null,J=C&&!["canceled","delivered","completed"].includes(a.status),f=C?a.status==="new"?e.clientRequests.moveToConfirmedButton:a.status==="confirmed"||a.status==="in_progress"?e.clientRequests.moveToCourierButton:a.status==="handed_to_courier"?e.clientRequests.moveToDeliveredButton:e.clientRequests.reopenButton:w&&a.status!=="completed"?e.clientRequests.moveToCompletedButton:a.status==="new"?e.clientRequests.moveToProgressButton:a.status==="in_progress"?b&&m?e.clientRequests.moveToAppointmentsButton:e.clientRequests.moveToCompletedButton:a.status==="appointments"?e.clientRequests.moveToCompletedButton:e.clientRequests.reopenButton;return t.jsx($,{shadow:"none",className:"border border-default-200 bg-default-50",children:t.jsxs(O,{className:"space-y-3 p-3",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:a.client.name}),t.jsxs("p",{className:"truncate text-xs text-default-500",children:[e.clientRequests.serviceLabel,": ",a.service_name]})]}),t.jsx(oe,{size:"sm",variant:"flat",color:q==="completed"||q==="delivered"?"success":q==="canceled"?"danger":q==="appointments"?"warning":q==="in_progress"||q==="confirmed"||q==="handed_to_courier"?"primary":"default",children:Re(q)})]}),t.jsxs("div",{className:"space-y-1 text-xs text-default-600",children:[t.jsxs("p",{className:"flex items-center gap-1.5",children:[t.jsx(v,{icon:"solar:phone-linear",width:14}),t.jsx("span",{children:a.client.phone||e.clientRequests.noPhone})]}),t.jsxs("p",{className:"flex items-center gap-1.5",children:[t.jsx(v,{icon:"solar:map-point-linear",width:14}),t.jsx("span",{className:"truncate",children:a.address||e.clientRequests.noAddress})]}),t.jsxs("p",{className:"flex items-center gap-1.5",children:[t.jsx(v,{icon:"solar:money-bag-linear",width:14}),t.jsxs("span",{children:[e.clientRequests.amountLabel,":"," ",Ie(a.amount,a.currency,c)]})]}),t.jsxs("p",{className:"flex items-center gap-1.5",children:[t.jsx(v,{icon:"solar:chat-round-line-outline",width:14}),t.jsxs("span",{children:[e.clientRequests.chatChannelLabel,":"," ",be(a.source_channel)]})]})]}),m?t.jsx("div",{className:"rounded-large bg-success-50 px-2.5 py-2 text-xs text-success-700",children:t.jsxs("span",{className:"inline-flex items-center gap-1.5 font-medium",children:[t.jsx(v,{icon:"solar:calendar-linear",width:14}),e.clientRequests.appointmentLabel,": ",E]})}):null,a.note.trim()!==""?t.jsxs("p",{className:"line-clamp-3 text-xs text-default-600",children:[e.clientRequests.noteLabel,": ",a.note]}):null,t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(R,{size:"sm",variant:"flat",className:"flex-1",onPress:()=>{a.source_chat_id&&r("/client-chats")},isDisabled:!a.source_chat_id,children:e.clientRequests.openChatButton}),t.jsx(R,{size:"sm",variant:"flat",color:"primary",isIconOnly:!0,onPress:()=>fe(a),children:t.jsx(v,{icon:"solar:pen-linear",width:18})}),t.jsx(R,{size:"sm",variant:"flat",color:"danger",isIconOnly:!0,onPress:()=>I(a),children:t.jsx(v,{icon:"solar:trash-bin-trash-linear",width:18})})]}),["completed","delivered","canceled"].includes(a.status)?t.jsx(R,{size:"sm",color:"warning",variant:"flat",onPress:()=>{qe(a)},children:e.clientRequests.archiveButton}):t.jsxs("div",{className:"space-y-2",children:[x?t.jsx(R,{size:"sm",color:x==="completed"||x==="delivered"?"success":"primary",className:"w-full",onPress:()=>{ee(a,x)},children:f}):null,J?t.jsx(R,{size:"sm",color:"danger",variant:"flat",onPress:()=>{ee(a,"canceled")},children:e.clientRequests.markCanceledButton}):null]})]})},a.id)})})})]})},s.key)})})]}),t.jsx(ne,{isOpen:!!(B&&l),onOpenChange:Z,size:"2xl",children:t.jsxs(ae,{children:[t.jsx(re,{children:e.clientRequests.editModalTitle}),t.jsx(le,{className:"space-y-3",children:l?t.jsxs(t.Fragment,{children:[t.jsx(y,{label:e.clientRequests.editClientNameLabel,value:l.clientName,onValueChange:s=>{p(n=>n&&{...n,clientName:s})},variant:"bordered"}),t.jsx(Se,{label:e.clientRequests.editStatusLabel,selectedKeys:[l.status],onSelectionChange:s=>{const n=String(Array.from(s)[0]??"new");p(a=>a&&{...a,status:n})},variant:"bordered",children:he.map(s=>t.jsx(Te,{children:s.label},s.key))}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[t.jsx(y,{label:e.clientRequests.editPhoneLabel,value:l.phone,onValueChange:s=>{p(n=>n&&{...n,phone:s})},variant:"bordered"}),t.jsx(y,{label:e.clientRequests.editServiceLabel,value:l.serviceName,onValueChange:s=>{p(n=>n&&{...n,serviceName:s})},variant:"bordered"})]}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[t.jsx(y,{label:e.clientRequests.editAddressLabel,value:l.address,onValueChange:s=>{p(n=>n&&{...n,address:s})},variant:"bordered"}),t.jsx(y,{label:e.clientRequests.editAmountLabel,value:l.amount,inputMode:"decimal",onValueChange:s=>{p(n=>n&&{...n,amount:s})},variant:"bordered"})]}),b?t.jsxs("div",{className:"space-y-3 rounded-large border border-default-200 px-3 py-3",children:[t.jsx(De,{isSelected:l.hasAppointment,onValueChange:s=>{p(n=>n&&{...n,hasAppointment:s})},size:"sm",children:e.clientRequests.editBookingSwitch}),l.hasAppointment?t.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[t.jsx(y,{type:"date",label:e.clientRequests.editAppointmentDateLabel,value:l.appointmentDate,onValueChange:s=>{p(n=>n&&{...n,appointmentDate:s})},variant:"bordered"}),t.jsx(y,{type:"time",label:e.clientRequests.editAppointmentTimeLabel,value:l.appointmentTime,onValueChange:s=>{p(n=>n&&{...n,appointmentTime:s})},variant:"bordered"}),t.jsx(y,{type:"number",label:e.clientRequests.editAppointmentDurationLabel,placeholder:e.clientRequests.editAppointmentDurationPlaceholder,value:l.appointmentDurationMinutes,onValueChange:s=>{p(n=>n&&{...n,appointmentDurationMinutes:s})},variant:"bordered",min:15,max:720,step:5,inputMode:"numeric"})]}):null]}):null,t.jsx(ke,{label:e.clientRequests.editNoteLabel,value:l.note,onValueChange:s=>{p(n=>n&&{...n,note:s})},variant:"bordered",minRows:3})]}):null}),t.jsxs(ce,{children:[t.jsx(R,{variant:"light",onPress:Z,children:e.clientRequests.editModalCancel}),t.jsx(R,{color:"primary",isLoading:_,onPress:()=>{ge()},children:e.clientRequests.editModalSave})]})]})}),t.jsx(ne,{isOpen:!!D,onOpenChange:()=>I(null),children:t.jsxs(ae,{children:[t.jsx(re,{children:e.clientRequests.deleteButton}),t.jsx(le,{children:t.jsx("p",{className:"text-sm text-default-600",children:D?.client.name})}),t.jsxs(ce,{children:[t.jsx(R,{variant:"light",onPress:()=>I(null),children:e.clientRequests.editModalCancel}),t.jsx(R,{color:"danger",isLoading:T,onPress:()=>{xe()},children:e.clientRequests.deleteButton})]})]})})]})}export{st as default};
