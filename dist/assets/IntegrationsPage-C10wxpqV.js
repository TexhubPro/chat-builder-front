import{t as Ee,A as x,l as Ie,n as Me,g as Re,k as qe,r as i,q as _,j as t,s as X}from"./index-C9lwm0RO.js";import{D as Be,c as Y,b as Z,h as Ke,I as R,m as he,d as fe,e as pe}from"./DashboardLayout-CNFrOcaq.js";import{b as Ue,c as Ve,d as j}from"./usePageSeo-DNlU2sGC.js";import{c as D}from"./chunk-EIRINNCE-Bp8myULm.js";import{s as Ge}from"./chunk-I3A4XRYQ-CtJ6RnJV.js";import{d as Je}from"./index-BaAps9FY.js";import{m as xe}from"./chunk-R7OT77UN-C7bIi7hh.js";import{i as $}from"./chunk-SQIAVXJX-C1YuGKlr.js";import{t as be}from"./chunk-WEIB4WXA-48vgmJBZ.js";import{m as je}from"./chunk-5LXTSPS7-CXnTtwrI.js";import"./useLabel-B407BxOM.js";import"./useToggleState-u3Gl4b88.js";import"./chunk-KQW2TNLT-W8XIpxPA.js";import"./chunk-ICU6NNET-KIKolltN.js";async function He(g){return(g.headers.get("content-type")??"").includes("application/json")?g.json():null}async function S(g,d,m={}){const e=new Headers(m.headers??{});e.has("Accept")||e.set("Accept","application/json"),typeof m.body<"u"&&m.body!==null&&!e.has("Content-Type")&&e.set("Content-Type","application/json"),e.set("Authorization",`Bearer ${d}`);const w=await fetch(`${Ee}${g}`,{...m,headers:e}),h=await He(w);if(!w.ok){const q=typeof h=="object"&&h!==null&&"message"in h&&typeof h.message=="string"?h.message:"Request failed.";throw new x(q,w.status,h)}return h}async function ye(g,d){const m=typeof d=="number"?`?assistant_id=${d}`:"";return S(`/assistant-channels${m}`,g,{method:"GET"})}async function Qe(g,d,m,e){return S(`/assistant-channels/${d}/${m}`,g,{method:"PATCH",body:JSON.stringify({enabled:e})})}async function Xe(g,d,m){return S(`/assistant-channels/${d}/${m}`,g,{method:"DELETE"})}async function Ye(g,d){return S(`/assistant-channels/${d}/instagram/connect`,g,{method:"POST"})}async function Ze(g,d,m){return S(`/assistant-channels/${d}/telegram/connect`,g,{method:"POST",body:JSON.stringify({bot_token:m})})}async function et(g,d){return S(`/assistant-channels/${d}/widget/settings`,g,{method:"GET"})}async function tt(g,d,m){return S(`/assistant-channels/${d}/widget/settings`,g,{method:"PUT",body:JSON.stringify(m)})}const we={position:"bottom-right",theme:"light",primary_color:"#1677FF",title:"Website Chat",welcome_message:"Hello! Ask your question.",placeholder:"Type a message...",launcher_label:"Chat"};function st(g){const d=(g??"").trim();if(d==="")return"?";const m=d.split(/\s+/u).filter(Boolean),e=m[0]?.[0]??"",w=m[1]?.[0]??"",h=`${e}${w}`.trim().toUpperCase();return h===""?d.slice(0,1).toUpperCase():h}function xt(){const{user:g,logout:d}=Ie(),{locale:m,messages:e}=Me(),w=Re(),[h]=qe(),[q,ee]=i.useState(!1),[B,te]=i.useState(!0),[ve,se]=i.useState(!1),[ne,K]=i.useState(!1),[P,ae]=i.useState([]),[o,N]=i.useState(null),[C,p]=i.useState([]),[F,T]=i.useState(null),[_e,v]=i.useState({}),[Se,U]=i.useState(!1),[V,O]=i.useState(""),[W,ie]=i.useState(!1),[Ne,G]=i.useState(!1),[le,re]=i.useState(!1),[E,oe]=i.useState(!1),[y,b]=i.useState(we),[k,J]=i.useState(""),[Ce,L]=i.useState(!1),[ce,l]=i.useState(null),z=i.useMemo(()=>{const s=h.get("assistant_id");if(!s)return null;const n=Number.parseInt(s,10);return!Number.isFinite(n)||n<=0?null:n},[h]),H=h.get("instagram_status"),A=h.get("instagram_error");Ue({title:`${e.integrations.title} | ${e.app.name}`,description:e.integrations.subtitle,locale:m});const Q=i.useMemo(()=>o!==null?P.find(s=>s.id===o)??null:null,[P,o]),Te=i.useMemo(()=>({instagram:{title:e.integrations.channelInstagram,description:e.integrations.channelInstagramDescription,icon:"fa6-brands:instagram",iconClass:"bg-pink-100 text-pink-600"},telegram:{title:e.integrations.channelTelegram,description:e.integrations.channelTelegramDescription,icon:"solar:plain-2-linear",iconClass:"bg-blue-100 text-blue-600"},widget:{title:e.integrations.channelWidget,description:e.integrations.channelWidgetDescription,icon:"solar:widget-2-outline",iconClass:"bg-violet-100 text-violet-600"},api:{title:e.integrations.channelApi,description:e.integrations.channelApiDescription,icon:"solar:code-square-linear",iconClass:"bg-emerald-100 text-emerald-600"}}),[e.integrations.channelApi,e.integrations.channelApiDescription,e.integrations.channelInstagram,e.integrations.channelInstagramDescription,e.integrations.channelTelegram,e.integrations.channelTelegramDescription,e.integrations.channelWidget,e.integrations.channelWidgetDescription]),ke=async()=>{ee(!0);try{await d()}finally{ee(!1)}},de=i.useCallback(async()=>{const s=_();if(!s){l(e.integrations.unauthorized);return}te(!0);try{const n=await ye(s);ae(n.assistants),T(n.limits),p([]),N(null)}catch(n){n instanceof x&&n.status===401?l(e.integrations.unauthorized):l(n instanceof x?n.message:e.integrations.loadFailed)}finally{te(!1)}},[e.integrations.loadFailed,e.integrations.unauthorized]),I=i.useCallback(async s=>{const n=_();if(!n){l(e.integrations.unauthorized);return}se(!0);try{const a=await ye(n,s);ae(a.assistants),T(a.limits),p(a.channels),N(a.selected_assistant_id??s)}catch(a){a instanceof x&&a.status===401?l(e.integrations.unauthorized):l(a instanceof x?a.message:e.integrations.loadFailed)}finally{se(!1)}},[e.integrations.loadFailed,e.integrations.unauthorized]);i.useEffect(()=>{de()},[de]),i.useEffect(()=>{B||!(H!==null||A!==null||z!==null)||(A&&A.trim()!==""?l(A):l(null),H==="connected"&&z!==null&&(N(z),K(!0),I(z)),w("/integrations",{replace:!0}))},[z,A,H,B,I,w]);const Le=i.useCallback(s=>{l(null),N(s),K(!0),I(s)},[I]),ze=i.useCallback(()=>{N(null),p([]),K(!1),l(null)},[]),ue=i.useCallback(async(s,n)=>{if(!o)return;const a=_();if(!a){l(e.integrations.unauthorized);return}const c=`${o}:${s}`,u=C;v(r=>({...r,[c]:!0})),l(null),p(r=>r.map(f=>f.channel===s?{...f,is_connected:n?!0:f.is_connected,is_active:n}:f));try{const r=await Qe(a,o,s,n);p(f=>f.map(M=>M.channel===s?r.channel:M)),T(r.limits),s==="widget"&&(G(!1),b(we),J(""),L(!1))}catch(r){p(u),l(r instanceof x?r.message:e.integrations.updateFailed)}finally{v(r=>{const f={...r};return delete f[c],f})}},[C,e.integrations.unauthorized,e.integrations.updateFailed,o]),Ae=i.useCallback(async s=>{if(!o)return;const n=_();if(!n){l(e.integrations.unauthorized);return}const a=`${o}:${s}`,c=C;v(u=>({...u,[a]:!0})),l(null),p(u=>u.map(r=>r.channel===s?{...r,id:null,assistant_id:null,name:null,external_account_id:null,is_connected:!1,is_active:!1,settings:{},metadata:{},updated_at:null}:r));try{const u=await Xe(n,o,s);p(r=>r.map(f=>f.channel===s?u.channel:f)),T(u.limits)}catch(u){p(c),l(u instanceof x?u.message:e.integrations.updateFailed)}finally{v(u=>{const r={...u};return delete r[a],r})}},[C,e.integrations.unauthorized,e.integrations.updateFailed,o]),De=i.useCallback(async()=>{if(!o)return;const s=_();if(!s){l(e.integrations.unauthorized);return}const n=`${o}:instagram`;v(a=>({...a,[n]:!0})),l(null);try{const a=await Ye(s,o);if(!a.authorization_url)throw new Error(e.integrations.updateFailed);window.location.assign(a.authorization_url)}catch(a){l(a instanceof x||a instanceof Error?a.message:e.integrations.updateFailed),v(c=>{const u={...c};return delete u[n],u})}},[e.integrations.unauthorized,e.integrations.updateFailed,o]),$e=i.useCallback(()=>{O(""),U(!0)},[]),ge=i.useCallback(()=>{W||(U(!1),O(""))},[W]),Pe=i.useCallback(async()=>{if(!o)return;const s=V.trim();if(s===""){l(e.integrations.telegramTokenRequired);return}const n=_();if(!n){l(e.integrations.unauthorized);return}const a=`${o}:telegram`;v(c=>({...c,[a]:!0})),ie(!0),l(null);try{const c=await Ze(n,o,s);p(u=>u.map(r=>r.channel==="telegram"?c.channel:r)),T(c.limits),U(!1),O("")}catch(c){l(c instanceof x?c.message:e.integrations.updateFailed)}finally{ie(!1),v(c=>{const u={...c};return delete u[a],u})}},[e.integrations.telegramTokenRequired,e.integrations.unauthorized,e.integrations.updateFailed,o,V]),Fe=i.useCallback(async()=>{if(!o)return;const s=_();if(!s){l(e.integrations.unauthorized);return}re(!0),L(!1),l(null);try{const n=await et(s,o);b(n.widget.settings),J(n.widget.embed_script_tag??""),G(!0)}catch(n){l(n instanceof x?n.message:e.integrations.widgetSettingsLoadFailed)}finally{re(!1)}},[e.integrations.unauthorized,e.integrations.widgetSettingsLoadFailed,o]),me=i.useCallback(()=>{E||(G(!1),L(!1))},[E]),Oe=i.useCallback(async()=>{if(!o)return;const s=_();if(!s){l(e.integrations.unauthorized);return}oe(!0),l(null);try{const n=await tt(s,o,y);b(n.widget.settings),J(n.widget.embed_script_tag??""),p(a=>a.map(c=>c.channel==="widget"?n.channel:c))}catch(n){l(n instanceof x?n.message:e.integrations.widgetSettingsSaveFailed)}finally{oe(!1)}},[e.integrations.unauthorized,e.integrations.widgetSettingsSaveFailed,o,y]),We=i.useCallback(async()=>{if(k.trim()!=="")try{await navigator.clipboard.writeText(k.trim()),L(!0),window.setTimeout(()=>{L(!1)},1800)}catch{l(e.integrations.updateFailed)}},[e.integrations.updateFailed,k]);return t.jsxs(Be,{title:e.integrations.title,user:g,onLogout:ke,isLoggingOut:q,defaultSelectedKey:"integrations",children:[t.jsxs("div",{className:"space-y-4",children:[ce?t.jsx(Ve,{color:"danger",variant:"faded",title:e.integrations.errorTitle,description:ce}):null,t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[340px_minmax(0,1fr)]",children:[t.jsx(Y,{shadow:"none",className:`border border-default-200 bg-white ${ne?"hidden lg:flex":"flex"}`,children:t.jsxs(Z,{className:"space-y-4 p-4 sm:p-5",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.assistantsTitle}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.assistantsSubtitle})]}),B?t.jsx("div",{className:"flex items-center justify-center py-10",children:t.jsx(X,{size:"sm",label:e.integrations.loadingAssistants})}):P.length===0?t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.noAssistants}):t.jsx("div",{className:"space-y-2",children:P.map(s=>{const n=s.id===o;return t.jsx("button",{type:"button",onClick:()=>{Le(s.id)},className:`w-full rounded-large border px-3 py-3 text-left transition ${n?"border-primary-300 bg-primary-50":"border-default-200 bg-white hover:border-default-300 hover:bg-default-50"}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(Ke,{name:s.name,showFallback:!0,fallback:t.jsx("span",{className:"text-xs font-semibold text-default-700",children:st(s.name)}),className:"h-10 w-10 shrink-0"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),t.jsx(D,{size:"sm",variant:"flat",color:s.is_active?"success":"default",className:"mt-1",children:s.is_active?e.integrations.assistantRunning:e.integrations.assistantStopped})]})]})},s.id)})})]})}),t.jsx(Y,{shadow:"none",className:`border border-default-200 bg-white ${ne?"flex":"hidden lg:flex"}`,children:t.jsx(Z,{className:"p-0",children:Q?t.jsxs("div",{className:"flex h-full flex-col",children:[t.jsxs("div",{className:"space-y-3 border-b border-default-200 px-4 py-4 sm:px-5",children:[t.jsx("div",{className:"flex items-center justify-between gap-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(j,{isIconOnly:!0,size:"sm",variant:"light",onPress:ze,"aria-label":e.integrations.backToAssistants,children:t.jsx(R,{icon:"solar:alt-arrow-left-linear",width:18})}),t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.channelsTitle})]})}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.channelsSubtitle}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx(D,{size:"sm",variant:"flat",color:"primary",children:Q.name}),t.jsxs(D,{size:"sm",variant:"flat",color:"default",children:[e.integrations.activeIntegrationsLabel,":"," ",F?.active_integrations??0]}),t.jsxs(D,{size:"sm",variant:"flat",color:"default",children:[e.integrations.integrationLimitLabel,":"," ",F?.integrations_per_channel_limit??0]})]})]}),ve?t.jsx("div",{className:"flex flex-1 items-center justify-center py-14",children:t.jsx(X,{size:"sm",label:e.integrations.loadingChannels})}):t.jsx("div",{className:"grid gap-3 p-4 sm:grid-cols-2 sm:p-5",children:C.map(s=>{const n=s.channel,a=n==="api",c=Te[n],u=`${Q.id}:${s.channel}`,r=!!_e[u],f=s.external_account_id??s.name??null;return t.jsx(Y,{shadow:"none",className:"border border-default-200 bg-default-50",children:t.jsxs(Z,{className:"space-y-3 p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:`flex h-11 w-11 shrink-0 items-center justify-center rounded-full ${c?.iconClass??"bg-default-200 text-default-700"}`,children:t.jsx(R,{icon:c?.icon??"solar:link-linear",width:22})}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:c?.title??s.channel}),t.jsx("p",{className:"text-sm text-default-500",children:c?.description??""})]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[n==="widget"&&s.is_connected?t.jsx(j,{isIconOnly:!0,size:"sm",variant:"light","aria-label":e.integrations.widgetSettingsButton,onPress:()=>{Fe()},isDisabled:r||le,children:t.jsx(R,{icon:"solar:settings-linear",width:18})}):null,t.jsx(Ge,{size:"sm",isSelected:s.is_connected&&s.is_active,isDisabled:r||a||!F?.has_active_subscription||!s.is_connected,onValueChange:M=>{ue(n,M)},"aria-label":e.integrations.toggleLabel})]})]}),t.jsx(Je,{}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(D,{size:"sm",variant:"flat",color:a?"warning":s.is_active?"success":"default",children:a?e.integrations.comingSoon:s.is_active?e.integrations.statusEnabled:e.integrations.statusDisabled}),t.jsxs("p",{className:"text-xs text-default-500",children:[e.integrations.accountLabel,":"," ",t.jsx("span",{className:"text-default-700",children:f??e.integrations.noConnection})]})]}),a?t.jsx(j,{color:"default",variant:"flat",className:"w-full",isDisabled:!0,children:e.integrations.comingSoon}):s.is_connected?t.jsx(j,{color:"danger",variant:"solid",className:"w-full",onPress:()=>{Ae(n)},isLoading:r,children:e.integrations.disconnectButton}):t.jsx(j,{color:"primary",variant:"solid",className:"w-full",onPress:()=>{if(n==="instagram"){De();return}if(n==="telegram"){$e();return}ue(n,!0)},isLoading:r,isDisabled:!F?.has_active_subscription,children:e.integrations.connectButton})]})},s.channel)})})]}):t.jsx("div",{className:"flex h-[calc(100vh-220px)] items-center justify-center px-6",children:t.jsxs("div",{className:"max-w-md space-y-2 text-center",children:[t.jsx(R,{icon:"solar:link-circle-linear",width:36,className:"mx-auto text-default-400"}),t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.selectAssistantTitle}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.selectAssistantDescription})]})})})})]})]}),t.jsx(he,{isOpen:Ne,size:"2xl",onOpenChange:s=>{s||me()},children:t.jsxs(fe,{children:[t.jsx(xe,{children:e.integrations.widgetSettingsModalTitle}),t.jsx(pe,{children:le?t.jsx("div",{className:"flex items-center justify-center py-10",children:t.jsx(X,{size:"sm"})}):t.jsxs("div",{className:"space-y-4",children:[t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.widgetSettingsModalDescription}),t.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[t.jsxs("label",{className:"space-y-1 text-sm",children:[t.jsx("span",{className:"text-default-600",children:e.integrations.widgetPositionLabel}),t.jsxs("select",{className:"w-full rounded-medium border border-default-300 bg-white px-3 py-2 text-sm",value:y.position,onChange:s=>{const n=s.target.value;b(a=>({...a,position:n}))},children:[t.jsx("option",{value:"bottom-right",children:e.integrations.widgetPositionRight}),t.jsx("option",{value:"bottom-left",children:e.integrations.widgetPositionLeft})]})]}),t.jsxs("label",{className:"space-y-1 text-sm",children:[t.jsx("span",{className:"text-default-600",children:e.integrations.widgetThemeLabel}),t.jsxs("select",{className:"w-full rounded-medium border border-default-300 bg-white px-3 py-2 text-sm",value:y.theme,onChange:s=>{const n=s.target.value;b(a=>({...a,theme:n}))},children:[t.jsx("option",{value:"light",children:e.integrations.widgetThemeLight}),t.jsx("option",{value:"dark",children:e.integrations.widgetThemeDark})]})]})]}),t.jsx($,{label:e.integrations.widgetPrimaryColorLabel,value:y.primary_color,onValueChange:s=>{b(n=>({...n,primary_color:s.toUpperCase()}))}}),t.jsx($,{label:e.integrations.widgetTitleLabel,value:y.title,onValueChange:s=>{b(n=>({...n,title:s}))}}),t.jsx(be,{label:e.integrations.widgetWelcomeLabel,value:y.welcome_message,onValueChange:s=>{b(n=>({...n,welcome_message:s}))},minRows:3}),t.jsx($,{label:e.integrations.widgetPlaceholderLabel,value:y.placeholder,onValueChange:s=>{b(n=>({...n,placeholder:s}))}}),t.jsx($,{label:e.integrations.widgetLauncherLabel,value:y.launcher_label,onValueChange:s=>{b(n=>({...n,launcher_label:s}))}}),t.jsx(be,{label:e.integrations.widgetScriptLabel,value:k,readOnly:!0,minRows:3})]})}),t.jsx(je,{children:t.jsxs("div",{className:"flex w-full flex-wrap items-center justify-between gap-2",children:[t.jsx("div",{className:"text-xs text-success-600",children:Ce?e.integrations.widgetScriptCopied:""}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(j,{variant:"flat",onPress:()=>{We()},isDisabled:k.trim()==="",children:e.integrations.widgetCopyScript}),t.jsx(j,{variant:"light",onPress:me,isDisabled:E,children:e.common.cancel}),t.jsx(j,{color:"primary",onPress:()=>{Oe()},isLoading:E,children:e.integrations.widgetSaveSettings})]})]})})]})}),t.jsx(he,{isOpen:Se,onOpenChange:s=>{s||ge()},children:t.jsxs(fe,{children:[t.jsx(xe,{children:e.integrations.telegramTokenModalTitle}),t.jsxs(pe,{className:"space-y-3",children:[t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.telegramTokenModalDescription}),t.jsx($,{autoFocus:!0,type:"password",label:e.integrations.telegramTokenLabel,placeholder:e.integrations.telegramTokenPlaceholder,value:V,onValueChange:O,autoComplete:"off"})]}),t.jsxs(je,{children:[t.jsx(j,{variant:"light",onPress:ge,isDisabled:W,children:e.common.cancel}),t.jsx(j,{color:"primary",onPress:()=>{Pe()},isLoading:W,children:e.integrations.connectButton})]})]})})]})}export{xt as default};
