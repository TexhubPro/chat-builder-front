import{t as W,A as _,l as X,n as Y,r as i,q as $,j as e,s as I}from"./index-DFt9vaGi.js";import{D as Z,c as m,b as p,I as B,h as E,m as ee,d as se,e as te,s as b}from"./DashboardLayout-Ds61Xg-w.js";import{b as ae,c as ne,d as le}from"./usePageSeo-zMtdeAIZ.js";import{i as re}from"./chunk-SQIAVXJX-DXL5IOXk.js";import{t as F,a as h}from"./chunk-ML27DD5T-CuQq5MOr.js";import{c as O}from"./chunk-EIRINNCE-CH2GcUft.js";import{m as ie}from"./chunk-R7OT77UN-LecFBPqy.js";import"./index-DaMPhJ29.js";import"./useLabel-C9azh59v.js";import"./chunk-KQW2TNLT-jIFc4Zc4.js";import"./chunk-ICU6NNET-Cscege8D.js";import"./useListState-DtQoTo5n.js";async function ce(l){return(l.headers.get("content-type")??"").includes("application/json")?l.json():null}async function R(l,a,r={}){const s=new Headers(r.headers??{});s.has("Accept")||s.set("Accept","application/json"),typeof r.body<"u"&&r.body!==null&&!s.has("Content-Type")&&s.set("Content-Type","application/json"),s.set("Authorization",`Bearer ${a}`);const d=await fetch(`${W}${l}`,{...r,headers:s}),c=await ce(d);if(!d.ok){const g=typeof c=="object"&&c!==null&&"message"in c&&typeof c.message=="string"?c.message:"Request failed.";throw new _(g,d.status,c)}return c}function oe(l){const a=new URLSearchParams;Object.entries(l).forEach(([s,d])=>{typeof d>"u"||a.set(s,String(d))});const r=a.toString();return r===""?"":`?${r}`}async function de(l,a={}){return R(`/client-base${oe({search:a.search,status:a.status&&a.status!=="all"?a.status:void 0,limit:a.limit})}`,l,{method:"GET"})}async function ue(l,a){return R(`/client-base/${a}`,l,{method:"GET"})}function D(l){const a=l.trim();if(a==="")return"?";const r=a.split(/\s+/u).filter(Boolean),s=r[0]?.[0]??"",d=r[1]?.[0]??"",c=`${s}${d}`.trim().toUpperCase();return c===""?a.slice(0,1).toUpperCase():c}function v(l,a){if(!l)return"-";const r=new Date(l);return Number.isNaN(r.getTime())?"-":new Intl.DateTimeFormat(a==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}).format(r)}function H(l,a,r){return new Intl.NumberFormat(r==="ru"?"ru-RU":"en-US",{minimumFractionDigits:0,maximumFractionDigits:2}).format(l)+` ${a}`}function me(l){switch(l){case"order":return"solar:cart-3-linear";case"appointment":return"solar:calendar-linear";case"task":return"solar:checklist-minimalistic-linear";case"question":return"solar:question-circle-linear";default:return"solar:history-linear"}}function ke(){const{user:l,logout:a}=X(),{locale:r,messages:s}=Y(),[d,c]=i.useState(!1),[g,N]=i.useState(!0),[U,k]=i.useState(!1),[y,P]=i.useState(""),[w,G]=i.useState("all"),[T,j]=i.useState(null),[S,Q]=i.useState([]),[J,L]=i.useState(!1),[o,A]=i.useState(null),[u,C]=i.useState({orders:[],appointments:[],tasks:[],questions:[],timeline:[]});ae({title:`${s.clientBase.title} | ${s.app.name}`,description:s.clientBase.subtitle,locale:r});const K=async()=>{c(!0);try{await a()}finally{c(!1)}},q=i.useCallback(async()=>{const t=$();if(!t){j(s.clientBase.unauthorized),N(!1);return}N(!0),j(null);try{const f=await de(t,{search:y.trim()===""?void 0:y.trim(),status:w,limit:120});Q(pe(f.clients))}catch(f){j(f instanceof _?f.message:s.clientBase.loadFailed)}finally{N(!1)}},[s.clientBase.loadFailed,s.clientBase.unauthorized,y,w]);i.useEffect(()=>{const t=window.setTimeout(()=>{q()},220);return()=>{window.clearTimeout(t)}},[q]);const M=i.useCallback(async t=>{const f=$();if(!f){j(s.clientBase.unauthorized);return}L(!0),k(!0),j(null);try{const x=await ue(f,t);A(x.client),C({orders:x.history.orders.map(n=>({id:n.id,service_name:n.service_name,status:n.status,total_price:n.total_price,currency:n.currency,ordered_at:n.ordered_at,notes:n.notes})),appointments:x.history.appointments.map(n=>({id:n.id,title:n.title,status:n.status,starts_at:n.starts_at,timezone:n.timezone})),tasks:x.history.tasks.map(n=>({id:n.id,description:n.description,status:n.status,priority:n.priority,created_at:n.created_at})),questions:x.history.questions.map(n=>({id:n.id,description:n.description,status:n.status,created_at:n.created_at})),timeline:x.history.timeline})}catch(x){j(x instanceof _?x.message:s.clientBase.detailsFailed)}finally{k(!1)}},[s.clientBase.detailsFailed,s.clientBase.unauthorized]),z=i.useCallback(t=>{switch(t){case"archived":return s.clientBase.statusArchived;case"blocked":return s.clientBase.statusBlocked;default:return s.clientBase.statusActive}},[s.clientBase.statusActive,s.clientBase.statusArchived,s.clientBase.statusBlocked]),V=i.useCallback(t=>{switch(t){case"order":return s.clientBase.historyTypeOrder;case"appointment":return s.clientBase.historyTypeAppointment;case"task":return s.clientBase.historyTypeTask;case"question":return s.clientBase.historyTypeQuestion;default:return t}},[s.clientBase.historyTypeAppointment,s.clientBase.historyTypeOrder,s.clientBase.historyTypeQuestion,s.clientBase.historyTypeTask]);return e.jsxs(Z,{title:s.clientBase.title,user:l,onLogout:K,isLoggingOut:d,defaultSelectedKey:"client-base",children:[e.jsxs("div",{className:"space-y-4",children:[T?e.jsx(ne,{color:"danger",variant:"faded",title:s.clientBase.errorTitle,description:T}):null,e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(p,{className:"gap-3 sm:flex-row sm:items-center",children:[e.jsx(re,{value:y,onValueChange:P,placeholder:s.clientBase.searchPlaceholder,startContent:e.jsx(B,{icon:"solar:magnifer-linear",width:16})}),e.jsx("div",{className:"max-w-full  rounded-full bg-default-100 p-1",children:e.jsxs(F,{selectedKey:w,onSelectionChange:t=>{G(String(t))},size:"sm",radius:"sm",variant:"light",classNames:{base:"min-w-max",tabList:"bg-transparent p-0 flex-nowrap min-w-max gap-1",tab:" px-4 rounded-full border-none data-[selected=true]:bg-white data-[selected=true]:border-default-300 data-[selected=true]:shadow-none",tabContent:"text-default-600 group-data-[selected=true]:text-foreground",cursor:"hidden"},children:[e.jsx(h,{title:e.jsx("span",{className:"whitespace-nowrap",children:s.clientBase.statusAll})},"all"),e.jsx(h,{title:e.jsx("span",{className:"whitespace-nowrap",children:s.clientBase.statusActive})},"active"),e.jsx(h,{title:e.jsx("span",{className:"whitespace-nowrap",children:s.clientBase.statusArchived})},"archived")]})})]})}),g?e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsx(p,{className:"flex min-h-[240px] items-center justify-center",children:e.jsx(I,{label:s.clientBase.loading,size:"sm"})})}):S.length===0?e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsx(p,{className:"flex min-h-[220px] items-center justify-center text-sm text-default-500",children:s.clientBase.empty})}):e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 xl:grid-cols-3",children:S.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(p,{className:"space-y-2.5 p-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(E,{src:t.avatar??void 0,name:t.name,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:D(t.name)}),className:"h-10 w-10 shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-base font-semibold text-foreground",children:t.name}),e.jsx("p",{className:"truncate text-sm text-default-500",children:t.phone})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(O,{size:"sm",variant:"flat",color:t.status==="blocked"?"danger":t.status==="archived"?"default":"success",children:z(t.status)}),e.jsx(le,{isIconOnly:!0,size:"sm",variant:"light",radius:"full","aria-label":s.clientBase.viewHistoryButton,onPress:()=>{M(t.id)},children:e.jsx(B,{icon:"solar:history-linear",width:18})})]})]}),e.jsxs("div",{className:"rounded-large bg-default-100 px-3 py-2 text-sm",children:[e.jsx("p",{className:"text-default-500",children:s.clientBase.totalSpent}),e.jsx("p",{className:"font-semibold text-foreground",children:H(t.stats.total_spent,t.stats.currency,r)})]})]})},t.id))})]}),e.jsx(ee,{isOpen:J,onOpenChange:t=>{t||(L(!1),A(null),C({orders:[],appointments:[],tasks:[],questions:[],timeline:[]}))},size:"lg",scrollBehavior:"inside",children:e.jsxs(se,{children:[e.jsx(ie,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold",children:s.clientBase.modalTitle}),e.jsx("p",{className:"text-sm font-normal text-default-500",children:s.clientBase.modalSubtitle})]})}),e.jsx(te,{className:"pb-5",children:U?e.jsx("div",{className:"flex min-h-[220px] items-center justify-center",children:e.jsx(I,{label:s.clientBase.modalLoading,size:"sm"})}):o?e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{shadow:"none",className:"border border-default-200 bg-default-50",children:e.jsxs(p,{className:"gap-3 sm:flex-row sm:items-center",children:[e.jsx(E,{src:o.avatar??void 0,name:o.name,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:D(o.name)}),className:"h-12 w-12"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-base font-semibold",children:o.name}),e.jsxs("p",{className:"truncate text-sm text-default-600",children:[s.clientBase.phoneLabel,": ",o.phone]}),o.email?e.jsxs("p",{className:"truncate text-sm text-default-600",children:[s.clientBase.emailLabel,":"," ",o.email]}):null,o.notes?e.jsxs("p",{className:"line-clamp-2 text-sm text-default-500",children:[s.clientBase.notesLabel,":"," ",o.notes]}):null]}),e.jsxs(O,{size:"sm",variant:"flat",color:o.status==="blocked"?"danger":o.status==="archived"?"default":"success",children:[s.clientBase.statusLabel,":"," ",z(o.status)]})]})}),e.jsxs(F,{size:"sm",radius:"sm",variant:"light",classNames:{base:"w-full",tabList:"w-full max-w-full overflow-x-auto rounded-full bg-default-100 p-1 flex-nowrap min-w-max gap-1",tab:"px-4 rounded-full border-none data-[selected=true]:bg-white data-[selected=true]:border-default-300 data-[selected=true]:shadow-none",tabContent:"whitespace-nowrap text-default-600 group-data-[selected=true]:text-foreground",cursor:"hidden"},children:[e.jsx(h,{title:s.clientBase.timelineTab,children:u.timeline.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noTimeline}):e.jsx(b,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.timeline.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsx(p,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"flex items-center gap-1.5 text-xs text-default-500",children:[e.jsx(B,{icon:me(t.type),width:14}),V(t.type)]}),e.jsx("p",{className:"line-clamp-2 text-sm font-medium text-foreground",children:t.title}),t.description?e.jsx("p",{className:"line-clamp-2 text-xs text-default-500",children:t.description}):null]}),e.jsx("span",{className:"shrink-0 text-xs text-default-500",children:v(t.happened_at,r)})]})})},`${t.type}-${t.id}`))})})},"timeline"),e.jsx(h,{title:s.clientBase.ordersTab,children:u.orders.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noOrders}):e.jsx(b,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.orders.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(p,{className:"space-y-1 p-3",children:[e.jsxs("p",{className:"text-sm font-semibold text-foreground",children:[s.clientBase.orderServiceLabel,":"," ",t.service_name]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.orderAmountLabel,":"," ",H(t.total_price,t.currency,r)]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.orderStatusLabel,":"," ",t.status]}),e.jsx("p",{className:"text-xs text-default-500",children:v(t.ordered_at,r)})]})},t.id))})})},"orders"),e.jsx(h,{title:s.clientBase.appointmentsTab,children:u.appointments.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noAppointments}):e.jsx(b,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.appointments.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(p,{className:"space-y-1 p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t.title}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.appointmentDateLabel,":"," ",v(t.starts_at,r)]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.appointmentStatusLabel,":"," ",t.status]})]})},t.id))})})},"appointments"),e.jsx(h,{title:s.clientBase.tasksTab,children:u.tasks.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noTasks}):e.jsx(b,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.tasks.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(p,{className:"space-y-1 p-3",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.description}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.taskStatusLabel,":"," ",t.status]}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.taskPriorityLabel,":"," ",t.priority]})]})},t.id))})})},"tasks"),e.jsx(h,{title:s.clientBase.questionsTab,children:u.questions.length===0?e.jsx("p",{className:"py-5 text-sm text-default-500",children:s.clientBase.noQuestions}):e.jsx(b,{className:"max-h-[420px]",children:e.jsx("div",{className:"space-y-2 py-1 pr-2",children:u.questions.map(t=>e.jsx(m,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs(p,{className:"space-y-1 p-3",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.description}),e.jsxs("p",{className:"text-xs text-default-600",children:[s.clientBase.questionStatusLabel,":"," ",t.status]})]})},t.id))})})},"questions")]})]}):null})]})})]})}function pe(l){return l.map(a=>({...a,stats:{...a.stats,currency:a.stats.currency.trim()===""?"TJS":a.stats.currency}}))}export{ke as default};
