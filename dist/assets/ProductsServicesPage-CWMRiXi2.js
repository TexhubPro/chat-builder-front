import{t as Le,A as _,l as Ae,n as Te,r as d,q as C,j as e,s as ne}from"./index-BYGw2tT-.js";import{a as re,D as Re,c as T,b as R,h as Oe,I as N,m as ce,d as oe,e as de}from"./DashboardLayout-B0b3pDXt.js";import{a as ze}from"./assistantClient-JX62sbaf.js";import{b as $e,c as ue,d as x}from"./usePageSeo-Dj1hqvkY.js";import{c as O}from"./chunk-EIRINNCE-D4yIvY_2.js";import{t as Ee,a as me}from"./chunk-ML27DD5T-CVUDbhZ1.js";import{m as pe}from"./chunk-R7OT77UN-Dr5yURyW.js";import{i as S}from"./chunk-SQIAVXJX-D9K2ccMJ.js";import{s as ge,l as he}from"./chunk-C3QHEOC2-FCziqiyC.js";import{t as U}from"./chunk-WEIB4WXA-BBNIo4CF.js";import{s as Q}from"./chunk-I3A4XRYQ-DmwhnnvZ.js";import{m as fe}from"./chunk-5LXTSPS7-BWiIBxNe.js";import"./index-B3eHIZ_o.js";import"./useLabel-ceVddHEZ.js";import"./useListState-CsLScgQT.js";import"./chunk-KQW2TNLT-m0JpNhqz.js";import"./chunk-ICU6NNET-idXH-e9r.js";import"./index-R-lPbHIY.js";import"./useToggleState-CAXDbW80.js";async function Fe(i){return(i.headers.get("content-type")??"").includes("application/json")?i.json():null}async function w(i,n,m={}){const t=new Headers(m.headers??{});t.has("Accept")||t.set("Accept","application/json"),typeof m.body<"u"&&m.body!==null&&!t.has("Content-Type")&&t.set("Content-Type","application/json"),t.set("Authorization",`Bearer ${n}`);const v=await fetch(`${Le}${i}`,{...m,headers:t}),p=await Fe(v);if(!v.ok){const z=typeof p=="object"&&p!==null&&"message"in p&&typeof p.message=="string"?p.message:"Request failed.";throw new _(z,v.status,p)}return p}async function Ie(i,n){return w(`/assistant-services?assistant_id=${n}`,i,{method:"GET"})}async function qe(i,n){return w(`/assistant-products?assistant_id=${n}`,i,{method:"GET"})}async function Ve(i,n){return w("/assistant-services",i,{method:"POST",body:JSON.stringify(n)})}async function De(i,n,m){return w(`/assistant-services/${n}`,i,{method:"PUT",body:JSON.stringify(m)})}async function Be(i,n){return w(`/assistant-services/${n}`,i,{method:"DELETE"})}async function Me(i,n){return w("/assistant-products",i,{method:"POST",body:JSON.stringify(n)})}async function Je(i,n,m){return w(`/assistant-products/${n}`,i,{method:"PUT",body:JSON.stringify(m)})}async function Ke(i,n){return w(`/assistant-products/${n}`,i,{method:"DELETE"})}const P="TJS",xe=[{key:"TJS",label:"TJS"},{key:"USD",label:"USD"},{key:"EUR",label:"EUR"},{key:"RUB",label:"RUB"},{key:"UZS",label:"UZS"},{key:"KZT",label:"KZT"}];function je(i,n,m){return new Intl.NumberFormat(m==="ru"?"ru-RU":"en-US",{minimumFractionDigits:0,maximumFractionDigits:2}).format(i)+` ${n}`}function be(i){return i.trim()===""?[]:i.split(`
`).map(n=>n.trim()).filter(Boolean)}function Qe(i){const n=(i??"").trim();if(n==="")return"?";const m=n.split(/\s+/u).filter(Boolean),t=m[0]?.[0]??"",v=m[1]?.[0]??"",p=`${t}${v}`.trim().toUpperCase();return p===""?n.slice(0,1).toUpperCase():p}function Z(i){return i?{name:i.name,description:i.description??"",terms:i.terms_conditions??"",price:String(i.price),currency:i.currency,photoUrls:(i.photo_urls??[]).join(`
`),specialists:(i.specialists??[]).map(n=>({name:n.name,price:String(n.price)})),isActive:i.is_active}:{name:"",description:"",terms:"",price:"",currency:P,photoUrls:"",specialists:[],isActive:!0}}function G(i){return i?{name:i.name,sku:i.sku??"",description:i.description??"",terms:i.terms_conditions??"",price:String(i.price),currency:i.currency,productUrl:i.product_url??"",photoUrls:(i.photo_urls??[]).join(`
`),isUnlimitedStock:i.is_unlimited_stock,stockQuantity:i.stock_quantity!==null?String(i.stock_quantity):"",isActive:i.is_active}:{name:"",sku:"",description:"",terms:"",price:"",currency:P,productUrl:"",photoUrls:"",isUnlimitedStock:!0,stockQuantity:"",isActive:!0}}function ps(){const{user:i,logout:n}=Ae(),{locale:m,messages:t}=Te(),v=re(),p=re(),[z,Y]=d.useState(!1),[ve,$]=d.useState(!0),[ye,H]=d.useState(!1),[W,L]=d.useState(!1),[X,ee]=d.useState(!1),[A,Ne]=d.useState([]),[h,E]=d.useState(null),[F,I]=d.useState([]),[q,V]=d.useState([]),[se,r]=d.useState(null),[te,y]=d.useState(null),[D,ae]=d.useState(null),[B,ie]=d.useState(null),[g,j]=d.useState(Z(null)),[c,b]=d.useState(G(null));$e({title:`${t.catalog.title} | ${t.app.name}`,description:t.catalog.subtitle,locale:m});const M=d.useMemo(()=>A.find(s=>s.id===h)??null,[A,h]),Se=async()=>{Y(!0);try{await n()}finally{Y(!1)}},le=d.useCallback(async()=>{const s=C();if(!s){r(t.catalog.unauthorized),$(!1);return}$(!0),r(null);try{const a=await ze(s);Ne(a.assistants),E(l=>l&&a.assistants.some(u=>u.id===l)?l:null)}catch(a){r(a instanceof _?a.message:t.catalog.loadAssistantsFailed)}finally{$(!1)}},[t.catalog.loadAssistantsFailed,t.catalog.unauthorized]),k=d.useCallback(async s=>{const a=C();if(!a){r(t.catalog.unauthorized);return}H(!0),r(null);try{const[l,u]=await Promise.all([Ie(a,s),qe(a,s)]);I(l.services),V(u.products)}catch(l){r(l instanceof _?l.message:t.catalog.loadCatalogFailed)}finally{H(!1)}},[t.catalog.loadCatalogFailed,t.catalog.unauthorized]);d.useEffect(()=>{le()},[le]),d.useEffect(()=>{if(!h){I([]),V([]);return}k(h)},[k,h]);const we=async()=>{if(!h)return;const s=C();if(!s){r(t.catalog.unauthorized);return}const a=g.name.trim(),l=Number(g.price);if(a.length<2){r(t.catalog.validationName);return}if(Number.isNaN(l)||l<0){r(t.catalog.validationPrice);return}const u=[];for(const o of g.specialists){const f=o.name.trim(),J=o.price.trim();if(f===""&&J==="")continue;if(f.length<2){r(t.catalog.validationSpecialistName);return}if(J===""){u.push({name:f,price:l});continue}const K=Number(J);if(Number.isNaN(K)||K<0){r(t.catalog.validationSpecialistPrice);return}u.push({name:f,price:K})}L(!0),r(null),y(null);try{const o={assistant_id:h,name:a,description:g.description.trim(),terms_conditions:g.terms.trim(),price:l,currency:g.currency.trim().toUpperCase()||P,photo_urls:be(g.photoUrls),specialists:u,is_active:g.isActive};D?(await De(s,D.id,o),y(t.catalog.serviceUpdated)):(await Ve(s,o),y(t.catalog.serviceCreated)),await k(h),v.onClose()}catch(o){r(o instanceof _?o.message:t.catalog.saveFailed)}finally{L(!1)}},_e=async()=>{if(!h)return;const s=C();if(!s){r(t.catalog.unauthorized);return}const a=c.name.trim(),l=Number(c.price),u=Number(c.stockQuantity),o=c.productUrl.trim();if(a.length<2){r(t.catalog.validationName);return}if(Number.isNaN(l)||l<0){r(t.catalog.validationPrice);return}if(!c.isUnlimitedStock&&(Number.isNaN(u)||u<0)){r(t.catalog.validationStock);return}if(o!=="")try{new URL(o)}catch{r(t.catalog.validationProductLink);return}L(!0),r(null),y(null);try{const f={assistant_id:h,name:a,sku:c.sku.trim(),description:c.description.trim(),terms_conditions:c.terms.trim(),price:l,currency:c.currency.trim().toUpperCase()||P,product_url:o===""?void 0:o,photo_urls:be(c.photoUrls),is_unlimited_stock:c.isUnlimitedStock,stock_quantity:c.isUnlimitedStock?void 0:Math.floor(u),is_active:c.isActive};B?(await Je(s,B.id,f),y(t.catalog.productUpdated)):(await Me(s,f),y(t.catalog.productCreated)),await k(h),p.onClose()}catch(f){r(f instanceof _?f.message:t.catalog.saveFailed)}finally{L(!1)}},ke=async s=>{if(!h)return;const a=C();if(!a){r(t.catalog.unauthorized);return}r(null),y(null);try{await Be(a,s),y(t.catalog.serviceDeleted),await k(h)}catch(l){r(l instanceof _?l.message:t.catalog.deleteFailed)}},Ce=async s=>{if(!h)return;const a=C();if(!a){r(t.catalog.unauthorized);return}r(null),y(null);try{await Ke(a,s),y(t.catalog.productDeleted),await k(h)}catch(l){r(l instanceof _?l.message:t.catalog.deleteFailed)}},Ue=s=>{E(s),ee(!0)},Pe=()=>{E(null),I([]),V([]),ee(!1),r(null),y(null)};return e.jsxs(Re,{title:t.catalog.title,user:i,onLogout:Se,isLoggingOut:z,defaultSelectedKey:"products-services",children:[e.jsxs("div",{className:"space-y-4",children:[se?e.jsx(ue,{color:"danger",variant:"faded",title:t.catalog.errorTitle,description:se}):null,te?e.jsx(ue,{color:"success",variant:"faded",title:t.catalog.successTitle,description:te}):null,e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[320px_minmax(0,1fr)]",children:[e.jsx(T,{shadow:"none",className:`border border-default-200 bg-white ${X?"hidden lg:flex":"flex"}`,children:e.jsxs(R,{className:"space-y-4 p-4 sm:p-5",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold",children:t.catalog.assistantsTitle}),e.jsx("p",{className:"text-sm text-default-500",children:t.catalog.assistantsSubtitle})]}),ve?e.jsx("div",{className:"flex min-h-[160px] items-center justify-center",children:e.jsx(ne,{size:"sm"})}):A.length===0?e.jsx("p",{className:"text-sm text-default-500",children:t.catalog.noAssistants}):e.jsx("div",{className:"space-y-2",children:A.map(s=>{const a=s.id===h;return e.jsx("button",{type:"button",onClick:()=>{Ue(s.id)},className:`w-full rounded-large border px-3 py-3 text-left transition ${a?"border-primary-300 bg-primary-50":"border-default-200 bg-white hover:border-default-300 hover:bg-default-50"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Oe,{name:s.name,showFallback:!0,fallback:e.jsx("span",{className:"text-xs font-semibold text-default-700",children:Qe(s.name)}),className:"h-10 w-10 shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),e.jsx(O,{size:"sm",variant:"flat",color:s.is_active?"success":"default",className:"mt-1",children:s.is_active?t.integrations.assistantRunning:t.integrations.assistantStopped})]})]})},s.id)})})]})}),e.jsx(T,{shadow:"none",className:`border border-default-200 bg-white ${X?"flex":"hidden lg:flex"}`,children:e.jsx(R,{children:M?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{isIconOnly:!0,size:"sm",variant:"light",onPress:Pe,"aria-label":t.catalog.backToAssistants,children:e.jsx(N,{icon:"solar:alt-arrow-left-linear",width:18})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:M.name}),e.jsxs("p",{className:"text-sm text-default-500",children:[t.catalog.selectedAssistantPrefix," #",M.id]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{size:"sm",variant:"flat",startContent:e.jsx(N,{icon:"solar:add-circle-linear",width:16}),onPress:()=>{ae(null),j(Z(null)),v.onOpen()},children:t.catalog.addService}),e.jsx(x,{size:"sm",color:"primary",variant:"flat",startContent:e.jsx(N,{icon:"solar:add-circle-linear",width:16}),onPress:()=>{ie(null),b(G(null)),p.onOpen()},children:t.catalog.addProduct})]})]}),ye?e.jsx("div",{className:"flex min-h-[220px] items-center justify-center",children:e.jsx(ne,{size:"sm"})}):e.jsx("div",{className:"max-w-full",children:e.jsxs(Ee,{size:"sm",radius:"sm",variant:"light",classNames:{base:"w-full",tabList:"w-full max-w-full overflow-x-auto rounded-full bg-default-100 p-1 flex-nowrap min-w-max gap-1",tab:"px-4 rounded-full border-none data-[selected=true]:bg-white data-[selected=true]:border-default-300 data-[selected=true]:shadow-none",tabContent:"whitespace-nowrap text-default-600 group-data-[selected=true]:text-foreground",cursor:"hidden"},children:[e.jsx(me,{title:e.jsx("span",{className:"whitespace-nowrap",children:`${t.catalog.servicesTab} (${F.length})`}),children:F.length===0?e.jsx("p",{className:"py-4 text-sm text-default-500",children:t.catalog.emptyServices}):e.jsx("div",{className:"grid gap-3 py-1",children:F.map(s=>e.jsx(T,{shadow:"none",className:"border border-default-200",children:e.jsxs(R,{className:"gap-2 p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),e.jsx("p",{className:"text-xs text-default-600",children:je(s.price,s.currency,m)}),s.specialists.length>0?e.jsxs("p",{className:"text-xs text-default-500",children:[t.catalog.specialistsTitle,": ",s.specialists.length]}):null]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{size:"sm",variant:"flat",color:s.is_active?"success":"default",children:s.is_active?t.catalog.statusActive:t.catalog.statusInactive}),e.jsx(x,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{ae(s),j(Z(s)),v.onOpen()},children:e.jsx(N,{icon:"solar:pen-new-square-linear",width:18})}),e.jsx(x,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>{ke(s.id)},children:e.jsx(N,{icon:"solar:trash-bin-trash-linear",width:18})})]})]}),s.description?e.jsx("p",{className:"line-clamp-2 text-xs text-default-500",children:s.description}):null,s.specialists.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.specialists.slice(0,4).map((a,l)=>e.jsx(O,{size:"sm",variant:"flat",children:a.name},`${a.name}-${l}`))}):null]})},s.id))})},"services"),e.jsx(me,{title:e.jsx("span",{className:"whitespace-nowrap",children:`${t.catalog.productsTab} (${q.length})`}),children:q.length===0?e.jsx("p",{className:"py-4 text-sm text-default-500",children:t.catalog.emptyProducts}):e.jsx("div",{className:"grid gap-3 py-1",children:q.map(s=>e.jsx(T,{shadow:"none",className:"border border-default-200",children:e.jsxs(R,{className:"gap-2 p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),e.jsx("p",{className:"text-xs text-default-600",children:je(s.price,s.currency,m)}),s.sku?e.jsxs("p",{className:"text-xs text-default-500",children:["SKU: ",s.sku]}):null]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{size:"sm",variant:"flat",color:s.is_active?"success":"default",children:s.is_active?t.catalog.statusActive:t.catalog.statusInactive}),e.jsx(x,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{ie(s),b(G(s)),p.onOpen()},children:e.jsx(N,{icon:"solar:pen-new-square-linear",width:18})}),e.jsx(x,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>{Ce(s.id)},children:e.jsx(N,{icon:"solar:trash-bin-trash-linear",width:18})})]})]}),e.jsx("p",{className:"text-xs text-default-500",children:s.is_unlimited_stock?t.catalog.unlimitedStock:`${t.catalog.stockLabel}: ${s.stock_quantity??0}`}),s.product_url?e.jsx(x,{as:"a",href:s.product_url,target:"_blank",rel:"noopener noreferrer",size:"sm",variant:"light",className:"justify-start px-0",startContent:e.jsx(N,{icon:"solar:link-minimalistic-2-linear",width:16}),children:t.catalog.openProductLink}):null]})},s.id))})},"products")]})})]}):e.jsx("div",{className:"flex min-h-[280px] items-center justify-center rounded-large border border-dashed border-default-300 bg-default-50 text-sm text-default-500",children:t.catalog.selectAssistant})})})]})]}),e.jsx(ce,{isOpen:v.isOpen,onOpenChange:v.onOpenChange,size:"2xl",children:e.jsxs(oe,{children:[e.jsx(pe,{children:D?t.catalog.editServiceTitle:t.catalog.newServiceTitle}),e.jsxs(de,{className:"gap-3",children:[e.jsx(S,{label:t.catalog.nameLabel,value:g.name,onValueChange:s=>{j(a=>({...a,name:s}))}}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsx(S,{label:t.catalog.priceLabel,value:g.price,onValueChange:s=>{j(a=>({...a,price:s}))}}),e.jsx(ge,{label:t.catalog.currencyLabel,selectedKeys:[g.currency],onSelectionChange:s=>{const a=String(Array.from(s)[0]??P);j(l=>({...l,currency:a}))},children:xe.map(s=>e.jsx(he,{children:s.label},s.key))})]}),e.jsx(U,{label:t.catalog.descriptionLabel,value:g.description,onValueChange:s=>{j(a=>({...a,description:s}))},minRows:2}),e.jsx(U,{label:t.catalog.termsLabel,value:g.terms,onValueChange:s=>{j(a=>({...a,terms:s}))},minRows:2}),e.jsx(U,{label:t.catalog.photoUrlsLabel,value:g.photoUrls,onValueChange:s=>{j(a=>({...a,photoUrls:s}))},minRows:2}),e.jsxs("div",{className:"space-y-2 rounded-large border border-default-200 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold",children:t.catalog.specialistsTitle}),e.jsx(x,{size:"sm",variant:"flat",startContent:e.jsx(N,{icon:"solar:add-circle-linear",width:16}),onPress:()=>{j(s=>({...s,specialists:[...s.specialists,{name:"",price:""}]}))},children:t.catalog.addSpecialist})]}),g.specialists.length===0?e.jsx("p",{className:"text-xs text-default-500",children:t.catalog.noSpecialists}):e.jsx("div",{className:"space-y-2",children:g.specialists.map((s,a)=>e.jsxs("div",{className:"grid grid-cols-[1fr,1fr,40px] gap-2",children:[e.jsx(S,{label:t.catalog.specialistNameLabel,value:s.name,onValueChange:l=>{j(u=>({...u,specialists:u.specialists.map((o,f)=>f===a?{...o,name:l}:o)}))}}),e.jsx(S,{label:t.catalog.specialistPriceLabel,value:s.price,onValueChange:l=>{j(u=>({...u,specialists:u.specialists.map((o,f)=>f===a?{...o,price:l}:o)}))}}),e.jsx(x,{isIconOnly:!0,color:"danger",variant:"light",className:"self-end",onPress:()=>{j(l=>({...l,specialists:l.specialists.filter((u,o)=>o!==a)}))},children:e.jsx(N,{icon:"solar:trash-bin-trash-linear",width:18})})]},`specialist-${a}`))})]}),e.jsx(Q,{isSelected:g.isActive,onValueChange:s=>{j(a=>({...a,isActive:s}))},children:t.catalog.activeLabel})]}),e.jsxs(fe,{children:[e.jsx(x,{variant:"light",onPress:v.onClose,children:t.common.cancel}),e.jsx(x,{color:"primary",onPress:()=>{we()},isLoading:W,children:t.catalog.saveButton})]})]})}),e.jsx(ce,{isOpen:p.isOpen,onOpenChange:p.onOpenChange,size:"2xl",children:e.jsxs(oe,{children:[e.jsx(pe,{children:B?t.catalog.editProductTitle:t.catalog.newProductTitle}),e.jsxs(de,{className:"gap-3",children:[e.jsx(S,{label:t.catalog.nameLabel,value:c.name,onValueChange:s=>{b(a=>({...a,name:s}))}}),e.jsx(S,{label:t.catalog.skuLabel,value:c.sku,onValueChange:s=>{b(a=>({...a,sku:s}))}}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsx(S,{label:t.catalog.priceLabel,value:c.price,onValueChange:s=>{b(a=>({...a,price:s}))}}),e.jsx(ge,{label:t.catalog.currencyLabel,selectedKeys:[c.currency],onSelectionChange:s=>{const a=String(Array.from(s)[0]??P);b(l=>({...l,currency:a}))},children:xe.map(s=>e.jsx(he,{children:s.label},s.key))})]}),e.jsx(S,{label:t.catalog.productLinkLabel,value:c.productUrl,onValueChange:s=>{b(a=>({...a,productUrl:s}))}}),e.jsx(Q,{isSelected:c.isUnlimitedStock,onValueChange:s=>{b(a=>({...a,isUnlimitedStock:s}))},children:t.catalog.unlimitedStockLabel}),c.isUnlimitedStock?null:e.jsx(S,{label:t.catalog.stockLabel,value:c.stockQuantity,onValueChange:s=>{b(a=>({...a,stockQuantity:s}))}}),e.jsx(U,{label:t.catalog.descriptionLabel,value:c.description,onValueChange:s=>{b(a=>({...a,description:s}))},minRows:2}),e.jsx(U,{label:t.catalog.termsLabel,value:c.terms,onValueChange:s=>{b(a=>({...a,terms:s}))},minRows:2}),e.jsx(U,{label:t.catalog.photoUrlsLabel,value:c.photoUrls,onValueChange:s=>{b(a=>({...a,photoUrls:s}))},minRows:2}),e.jsx(Q,{isSelected:c.isActive,onValueChange:s=>{b(a=>({...a,isActive:s}))},children:t.catalog.activeLabel})]}),e.jsxs(fe,{children:[e.jsx(x,{variant:"light",onPress:p.onClose,children:t.common.cancel}),e.jsx(x,{color:"primary",onPress:()=>{_e()},isLoading:W,children:t.catalog.saveButton})]})]})})]})}export{ps as default};
