import{t as le,A as S,l as ne,n as oe,r,P as D,q as N,j as s,s as ie}from"./index-EtEDBUvV.js";import{a as re,D as ce,c as k,b as G,I as w,m as de,d as me,e as ue}from"./DashboardLayout-B8yQ125T.js";import{b as pe,d as h,c as C}from"./usePageSeo-EE8mv1fT.js";import{c as M}from"./chunk-EIRINNCE-Dv-gY_8I.js";import{m as fe}from"./chunk-R7OT77UN-DyQ6-QSC.js";import{i as P}from"./chunk-SQIAVXJX-B0Nmrhyk.js";import{c as ge}from"./chunk-PMMJMDBI-C-s7vqEG.js";import{s as he}from"./chunk-I3A4XRYQ-DzWNXZQT.js";import{m as ye}from"./chunk-5LXTSPS7-DKALU2AV.js";import"./index-dtaVbuSp.js";import"./useLabel-00ET08Gj.js";import"./chunk-KQW2TNLT-tntXc0HU.js";import"./chunk-ICU6NNET-CqUNE2xV.js";import"./useToggleState-C7Htmiee.js";async function xe(n){return(n.headers.get("content-type")??"").includes("application/json")?n.json():null}async function _(n,d,o={}){const e=new Headers(o.headers??{});e.has("Accept")||e.set("Accept","application/json"),typeof o.body<"u"&&o.body!==null&&!e.has("Content-Type")&&e.set("Content-Type","application/json"),e.set("Authorization",`Bearer ${d}`);const u=await fetch(`${le}${n}`,{...o,headers:e}),p=await xe(u);if(!u.ok){const x=typeof p=="object"&&p!==null&&"message"in p&&typeof p.message=="string"?p.message:"Request failed.";throw new S(x,u.status,p)}return p}async function je(n){return _("/company/employees",n,{method:"GET"})}async function be(n,d){return _("/company/employees",n,{method:"POST",body:JSON.stringify(d)})}async function ve(n,d,o){return _(`/company/employees/${d}`,n,{method:"PUT",body:JSON.stringify(o)})}async function Se(n,d){return _(`/company/employees/${d}`,n,{method:"DELETE"})}const _e=/^\+[1-9][0-9]{7,14}$/;function L(n){return n?{name:n.name,email:n.email,phone:n.phone??"",status:n.status,pageAccess:[...n.page_access]}:{name:"",email:"",phone:"",status:!0,pageAccess:["dashboard"]}}function V(n){const d=n.trim();if(d==="")return"";let o=d.replace(/[^0-9+]/g,"");return o!==""&&o[0]!=="+"&&(o=`+${o}`),o}function Re(){const{user:n,logout:d}=ne(),{locale:o,messages:e}=oe(),u=re(),[p,x]=r.useState(!1),[H,E]=r.useState(!0),[J,O]=r.useState(!1),[U,T]=r.useState(!1),[Q,I]=r.useState(null),[$,j]=r.useState([]),[q,X]=r.useState([...D]),[b,z]=r.useState(null),[i,g]=r.useState(L(null)),[B,m]=r.useState(null),[R,f]=r.useState(null);pe({title:`${e.employees.title} | ${e.app.name}`,description:e.employees.subtitle,locale:o});const v=r.useMemo(()=>({dashboard:e.employees.pageDashboard,"client-requests":e.employees.pageClientRequests,"client-questions":e.employees.pageClientQuestions,"client-chats":e.employees.pageClientChats,"client-base":e.employees.pageClientBase,calendar:e.employees.pageCalendar,"assistant-training":e.employees.pageAssistantTraining,integrations:e.employees.pageIntegrations,"products-services":e.employees.pageProductsServices,billing:e.employees.pageBilling,"business-settings":e.employees.pageBusinessSettings,employees:e.employees.pageEmployees}),[e.employees]),Y=r.useMemo(()=>q.filter(t=>t in v),[q,v]),W=async()=>{x(!0);try{await d()}finally{x(!1)}},A=r.useCallback(async(t=!1)=>{const l=N();if(!l){m(e.employees.unauthorized),E(!1);return}t?T(!0):E(!0),m(null);try{const a=await je(l);j(a.employees),X(a.available_page_access.length>0?a.available_page_access:[...D])}catch(a){m(a instanceof S?a.message:e.employees.loadFailed)}finally{E(!1),T(!1)}},[e.employees.loadFailed,e.employees.unauthorized]);r.useEffect(()=>{A(!1)},[A]);const Z=()=>{z(null),g(L(null)),m(null),f(null),u.onOpen()},K=t=>{z(t),g(L(t)),m(null),f(null),u.onOpen()},ee=(t,l)=>{g(a=>l?a.pageAccess.includes(t)?a:{...a,pageAccess:[...a.pageAccess,t]}:{...a,pageAccess:a.pageAccess.filter(c=>c!==t)})},se=()=>{if(i.name.trim().length<2)return e.employees.validationName;const l=i.email.trim();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l))return e.employees.validationEmail;const a=V(i.phone);return _e.test(a)?i.pageAccess.length===0?e.employees.validationPageAccess:null:e.employees.validationPhone},te=async()=>{const t=se();if(t){m(t),f(null);return}const l=N();if(!l){m(e.employees.unauthorized);return}O(!0),m(null),f(null);const a={name:i.name.trim(),email:i.email.trim(),phone:V(i.phone),page_access:[...i.pageAccess],status:i.status};try{if(b){const c=await ve(l,b.id,a);j(y=>y.map(F=>F.id===c.employee.id?c.employee:F)),f(e.employees.updateSuccess)}else{const c=await be(l,a);j(y=>[c.employee,...y]),f(e.employees.createSuccess)}u.onClose()}catch(c){m(c instanceof S?c.message:e.employees.saveFailed)}finally{O(!1)}},ae=async t=>{if(!window.confirm(o==="ru"?`Удалить сотрудника "${t.name}"?`:`Delete employee "${t.name}"?`))return;const a=N();if(!a){m(e.employees.unauthorized);return}I(t.id),m(null),f(null);try{await Se(a,t.id),j(c=>c.filter(y=>y.id!==t.id)),f(e.employees.deleteSuccess)}catch(c){m(c instanceof S?c.message:e.employees.deleteFailed)}finally{I(null)}};return s.jsxs(ce,{title:e.employees.title,user:n,onLogout:W,isLoggingOut:p,defaultSelectedKey:"employees",children:[s.jsx(k,{className:"border border-default-200 shadow-none",children:s.jsxs(G,{className:"space-y-4 p-4 sm:p-5",children:[s.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx("h2",{className:"text-lg font-semibold text-foreground",children:e.employees.title}),s.jsx("p",{className:"text-sm text-default-500",children:e.employees.subtitle})]}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.jsx(h,{variant:"bordered",onPress:()=>{A(!0)},isLoading:U,children:e.employees.refreshButton}),s.jsx(h,{color:"primary",startContent:s.jsx(w,{icon:"solar:add-circle-linear",width:18}),onPress:Z,children:e.employees.addButton})]})]}),B&&s.jsx(C,{color:"danger",title:e.employees.errorTitle,description:B}),R&&s.jsx(C,{color:"success",title:e.employees.successTitle,description:R}),H?s.jsx("div",{className:"grid min-h-44 place-items-center",children:s.jsx(ie,{label:e.employees.loading})}):$.length===0?s.jsx("div",{className:"rounded-large border border-dashed border-default-300 bg-default-50 px-4 py-12 text-center text-default-500",children:e.employees.empty}):s.jsx("div",{className:"grid grid-cols-1 gap-3 lg:grid-cols-2",children:$.map(t=>s.jsx(k,{className:"border border-default-200 shadow-none",children:s.jsxs(G,{className:"space-y-3 p-4",children:[s.jsxs("div",{className:"flex items-start justify-between gap-3",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-base font-semibold text-foreground",children:t.name}),s.jsx("p",{className:"text-sm text-default-600",children:t.email}),s.jsx("p",{className:"text-sm text-default-500",children:t.phone??"-"})]}),s.jsx(M,{size:"sm",color:t.status?"success":"default",variant:"flat",children:t.status?e.employees.activeStatus:e.employees.inactiveStatus})]}),s.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.page_access.map(l=>s.jsx(M,{size:"sm",variant:"flat",children:v[l]??l},`${t.id}-${l}`))}),s.jsxs("div",{className:"flex items-center justify-end gap-1",children:[s.jsx(h,{isIconOnly:!0,size:"sm",variant:"light","aria-label":e.employees.editButton,onPress:()=>K(t),children:s.jsx(w,{icon:"solar:pen-new-square-linear",width:18})}),s.jsx(h,{isIconOnly:!0,size:"sm",variant:"light",color:"danger",isLoading:Q===t.id,"aria-label":e.employees.deleteButton,onPress:()=>{ae(t)},children:s.jsx(w,{icon:"solar:trash-bin-trash-linear",width:18})})]})]})},t.id))})]})}),s.jsx(de,{isOpen:u.isOpen,onOpenChange:u.onOpenChange,placement:"top-center",children:s.jsx(me,{children:t=>s.jsxs(s.Fragment,{children:[s.jsx(fe,{children:b?e.employees.editModalTitle:e.employees.createModalTitle}),s.jsxs(ue,{className:"space-y-3",children:[!b&&s.jsx(C,{color:"primary",title:e.employees.successTitle,description:e.employees.temporaryPasswordHint}),s.jsx(P,{label:e.employees.nameLabel,value:i.name,onValueChange:l=>g(a=>({...a,name:l}))}),s.jsx(P,{label:e.employees.emailLabel,type:"email",value:i.email,onValueChange:l=>g(a=>({...a,email:l}))}),s.jsx(P,{label:e.employees.phoneLabel,value:i.phone,onValueChange:l=>g(a=>({...a,phone:l}))}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-sm font-medium text-foreground",children:e.employees.pageAccessLabel}),s.jsx("div",{className:"grid grid-cols-1 gap-1 sm:grid-cols-2",children:Y.map(l=>s.jsx(ge,{isSelected:i.pageAccess.includes(l),onValueChange:a=>ee(l,a),children:v[l]??l},l))})]}),s.jsxs("div",{className:"flex items-center justify-between rounded-medium border border-default-200 px-3 py-2",children:[s.jsx("span",{className:"text-sm text-default-700",children:e.employees.statusLabel}),s.jsx(he,{isSelected:i.status,onValueChange:l=>g(a=>({...a,status:l})),children:i.status?e.employees.activeStatus:e.employees.inactiveStatus})]})]}),s.jsxs(ye,{children:[s.jsx(h,{variant:"light",onPress:t,children:e.employees.cancelButton}),s.jsx(h,{color:"primary",isLoading:J,onPress:()=>{te()},children:e.employees.saveButton})]})]})})})]})}export{Re as default};
