import{t as _t,A as y,l as jt,n as vt,r as i,q as S,j as t,s as ge}from"./index-DFt9vaGi.js";import{f as wt,D as Nt,c as Be,b as Ve,I as z,s as He,h as W,i as kt,d as Ue,e as Je,m as St}from"./DashboardLayout-Ds61Xg-w.js";import{b as Tt,c as It,d as L}from"./usePageSeo-zMtdeAIZ.js";import{t as At,a as Mt}from"./chunk-ML27DD5T-CuQq5MOr.js";import{i as F}from"./chunk-SQIAVXJX-DXL5IOXk.js";import{d as Dt}from"./index-DaMPhJ29.js";import{s as Ke}from"./chunk-I3A4XRYQ-Ip9gQi3L.js";import{m as Ft}from"./chunk-R7OT77UN-LecFBPqy.js";import{t as Ot}from"./chunk-WEIB4WXA-BoKOudBS.js";import{m as Rt}from"./chunk-5LXTSPS7-Bxyekykf.js";import"./useLabel-C9azh59v.js";import"./useListState-DtQoTo5n.js";import"./chunk-KQW2TNLT-jIFc4Zc4.js";import"./chunk-ICU6NNET-Cscege8D.js";import"./useToggleState-2DccyJzu.js";async function zt(l){return(l.headers.get("content-type")??"").includes("application/json")?l.json():null}async function T(l,c,n={}){const s=new Headers(n.headers??{}),v=typeof FormData<"u"&&n.body instanceof FormData;s.has("Accept")||s.set("Accept","application/json"),typeof n.body<"u"&&n.body!==null&&!v&&!s.has("Content-Type")&&s.set("Content-Type","application/json"),s.set("Authorization",`Bearer ${c}`);const N=await fetch(`${_t}${l}`,{...n,headers:s}),I=await zt(N);if(!N.ok){const X=typeof I=="object"&&I!==null&&"message"in I&&typeof I.message=="string"?I.message:"Request failed.";throw new y(X,N.status,I)}return I}function Xe(l){const c=new URLSearchParams;Object.entries(l).forEach(([s,v])=>{typeof v>"u"||c.set(s,String(v))});const n=c.toString();return n===""?"":`?${n}`}async function Lt(l,c={}){const n=Xe({channel:c.channel,search:c.search,limit:c.limit});return T(`/chats${n}`,l,{method:"GET"})}async function $t(l,c,n=120){return T(`/chats/${c}${Xe({limit:n})}`,l,{method:"GET"})}async function Pt(l,c){return T(`/chats/${c}/read`,l,{method:"POST"})}async function Ge(l,c,n){if(n.file instanceof File){const s=new FormData;return typeof n.text=="string"&&s.set("text",n.text),typeof n.sender_type=="string"&&s.set("sender_type",n.sender_type),typeof n.direction=="string"&&s.set("direction",n.direction),typeof n.message_type=="string"&&s.set("message_type",n.message_type),s.set("file",n.file),T(`/chats/${c}/messages`,l,{method:"POST",body:s})}return T(`/chats/${c}/messages`,l,{method:"POST",body:JSON.stringify(n)})}async function Et(l,c,n){return T(`/chats/${c}/assistant-reply`,l,{method:"POST",body:JSON.stringify(n)})}async function qt(l,c){return T(`/chats/${c}/insights`,l,{method:"GET"})}async function Bt(l,c,n){return T(`/chats/${c}/ai-enabled`,l,{method:"PATCH",body:JSON.stringify({enabled:n})})}async function Vt(l,c){return T(`/chats/${c}/reset`,l,{method:"POST"})}async function Ht(l,c,n){return T(`/chats/${c}/orders`,l,{method:"POST",body:JSON.stringify(n)})}const Ut=["all","instagram","telegram","widget","api","assistant"],Jt=4*1024*1024,q={phone:"",serviceName:"",address:"",amount:"",note:"",bookAppointment:!1,appointmentDate:"",appointmentTime:"",appointmentDurationMinutes:""};function Kt(l){return l.startsWith("image/")?"image":l.startsWith("video/")?"video":l.startsWith("audio/")?"audio":"file"}function We(l,c){if(!l)return"";const n=new Date(l);return Number.isNaN(n.getTime())?"":new Date().toDateString()===n.toDateString()?new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{hour:"2-digit",minute:"2-digit"}).format(n):new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"short"}).format(n)}function Gt(l,c){if(!l)return"";const n=new Date(l);return Number.isNaN(n.getTime())?"":new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}).format(n)}function re(l){const c=[...l];return c.sort((n,s)=>{const v=Date.parse(n.last_message_at??n.updated_at??n.created_at??"");return Date.parse(s.last_message_at??s.updated_at??s.created_at??"")-v}),c}function Q(l){const c=(l??"").trim();if(c==="")return"?";const n=c.split(/\s+/u).filter(Boolean),s=n[0]?.[0]??"",v=n[1]?.[0]??"",N=`${s}${v}`.trim().toUpperCase();return N===""?c.slice(0,1).toUpperCase():N}function Wt(l){if(l.text&&l.text.trim()!=="")return l.text;switch(l.message_type){case"image":return"[Image]";case"video":return"[Video]";case"voice":return"[Voice]";case"audio":return"[Audio]";case"link":return"[Link]";case"file":return"[File]";default:return"[Message]"}}function Qe(l){if(!l||!l.metadata||typeof l.metadata!="object")return!0;const c=l.metadata.is_active;if(typeof c=="boolean")return c;if(typeof c=="number")return c===1;if(typeof c=="string"){const n=c.trim().toLowerCase();if(["1","true","yes","on"].includes(n))return!0;if(["0","false","no","off"].includes(n))return!1}return!0}function ms(){const{user:l,logout:c}=jt(),{locale:n,messages:s}=vt(),[v,N]=i.useState(!1),[I,X]=i.useState(!0),[Ye,be]=i.useState(!1),[O,Y]=i.useState(!1),[Ze,B]=i.useState(!1),[et,ye]=i.useState(!1),[tt,V]=i.useState(!1),[H,Ce]=i.useState(!1),[le,_e]=i.useState(!1),[oe,je]=i.useState(!1),[st,U]=i.useState(0),[ve,ce]=i.useState(!1),[de,we]=i.useState(!1),[ue,at]=i.useState("all"),[Z,nt]=i.useState(""),[Ne,ke]=i.useState("auto"),[Se,P]=i.useState([]),[me,Te]=i.useState([]),[Ie,Ae]=i.useState(!0),[f,he]=i.useState(null),[u,A]=i.useState(null),[E,M]=i.useState([]),[$,ee]=i.useState(""),[R,te]=i.useState(null),[x,C]=i.useState(q),[J,se]=i.useState(null),[Me,h]=i.useState(null),fe=i.useRef(null),De=i.useRef(null),Fe=i.useRef(0),ae=i.useRef({}),pe=st>0;Tt({title:`${s.clientChats.title} | ${s.app.name}`,description:s.clientChats.subtitle,locale:n});const it=async()=>{N(!0);try{await c()}finally{N(!1)}},w=i.useCallback(e=>{P(a=>{const r=[e,...a.filter(d=>d.id!==e.id)];return re(r)}),A(a=>a?.id===e.id?e:a)},[]),ne=i.useCallback(async(e,a,r=!1)=>{const d=S();if(!d){h(s.clientChats.unauthorized);return}r||be(!0);try{const o=await $t(d,e,150);if(A(o.chat),M(o.messages),Te(o.assistants.map(p=>({id:p.id,name:p.name,is_active:p.is_active}))),Ae(o.subscription?.has_active_subscription??!0),a&&o.chat.unread_count>0){const p=await Pt(d,e);A(p.chat),w(p.chat)}else w(o.chat)}catch(o){if(o instanceof y&&o.status===401){h(s.clientChats.unauthorized);return}h(o instanceof y?o.message:s.clientChats.loadFailed)}finally{r||be(!1)}},[s.clientChats.loadFailed,s.clientChats.unauthorized,w]),ie=i.useCallback(async(e=!0,a=!1)=>{const r=S();if(!r){h(s.clientChats.unauthorized);return}a||X(!0);try{const d=await Lt(r,{channel:ue,search:Z.trim()===""?void 0:Z.trim(),limit:90});P(re(d.chats)),Te(d.assistants.map(o=>({id:o.id,name:o.name,is_active:o.is_active}))),Ae(d.subscription?.has_active_subscription??!0),he(o=>e&&o!==null&&d.chats.some(p=>p.id===o)?o:null),d.chats.length===0&&(A(null),M([]),ce(!1))}catch(d){if(d instanceof y&&d.status===401){h(s.clientChats.unauthorized);return}h(d instanceof y?d.message:s.clientChats.loadFailed)}finally{a||X(!1)}},[ue,s.clientChats.loadFailed,s.clientChats.unauthorized,Z]);i.useEffect(()=>{ie(!1)},[ie]),i.useEffect(()=>{let e=!1;const a=S();if(a)return wt(a).then(r=>{e||we(r.company.settings.account_type==="with_appointments")}).catch(()=>{e||we(!1)}),()=>{e=!0}},[]),i.useEffect(()=>{if(f===null){A(null),M([]);return}ne(f,!0)},[ne,f]),i.useEffect(()=>{B(!1),te(null),V(!1),C(q),se(null),ae.current={}},[f]),i.useEffect(()=>{const e=window.setInterval(()=>{ie(!0,!0),f!==null&&ne(f,!1,!0)},6e3);return()=>{window.clearInterval(e)}},[ne,ie,f]),i.useEffect(()=>{if(!u){ke("auto");return}ke(u.assistant?.id?String(u.assistant.id):"auto")},[u]),i.useEffect(()=>{fe.current&&fe.current.scrollIntoView({behavior:"smooth",block:"end"})},[E]),i.useEffect(()=>{if(J===null)return;const e=ae.current[J];if(!e)return;e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"});const a=window.setTimeout(()=>{se(r=>r===J?null:r)},2200);return()=>{window.clearTimeout(a)}},[E,J]);const Oe=i.useCallback(()=>(Fe.current+=1,-Fe.current),[]),K=i.useCallback(e=>{const a=Oe(),r=new Date().toISOString(),d={id:a,chat_id:f??0,assistant_id:e.assistant_id??u?.assistant?.id??null,sender_type:e.sender_type,direction:e.direction,status:e.status??"sent",channel_message_id:e.channel_message_id??null,message_type:e.message_type??"text",text:e.text,media_url:e.media_url??null,media_mime_type:e.media_mime_type??null,media_size:e.media_size??null,link_url:e.link_url??null,attachments:e.attachments??null,payload:e.payload??null,sent_at:e.sent_at??r,delivered_at:e.delivered_at??null,read_at:e.read_at??null,failed_at:e.failed_at??null,created_at:e.created_at??r};return M(o=>[...o,d]),a},[Oe,u?.assistant?.id,f]),Re=async()=>{if(!f||O)return;const e=S();if(!e){h(s.clientChats.unauthorized);return}const a=$.trim();if(a!==""){h(null),Y(!0);try{const r=await Ge(e,f,{text:a,sender_type:"agent",direction:"outbound",message_type:"text"});ee(""),r.chat_message&&M(d=>[...d,r.chat_message]),w(r.chat)}catch(r){r instanceof y&&r.status===401?h(s.clientChats.unauthorized):h(r instanceof y?r.message:s.clientChats.sendFailed)}finally{Y(!1)}}},ze=async()=>{if(!f||O)return;const e=S();if(!e){h(s.clientChats.unauthorized);return}const a=$.trim();if(a==="")return;const r=Ne==="auto"?void 0:Number(Ne);h(null);const d=r!==void 0?me.find(m=>m.id===r)??null:(u?.assistant?.id?me.find(m=>m.id===u.assistant?.id)??null:null)??me.find(m=>m.is_active)??null,o=K({sender_type:"customer",direction:"inbound",message_type:"text",text:a,assistant_id:d?.id??u?.assistant?.id??null,status:"read",read_at:new Date().toISOString()}),p=new Date().toISOString();if(A(m=>m&&{...m,last_message_preview:a,last_message_at:p}),P(m=>re(m.map(_=>_.id===f?{..._,last_message_preview:a,last_message_at:p}:_))),ee(""),!Ie||!d?.is_active){K({sender_type:"system",direction:"outbound",message_type:"text",text:Ie?n==="ru"?"Ассистент не запущен. Запустите ассистента, чтобы получить ответ.":"Assistant is not running. Start the assistant to get a reply.":n==="ru"?"Подписка неактивна. Купите или продлите тариф, чтобы ассистент отвечал.":"Subscription is inactive. Purchase or renew a plan to get assistant replies.",assistant_id:d?.id??u?.assistant?.id??null});return}U(m=>m+1);try{const m=await Et(e,f,{prompt:a,assistant_id:d?.id});M(_=>[..._.map(j=>j.id===o?m.incoming_message:j),m.assistant_message]),w(m.chat)}catch(m){if(m instanceof y&&m.status===401)h(s.clientChats.unauthorized);else{const _=m instanceof y?m.message:s.clientChats.assistantReplyFailed;K({sender_type:"system",direction:"outbound",message_type:"text",text:_,assistant_id:d?.id??u?.assistant?.id??null})}}finally{U(m=>Math.max(0,m-1))}},rt=i.useCallback(()=>{O||De.current?.click()},[O]),lt=i.useCallback(async e=>{const a=e.target.files?.[0];if(e.target.value="",!a||!f||O)return;if(a.size>Jt){h(n==="ru"?"Размер файла должен быть не больше 4 MB.":"File size must be 4 MB or less.");return}const r=S();if(!r){h(s.clientChats.unauthorized);return}h(null),Y(!0);const d=u?.channel==="assistant",o=Kt(a.type),p=a.name.trim()!==""?a.name.trim():o==="image"?"[Image]":o==="video"?"[Video]":o==="audio"?"[Audio]":"[File]",m=K({sender_type:d?"customer":"agent",direction:d?"inbound":"outbound",message_type:o,text:p,assistant_id:u?.assistant?.id??null,status:d?"read":"sent",read_at:d?new Date().toISOString():null}),_=new Date().toISOString();A(g=>g&&{...g,last_message_preview:p,last_message_at:_}),P(g=>re(g.map(j=>j.id===f?{...j,last_message_preview:p,last_message_at:_}:j))),d&&U(g=>g+1);try{const g=await Ge(r,f,{text:$.trim()===""?void 0:$.trim(),sender_type:d?"customer":"agent",direction:d?"inbound":"outbound",message_type:"file",file:a});M(j=>{const D=j.map(G=>G.id===m&&g.chat_message?g.chat_message:G);return g.assistant_message&&D.push(g.assistant_message),D}),ee(""),w(g.chat)}catch(g){M(j=>j.map(D=>D.id===m?{...D,status:"failed",failed_at:new Date().toISOString()}:D)),g instanceof y&&g.status===401?h(s.clientChats.unauthorized):h(g instanceof y?g.message:s.clientChats.sendFailed)}finally{d&&U(g=>Math.max(0,g-1)),Y(!1)}},[$,O,n,s.clientChats.sendFailed,s.clientChats.unauthorized,K,u?.channel,u?.assistant?.id,f,w]),ot=i.useCallback(e=>{switch(e){case"instagram":return s.clientChats.instagramTab;case"telegram":return s.clientChats.telegramTab;case"widget":return s.clientChats.widgetTab;case"api":return s.clientChats.apiTab;default:return e}},[s.clientChats.apiTab,s.clientChats.instagramTab,s.clientChats.telegramTab,s.clientChats.widgetTab]),ct=i.useMemo(()=>({all:s.clientChats.allChatsTab,instagram:s.clientChats.instagramTab,telegram:s.clientChats.telegramTab,widget:s.clientChats.widgetTab,api:s.clientChats.apiTab,assistant:s.clientChats.assistantTab}),[s.clientChats.allChatsTab,s.clientChats.apiTab,s.clientChats.assistantTab,s.clientChats.instagramTab,s.clientChats.telegramTab,s.clientChats.widgetTab]),Le=i.useMemo(()=>[...E].reverse().find(r=>r.id>0)?.id,[E]),dt=i.useCallback(e=>{switch(e){case"task":return s.clientChats.historyTypeTask;case"question":return s.clientChats.historyTypeQuestion;case"order":return s.clientChats.historyTypeOrder;default:return e}},[s.clientChats.historyTypeOrder,s.clientChats.historyTypeQuestion,s.clientChats.historyTypeTask]),$e=i.useCallback(async e=>{const a=S();if(!a){h(s.clientChats.unauthorized);return}ye(!0);try{const r=await qt(a,e);te({client:r.client,contacts:r.contacts,history:r.history})}catch(r){h(r instanceof y?r.message:s.clientChats.loadFailed)}finally{ye(!1)}},[s.clientChats.loadFailed,s.clientChats.unauthorized]),ut=i.useCallback(()=>{f&&(h(null),B(!0),$e(f))},[$e,f]),mt=i.useCallback(async e=>{if(!f||!u||le)return;const a=S();if(!a){h(s.clientChats.unauthorized);return}const r=Qe(u),d=(o,p)=>({...o,metadata:{...o.metadata??{},is_active:p}});h(null),_e(!0),A(o=>!o||o.id!==f?o:d(o,e)),P(o=>o.map(p=>p.id===f?d(p,e):p));try{const o=await Bt(a,f,e);w(o.chat)}catch(o){A(p=>!p||p.id!==f?p:d(p,r)),P(p=>p.map(m=>m.id===f?d(m,r):m)),h(o instanceof y?o.message:s.clientChats.sendFailed)}finally{_e(!1)}},[le,s.clientChats.sendFailed,s.clientChats.unauthorized,u,f,w]),ht=i.useCallback(async()=>{if(!f||!u||u.channel!=="assistant"||oe)return;const e=S();if(!e){h(s.clientChats.unauthorized);return}h(null),je(!0);try{const a=await Vt(e,f);M([]),U(0),se(null),B(!1),te(null),ae.current={},w(a.chat)}catch(a){a instanceof y&&a.status===401?h(s.clientChats.unauthorized):h(a instanceof y?a.message:s.clientChats.resetChatFailed)}finally{je(!1)}},[oe,s.clientChats.resetChatFailed,s.clientChats.unauthorized,u,f,w]),ft=i.useCallback(()=>{const e=R?.contacts.find(r=>r.key==="phone")?.value??"",a=R?.contacts.find(r=>r.key==="address")?.value??"";C({...q,phone:e,address:a,bookAppointment:!1,appointmentDate:"",appointmentTime:"",appointmentDurationMinutes:""}),h(null),V(!0)},[R?.contacts]),pt=i.useCallback(async()=>{if(!f||H)return;const e=S();if(!e){h(s.clientChats.unauthorized);return}const a=x.phone.trim(),r=x.serviceName.trim(),d=x.address.trim(),o=x.amount.trim(),p=x.note.trim(),m=de&&x.bookAppointment,_=x.appointmentDate.trim(),g=x.appointmentTime.trim(),j=x.appointmentDurationMinutes.trim();if(a===""||r===""||d===""){h(s.clientChats.orderModalRequiredFields);return}let D;if(o!==""){const b=Number(o);if(!Number.isFinite(b)||b<0){h(s.clientChats.orderModalInvalidAmount);return}D=b}let G;if(m){if(_===""||g===""||j===""){h(s.clientChats.orderModalAppointmentRequiredFields);return}const b=Number(j);if(!Number.isFinite(b)||b<15||b>720){h(s.clientChats.orderModalInvalidDuration);return}G=Math.round(b)}h(null),Ce(!0);try{const b=await Ht(e,f,{phone:a,service_name:r,address:d,amount:D,note:p===""?void 0:p,chat_message_id:Le,book_appointment:m?!0:void 0,appointment_date:m?_:void 0,appointment_time:m?g:void 0,appointment_duration_minutes:m?G:void 0});C(q),V(!1),te(qe=>{const yt=(qe?.history??[]).filter(Ct=>Ct.id!==b.order.id);return{client:b.client??qe?.client??null,contacts:b.contacts,history:[b.order,...yt]}})}catch(b){h(b instanceof y?b.message:s.clientChats.sendFailed)}finally{Ce(!1)}},[H,de,Le,s.clientChats.orderModalAppointmentRequiredFields,s.clientChats.orderModalInvalidDuration,s.clientChats.orderModalInvalidAmount,s.clientChats.orderModalRequiredFields,s.clientChats.sendFailed,s.clientChats.unauthorized,x.address,x.amount,x.appointmentDate,x.appointmentDurationMinutes,x.appointmentTime,x.bookAppointment,x.note,x.phone,x.serviceName,f]),xt=i.useCallback(e=>{e.chat_message_id&&(se(e.chat_message_id),B(!1))},[]),k=u?.channel==="assistant",xe=u?.assistant?.name?.trim()||u?.name?.trim()||"Assistant",gt=!!u?.assistant?.is_active,Pe=Qe(u),Ee=O||pe,bt=k?pe:O;return t.jsxs(Nt,{title:s.clientChats.title,user:l,onLogout:it,isLoggingOut:v,defaultSelectedKey:"client-chats",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsx("input",{ref:De,type:"file",className:"hidden",onChange:e=>{lt(e)}}),Me?t.jsx(It,{color:"danger",variant:"faded",title:s.clientChats.errorTitle,description:Me}):null,t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[360px_minmax(0,1fr)]",children:[t.jsx(Be,{shadow:"none",className:`border border-default-200 bg-white ${ve?"hidden lg:flex":"flex"}`,children:t.jsxs(Ve,{className:"p-0",children:[t.jsxs("div",{className:"space-y-3 border-b border-default-200 px-4 py-4",children:[t.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.subtitle}),t.jsx("div",{className:"max-w-full overflow-x-auto rounded-full bg-default-100 p-1",children:t.jsx(At,{selectedKey:ue,onSelectionChange:e=>{at(String(e)),h(null)},size:"sm",radius:"sm",variant:"light",classNames:{base:"min-w-max",tabList:"bg-transparent p-0 flex-nowrap min-w-max gap-1",tab:" px-4 rounded-full border-none data-[selected=true]:bg-white data-[selected=true]:border-default-300 data-[selected=true]:shadow-none",tabContent:"text-default-600 group-data-[selected=true]:text-foreground",cursor:"hidden"},children:Ut.map(e=>t.jsx(Mt,{title:t.jsx("span",{className:"whitespace-nowrap",children:ct[e]})},e))})}),t.jsx(F,{size:"sm",value:Z,radius:"full",onChange:e=>nt(e.target.value),placeholder:s.clientChats.searchPlaceholder,startContent:t.jsx(z,{icon:"solar:magnifer-linear",width:16})})]}),t.jsx(He,{className:"",children:I?t.jsx("div",{className:"flex h-full items-center justify-center py-12",children:t.jsx(ge,{size:"sm",label:s.clientChats.loadingChats})}):Se.length===0?t.jsx("div",{className:"px-4 py-8 text-sm text-default-500",children:s.clientChats.emptyChats}):t.jsx("div",{className:"divide-y divide-default-100",children:Se.map(e=>{const a=e.id===f,r=e.name?.trim()||`#${e.id}`;return t.jsx("button",{type:"button",onClick:()=>{he(e.id),ce(!0),h(null)},className:`w-full px-4 py-3 text-left transition ${a?"bg-primary-50":"bg-transparent hover:bg-default-50"}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(W,{src:e.channel==="assistant"?void 0:e.avatar??void 0,name:r,showFallback:!0,fallback:t.jsx("span",{className:"text-xs font-semibold text-default-700",children:Q(r)}),className:"h-9 w-9 shrink-0"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"mb-1 flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"min-w-0 flex items-center gap-1.5",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:r}),e.unread_count>0?t.jsx("span",{className:"inline-flex h-4 min-w-4 items-center justify-center rounded-full bg-primary px-1 text-[10px] font-semibold leading-none text-white",children:e.unread_count>99?"99+":e.unread_count}):null]}),t.jsx("span",{className:"shrink-0 text-xs text-default-500",children:We(e.last_message_at,n)})]}),t.jsx("p",{className:"mb-2 truncate text-xs text-default-500",children:e.last_message_preview??s.clientChats.noPreview})]})]})},e.id)})})})]})}),t.jsx(Be,{shadow:"none",className:`border border-default-200 bg-white ${ve?"flex":"hidden lg:flex"}`,children:t.jsx(Ve,{className:"p-0",children:u?t.jsxs("div",{className:"flex h-[calc(100vh-180px)] flex-col bg-white",children:[t.jsx("div",{className:"space-y-3 border-b border-default-200 px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[t.jsx(L,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{he(null),ce(!1)},"aria-label":s.clientChats.backToList,children:t.jsx(z,{icon:"solar:alt-arrow-left-linear",width:18})}),t.jsx(W,{src:u.avatar??void 0,name:u.name??`#${u.id}`,showFallback:!0,fallback:t.jsx("span",{className:"text-xs font-semibold text-default-700",children:Q(u.name??`#${u.id}`)}),className:"h-9 w-9 shrink-0"}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground sm:text-base",children:u.name?.trim()||`#${u.id}`}),t.jsx("p",{className:"text-xs text-default-500",children:k?`Assistant · ${gt?n==="ru"?"Онлайн":"Online":n==="ru"?"Оффлайн":"Offline"}`:`${s.clientChats.channelLabel}: ${ot(u.channel)}`})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[k?t.jsx(L,{size:"sm",color:"danger",variant:"flat",onPress:()=>{ht()},isLoading:oe,startContent:t.jsx(z,{icon:"solar:restart-bold-duotone",width:16}),children:t.jsx("span",{className:"hidden sm:inline",children:s.clientChats.resetChatButton})}):null,t.jsx(L,{isIconOnly:!0,size:"sm",variant:"light",onPress:ut,"aria-label":s.clientChats.chatInfoButton,children:t.jsx(z,{icon:"solar:info-circle-linear",width:18,className:"text-default-500"})})]})]})}),t.jsx(He,{className:"flex-1 bg-default-50 px-3 py-4 sm:px-4",children:Ye?t.jsx("div",{className:"flex h-full items-center justify-center",children:t.jsx(ge,{size:"sm",label:s.clientChats.loadingMessages})}):E.length===0?t.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.emptyMessages}):t.jsxs("div",{className:"mx-auto w-full max-w-[980px] space-y-5",children:[E.map(e=>{const a=k?e.sender_type==="customer"||e.sender_type==="agent":e.direction==="outbound",r=k?xe:u.name?.trim()||`#${u.id}`,d=k?void 0:u.avatar??void 0,o=We(e.sent_at??e.created_at,n),p=Wt(e);return t.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`flex items-end gap-2 ${a?"flex-row-reverse":"flex-row"}`,children:[a?null:t.jsx(W,{src:d,name:r,showFallback:!0,fallback:t.jsx("span",{className:"text-[11px] font-semibold text-default-700",children:Q(r)}),className:"h-8 w-8 shrink-0"}),t.jsxs("div",{ref:m=>{ae.current[e.id]=m},className:`rounded-2xl border px-3 py-2 transition ${J===e.id?"ring-2 ring-primary-300 ring-offset-1 ring-offset-background":""} max-w-[88%] min-w-[148px] border-default-200 bg-default-100 sm:max-w-[74%]`,children:[t.jsx("p",{className:"whitespace-pre-wrap break-words text-sm text-foreground",children:p}),e.media_url?t.jsx("a",{href:e.media_url,target:"_blank",rel:"noreferrer",className:"mt-2 block text-xs text-primary hover:underline",children:e.media_url}):null,e.link_url?t.jsx("a",{href:e.link_url,target:"_blank",rel:"noreferrer",className:"mt-2 block text-xs text-primary hover:underline",children:e.link_url}):null,t.jsx("p",{className:"mt-1 text-right text-[11px] leading-none text-default-500",children:o})]})]})},e.id)}),k&&pe?t.jsx("div",{className:"flex justify-start",children:t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx(W,{src:void 0,name:xe,showFallback:!0,fallback:t.jsx("span",{className:"text-[11px] font-semibold text-default-700",children:Q(xe)}),className:"h-8 w-8 shrink-0"}),t.jsx("div",{className:"inline-flex w-auto rounded-2xl border border-default-200 bg-default-100 px-3 py-2",children:t.jsxs("div",{className:"flex items-center gap-1.5 py-1",children:[t.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-default-400"}),t.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-default-400",style:{animationDelay:"120ms"}}),t.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-default-400",style:{animationDelay:"240ms"}})]})})]})}):null,t.jsx("div",{ref:fe})]})}),t.jsx(Dt,{}),t.jsx("div",{className:"border-t border-default-200 bg-white px-2 pt-2 pb-1 sm:px-2 sm:pb-2",children:t.jsx("div",{className:"mx-auto w-full max-w-full",children:t.jsxs("div",{className:"flex items-center gap-2 rounded-xl border border-default-200 bg-white px-2 py-0.5",children:[t.jsx(L,{isIconOnly:!0,size:"sm",variant:"light",onPress:rt,isDisabled:Ee,"aria-label":"Attach file",children:t.jsx(z,{icon:"solar:paperclip-linear",width:17})}),t.jsx(F,{value:$,onValueChange:ee,onKeyDown:e=>{if(e.key==="Enter"){if(e.preventDefault(),k){ze();return}Re()}},placeholder:s.clientChats.messagePlaceholder,variant:"flat",className:"flex-1 bg-transparent hover:bg-transparent focus:bg-transparent",classNames:{inputWrapper:"bg-transparent shadow-none"}}),t.jsx(L,{isIconOnly:!0,size:"sm",color:"primary",radius:"md",onPress:()=>{if(k){ze();return}Re()},isLoading:bt,isDisabled:Ee||$.trim()==="","aria-label":k?s.clientChats.askAssistantButton:s.clientChats.sendButton,children:t.jsx(z,{icon:"solar:arrow-up-linear",width:16})})]})})})]}):t.jsx("div",{className:"flex h-[calc(100vh-180px)] items-center justify-center px-6",children:t.jsxs("div",{className:"max-w-sm space-y-2 text-center",children:[t.jsx(z,{icon:"solar:chat-round-line-outline",width:34,className:"mx-auto text-default-400"}),t.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.clientChats.selectChatTitle}),t.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.selectChatDescription})]})})})})]})]}),t.jsx(kt,{isOpen:Ze,onOpenChange:B,placement:"right",classNames:{base:"w-full sm:max-w-[460px]",wrapper:"shadow-none"},children:t.jsx(Ue,{children:()=>t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-b border-default-200 px-4 py-3",children:t.jsx("div",{className:"space-y-1",children:t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:s.clientChats.chatInfoTitle}),t.jsx("p",{className:"text-xs text-default-500",children:s.clientChats.chatInfoDescription})]})})}),t.jsx(Je,{className:"space-y-4 py-4",children:et?t.jsx("div",{className:"flex items-center justify-center py-10",children:t.jsx(ge,{size:"sm"})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-3 rounded-large border border-default-200 bg-default-50 px-3 py-2",children:[t.jsx(W,{src:u?.channel==="assistant"?void 0:u?.avatar??void 0,name:u?.name??"#",showFallback:!0,fallback:t.jsx("span",{className:"text-xs font-semibold text-default-700",children:Q(u?.name)}),className:"h-10 w-10 shrink-0"}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:u?.name?.trim()||`#${u?.id??""}`}),t.jsxs("p",{className:"truncate text-xs text-default-500",children:[s.clientChats.chatInfoClient,":"," ",R?.client?.name?.trim()||"-"]})]})]}),t.jsx("div",{className:"rounded-large border border-default-200 bg-white px-3 py-2",children:t.jsx(Ke,{size:"sm",isSelected:Pe,isDisabled:le,onValueChange:e=>{mt(e)},children:Pe?s.clientChats.chatInfoAiEnabled:s.clientChats.chatInfoAiDisabled})}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.clientChats.chatInfoContactsTitle}),(R?.contacts.length??0)===0?t.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.chatInfoNoContacts}):t.jsx("div",{className:"space-y-2",children:(R?.contacts??[]).map(e=>t.jsxs("div",{className:"rounded-large border border-default-200 bg-white px-3 py-2",children:[t.jsx("p",{className:"text-[11px] uppercase tracking-wide text-default-500",children:e.label}),t.jsx("p",{className:"break-all text-sm text-foreground",children:e.value})]},e.key))})]}),t.jsx("div",{className:"pt-1",children:t.jsx(L,{color:"primary",onPress:ft,children:s.clientChats.chatInfoCreateOrderButton})}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.clientChats.chatInfoHistoryTitle}),(R?.history.length??0)===0?t.jsx("p",{className:"text-sm text-default-500",children:s.clientChats.chatInfoNoHistory}):t.jsx("div",{className:"space-y-2",children:(R?.history??[]).map(e=>{const a=typeof e.chat_message_id=="number"&&e.chat_message_id>0;return t.jsx("button",{type:"button",onClick:()=>xt(e),disabled:!a,className:`w-full rounded-large border border-default-200 px-3 py-2 text-left transition ${a?"bg-white hover:border-primary-300 hover:bg-primary-50/30":"cursor-default bg-default-50"}`,children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:e.title}),t.jsxs("p",{className:"mt-0.5 text-xs text-default-500",children:[dt(e.type)," ·"," ",Gt(e.created_at,n)]}),a?t.jsx("p",{className:"mt-1 text-[11px] text-primary",children:s.clientChats.chatInfoHistoryJumpHint}):null]}),a?t.jsx(z,{icon:"solar:alt-arrow-right-linear",width:16,className:"shrink-0 text-default-500"}):null]})},e.id)})})]})]})})]})})}),t.jsx(St,{isOpen:tt,onOpenChange:e=>{!e&&H||(V(e),e||C(q))},placement:"center",size:"lg",children:t.jsxs(Ue,{children:[t.jsx(Ft,{className:"pb-1",children:s.clientChats.orderModalTitle}),t.jsxs(Je,{className:"space-y-3",children:[t.jsx(F,{label:s.clientChats.orderModalPhoneLabel,placeholder:s.clientChats.orderModalPhonePlaceholder,value:x.phone,onValueChange:e=>{C(a=>({...a,phone:e}))},variant:"bordered"}),t.jsx(F,{label:s.clientChats.orderModalServiceLabel,placeholder:s.clientChats.orderModalServicePlaceholder,value:x.serviceName,onValueChange:e=>{C(a=>({...a,serviceName:e}))},variant:"bordered"}),t.jsx(F,{label:s.clientChats.orderModalAddressLabel,placeholder:s.clientChats.orderModalAddressPlaceholder,value:x.address,onValueChange:e=>{C(a=>({...a,address:e}))},variant:"bordered"}),t.jsx(F,{label:s.clientChats.orderModalAmountLabel,placeholder:s.clientChats.orderModalAmountPlaceholder,value:x.amount,onValueChange:e=>{C(a=>({...a,amount:e}))},variant:"bordered",inputMode:"decimal"}),de?t.jsxs("div",{className:"space-y-3 rounded-large border border-default-200 px-3 py-3",children:[t.jsx(Ke,{size:"sm",isSelected:x.bookAppointment,onValueChange:e=>{C(a=>({...a,bookAppointment:e,appointmentDate:e?a.appointmentDate:"",appointmentTime:e?a.appointmentTime:"",appointmentDurationMinutes:e?a.appointmentDurationMinutes:""}))},children:s.clientChats.orderModalBookAppointmentSwitch}),x.bookAppointment?t.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[t.jsx(F,{type:"date",label:s.clientChats.orderModalAppointmentDateLabel,value:x.appointmentDate,onValueChange:e=>{C(a=>({...a,appointmentDate:e}))},variant:"bordered"}),t.jsx(F,{type:"time",label:s.clientChats.orderModalAppointmentTimeLabel,value:x.appointmentTime,onValueChange:e=>{C(a=>({...a,appointmentTime:e}))},variant:"bordered"}),t.jsx(F,{type:"number",inputMode:"numeric",min:15,max:720,step:5,label:s.clientChats.orderModalAppointmentDurationLabel,placeholder:s.clientChats.orderModalAppointmentDurationPlaceholder,value:x.appointmentDurationMinutes,onValueChange:e=>{C(a=>({...a,appointmentDurationMinutes:e}))},variant:"bordered"})]}):null]}):null,t.jsx(Ot,{label:s.clientChats.orderModalNoteLabel,placeholder:s.clientChats.orderModalNotePlaceholder,value:x.note,onValueChange:e=>{C(a=>({...a,note:e}))},variant:"bordered",minRows:3,maxRows:6})]}),t.jsxs(Rt,{children:[t.jsx(L,{variant:"light",onPress:()=>{H||(V(!1),C(q))},children:s.clientChats.orderModalCancelButton}),t.jsx(L,{color:"primary",onPress:()=>{pt()},isLoading:H,children:s.clientChats.orderModalSubmitButton})]})]})})]})}export{ms as default};
