import{t as oe,A as x,g as ae,l as le,n as re,r as a,q as _,j as s,s as ce}from"./index-C_u4xdyz.js";import{D as ue,c as w,b as N,I as S,m as R,d as $,e as M}from"./DashboardLayout-DkkABKGa.js";import{b as de,c as U,d as h}from"./usePageSeo-BxJ-yz3t.js";import{c as pe}from"./chunk-EIRINNCE-uTIp6tVc.js";import{m as G}from"./chunk-R7OT77UN-DE55y1Ly.js";import{t as he}from"./chunk-WEIB4WXA-DK_Uz93r.js";import{s as fe,l as v}from"./chunk-C3QHEOC2-B5FrEUze.js";import{m as H}from"./chunk-5LXTSPS7-7t5Pyu1u.js";import"./index-B4Fwgosg.js";import"./useLabel-CzKtmXGX.js";import"./chunk-KQW2TNLT-twPLoLlr.js";import"./chunk-ICU6NNET-vKgoiDZU.js";import"./useListState-DfXDCfwh.js";import"./index-BDsjdhwy.js";async function me(o){return(o.headers.get("content-type")??"").includes("application/json")?o.json():null}async function B(o,c,r={}){const u=new Headers(r.headers??{});u.has("Accept")||u.set("Accept","application/json"),typeof r.body<"u"&&r.body!==null&&!u.has("Content-Type")&&u.set("Content-Type","application/json"),u.set("Authorization",`Bearer ${c}`);const e=await fetch(`${oe}${o}`,{...r,headers:u}),d=await me(e);if(!e.ok){const m=typeof d=="object"&&d!==null&&"message"in d&&typeof d.message=="string"?d.message:"Request failed.";throw new x(m,e.status,d)}return d}async function ge(o){return B("/client-questions",o,{method:"GET"})}async function J(o,c,r){return B(`/client-questions/${c}`,o,{method:"PATCH",body:JSON.stringify(r)})}async function xe(o,c){return B(`/client-questions/${c}`,o,{method:"DELETE"})}function Qe(o,c){if(!o)return"-";const r=new Date(o);return Number.isNaN(r.getTime())?"-":new Intl.DateTimeFormat(c==="ru"?"ru-RU":"en-US",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hourCycle:"h23"}).format(r)}function je(o){return o==="new"?"open":o==="in_progress"?"in_progress":"answered"}function ke(){const o=ae(),{user:c,logout:r}=le(),{locale:u,messages:e}=re(),[d,m]=a.useState(!0),[K,I]=a.useState(!1),[V,k]=a.useState(!1),[W,q]=a.useState(!1),[C,Q]=a.useState([]),[L,A]=a.useState(null),[g,j]=a.useState(null),[f,y]=a.useState(null),[D,l]=a.useState(null),[z,P]=a.useState(null);de({title:`${e.clientQuestions.title} | ${e.app.name}`,description:e.clientQuestions.subtitle,locale:u});const X=async()=>{q(!0);try{await r()}finally{q(!1)}},F=a.useCallback(async()=>{const n=_();if(!n){l(e.clientQuestions.unauthorized),m(!1);return}m(!0);try{const t=await ge(n);Q(t.questions)}catch(t){l(t instanceof x?t.message:e.clientQuestions.updateFailed)}finally{m(!1)}},[e.clientQuestions.unauthorized,e.clientQuestions.updateFailed]);a.useEffect(()=>{F()},[F]);const E=a.useMemo(()=>[{key:"new",label:e.clientQuestions.columnNew},{key:"in_progress",label:e.clientQuestions.columnInProgress},{key:"completed",label:e.clientQuestions.columnCompleted}],[e.clientQuestions.columnCompleted,e.clientQuestions.columnInProgress,e.clientQuestions.columnNew]),Y=a.useMemo(()=>{const n=new Map;return E.forEach(t=>{n.set(t.key,[])}),C.forEach(t=>{const i=n.get(t.board);i&&i.push(t)}),n},[E,C]),Z=n=>{switch(n){case"in_progress":return e.clientQuestions.statusInProgress;case"answered":return e.clientQuestions.statusAnswered;case"closed":return e.clientQuestions.statusClosed;default:return e.clientQuestions.statusOpen}},ee=n=>{switch(n){case"in_progress":return"primary";case"answered":case"closed":return"success";default:return"default"}},se=n=>{A(n),y({description:n.description,status:n.status})},T=()=>{A(null),y(null)},te=async()=>{if(!L||!f)return;const n=_();if(!n){l(e.clientQuestions.unauthorized);return}const t=f.description.trim();if(t.length<2){l(e.clientQuestions.requiredFields);return}I(!0),l(null);try{const i=await J(n,L.id,{description:t,status:f.status});Q(p=>p.map(b=>b.id===i.question.id?i.question:b)),P(e.clientQuestions.updateSuccess),T()}catch(i){l(i instanceof x?i.message:e.clientQuestions.updateFailed)}finally{I(!1)}},ne=async(n,t)=>{const i=_();if(!i){l(e.clientQuestions.unauthorized);return}l(null);try{const p=await J(i,n.id,{board:t,status:je(t)});Q(b=>b.map(O=>O.id===p.question.id?p.question:O)),P(e.clientQuestions.updateSuccess)}catch(p){l(p instanceof x?p.message:e.clientQuestions.updateFailed)}},ie=async()=>{if(!g)return;const n=_();if(!n){l(e.clientQuestions.unauthorized);return}k(!0),l(null);try{await xe(n,g.id),Q(t=>t.filter(i=>i.id!==g.id)),j(null),P(e.clientQuestions.deleteSuccess)}catch(t){l(t instanceof x?t.message:e.clientQuestions.deleteFailed)}finally{k(!1)}};return s.jsxs(ue,{title:e.clientQuestions.title,user:c,onLogout:X,isLoggingOut:W,defaultSelectedKey:"client-questions",children:[s.jsxs("div",{className:"space-y-4",children:[D?s.jsx(U,{color:"danger",title:e.clientQuestions.errorTitle,description:D}):null,z?s.jsx(U,{color:"success",title:e.clientQuestions.successTitle,description:z}):null,d?s.jsx(w,{className:"border border-default-200 shadow-none",children:s.jsx(N,{className:"grid min-h-56 place-items-center",children:s.jsx(ce,{label:e.clientQuestions.loading})})}):C.length===0?s.jsx(w,{className:"border border-default-200 shadow-none",children:s.jsx(N,{className:"rounded-large border border-dashed border-default-300 bg-default-50 px-4 py-14 text-center text-default-500",children:e.clientQuestions.empty})}):s.jsx("div",{className:"grid grid-cols-1 gap-3 xl:grid-cols-3",children:E.map(n=>s.jsx(w,{className:"border border-default-200 shadow-none",children:s.jsxs(N,{className:"space-y-3 p-3",children:[s.jsx("h3",{className:"text-sm font-semibold text-foreground",children:n.label}),s.jsx("div",{className:"space-y-3",children:(Y.get(n.key)??[]).map(t=>{const i=t.board==="new"?"in_progress":t.board==="in_progress"?"completed":"in_progress",p=t.board==="new"?e.clientQuestions.moveToProgressButton:t.board==="in_progress"?e.clientQuestions.moveToCompletedButton:e.clientQuestions.reopenButton;return s.jsx(w,{className:"border border-default-200 bg-default-50 shadow-none",children:s.jsxs(N,{className:"space-y-3 p-3",children:[s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsxs("div",{className:"min-w-0",children:[s.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:t.client?.name??e.clientQuestions.noClient}),s.jsx("p",{className:"truncate text-xs text-default-500",children:t.assistant?.name??"-"})]}),s.jsx(pe,{size:"sm",variant:"flat",color:ee(t.status),children:Z(t.status)})]}),s.jsx("p",{className:"line-clamp-4 text-sm text-default-700",children:t.description}),s.jsxs("div",{className:"space-y-1 text-xs text-default-500",children:[s.jsxs("p",{className:"flex items-center gap-1.5",children:[s.jsx(S,{icon:"solar:phone-linear",width:14}),s.jsxs("span",{children:[e.clientQuestions.phoneLabel,":"," ",t.client?.phone||e.clientQuestions.noPhone]})]}),s.jsxs("p",{className:"flex items-center gap-1.5",children:[s.jsx(S,{icon:"solar:clock-circle-linear",width:14}),s.jsxs("span",{children:[e.clientQuestions.updatedAtLabel,":"," ",Qe(t.updated_at,u)]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(h,{size:"sm",variant:"flat",className:"flex-1",isDisabled:!t.source_chat_id,onPress:()=>{t.source_chat_id&&o("/client-chats")},children:t.source_chat_id?e.clientQuestions.openChatButton:e.clientQuestions.noChat}),s.jsx(h,{size:"sm",variant:"flat",color:"primary",isIconOnly:!0,onPress:()=>se(t),"aria-label":e.clientQuestions.editButton,children:s.jsx(S,{icon:"solar:pen-linear",width:17})}),s.jsx(h,{size:"sm",variant:"flat",color:"danger",isIconOnly:!0,onPress:()=>j(t),"aria-label":e.clientQuestions.deleteButton,children:s.jsx(S,{icon:"solar:trash-bin-trash-linear",width:17})})]}),s.jsx(h,{size:"sm",color:t.board==="in_progress"?"success":"primary",className:"w-full",onPress:()=>{ne(t,i)},children:p})]})},t.id)})})]})},n.key))})]}),s.jsx(R,{isOpen:!!(L&&f),onOpenChange:T,children:s.jsxs($,{children:[s.jsx(G,{children:e.clientQuestions.editModalTitle}),s.jsx(M,{className:"space-y-3",children:f?s.jsxs(s.Fragment,{children:[s.jsx(he,{label:e.clientQuestions.editDescriptionLabel,value:f.description,onValueChange:n=>{y(t=>t&&{...t,description:n})},minRows:5}),s.jsxs(fe,{label:e.clientQuestions.editStatusLabel,selectedKeys:[f.status],onSelectionChange:n=>{const t=Array.from(n)[0];typeof t=="string"&&y(i=>i&&{...i,status:t})},children:[s.jsx(v,{children:e.clientQuestions.statusOpen},"open"),s.jsx(v,{children:e.clientQuestions.statusInProgress},"in_progress"),s.jsx(v,{children:e.clientQuestions.statusAnswered},"answered"),s.jsx(v,{children:e.clientQuestions.statusClosed},"closed")]})]}):null}),s.jsxs(H,{children:[s.jsx(h,{variant:"light",onPress:T,children:e.clientQuestions.editCancel}),s.jsx(h,{color:"primary",isLoading:K,onPress:()=>{te()},children:e.clientQuestions.editSave})]})]})}),s.jsx(R,{isOpen:!!g,onOpenChange:n=>{n||j(null)},children:s.jsxs($,{children:[s.jsx(G,{children:e.clientQuestions.deleteButton}),s.jsx(M,{children:g?.description}),s.jsxs(H,{children:[s.jsx(h,{variant:"light",onPress:()=>j(null),children:e.clientQuestions.editCancel}),s.jsx(h,{color:"danger",isLoading:V,onPress:()=>{ie()},children:e.clientQuestions.deleteButton})]})]})})]})}export{ke as default};
