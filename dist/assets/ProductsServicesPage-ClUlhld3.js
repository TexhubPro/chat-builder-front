import{x as Le,A as k,l as Ae,n as Te,r as d,q as C,j as e,s as ne}from"./index-BKExW_na.js";import{a as re,D as Re,c as T,b as R,I as N,m as ce,d as oe,e as de}from"./DashboardLayout-DDZNcain.js";import{a as Oe}from"./assistantClient-CcA1aB3f.js";import{b as ze,c as x}from"./usePageSeo-8KitHnL0.js";import{a as ue}from"./chunk-VF35X3H6-B4TsPbG8.js";import{t as $e,a as me}from"./chunk-ML27DD5T-NeMMzR39.js";import{c as K}from"./chunk-EIRINNCE-DXQX58KB.js";import{m as pe}from"./chunk-R7OT77UN-DRNPAq56.js";import{i as S}from"./chunk-SQIAVXJX-CJKqvBGK.js";import{s as ge,l as he}from"./chunk-C3QHEOC2-DX-XTqVl.js";import{t as U}from"./chunk-WEIB4WXA-BHDciMwJ.js";import{s as Q}from"./chunk-I3A4XRYQ-DJ5kH-TN.js";import{m as fe}from"./chunk-5LXTSPS7-BNCUyN4Z.js";import"./index-zleLmW-F.js";import"./index-Dj2uZsLI.js";import"./useListState-DDHPv_Kn.js";import"./useLabel-FUFqMuRp.js";import"./chunk-ICU6NNET-lVXZrmBV.js";import"./index-D22UnKTq.js";import"./useToggleState-kTS7RoNn.js";async function Ee(i){return(i.headers.get("content-type")??"").includes("application/json")?i.json():null}async function _(i,n,g={}){const t=new Headers(g.headers??{});t.has("Accept")||t.set("Accept","application/json"),typeof g.body<"u"&&g.body!==null&&!t.has("Content-Type")&&t.set("Content-Type","application/json"),t.set("Authorization",`Bearer ${n}`);const v=await fetch(`${Le}${i}`,{...g,headers:t}),h=await Ee(v);if(!v.ok){const O=typeof h=="object"&&h!==null&&"message"in h&&typeof h.message=="string"?h.message:"Request failed.";throw new k(O,v.status,h)}return h}async function Ie(i,n){return _(`/assistant-services?assistant_id=${n}`,i,{method:"GET"})}async function qe(i,n){return _(`/assistant-products?assistant_id=${n}`,i,{method:"GET"})}async function Fe(i,n){return _("/assistant-services",i,{method:"POST",body:JSON.stringify(n)})}async function Ve(i,n,g){return _(`/assistant-services/${n}`,i,{method:"PUT",body:JSON.stringify(g)})}async function De(i,n){return _(`/assistant-services/${n}`,i,{method:"DELETE"})}async function Me(i,n){return _("/assistant-products",i,{method:"POST",body:JSON.stringify(n)})}async function Be(i,n,g){return _(`/assistant-products/${n}`,i,{method:"PUT",body:JSON.stringify(g)})}async function Je(i,n){return _(`/assistant-products/${n}`,i,{method:"DELETE"})}const P="TJS",xe=[{key:"TJS",label:"TJS"},{key:"USD",label:"USD"},{key:"EUR",label:"EUR"},{key:"RUB",label:"RUB"},{key:"UZS",label:"UZS"},{key:"KZT",label:"KZT"}];function je(i,n,g){return new Intl.NumberFormat(g==="ru"?"ru-RU":"en-US",{minimumFractionDigits:0,maximumFractionDigits:2}).format(i)+` ${n}`}function be(i){return i.trim()===""?[]:i.split(`
`).map(n=>n.trim()).filter(Boolean)}function Z(i){return i?{name:i.name,description:i.description??"",terms:i.terms_conditions??"",price:String(i.price),currency:i.currency,photoUrls:(i.photo_urls??[]).join(`
`),specialists:(i.specialists??[]).map(n=>({name:n.name,price:String(n.price)})),isActive:i.is_active}:{name:"",description:"",terms:"",price:"",currency:P,photoUrls:"",specialists:[],isActive:!0}}function G(i){return i?{name:i.name,sku:i.sku??"",description:i.description??"",terms:i.terms_conditions??"",price:String(i.price),currency:i.currency,productUrl:i.product_url??"",photoUrls:(i.photo_urls??[]).join(`
`),isUnlimitedStock:i.is_unlimited_stock,stockQuantity:i.stock_quantity!==null?String(i.stock_quantity):"",isActive:i.is_active}:{name:"",sku:"",description:"",terms:"",price:"",currency:P,productUrl:"",photoUrls:"",isUnlimitedStock:!0,stockQuantity:"",isActive:!0}}function ms(){const{user:i,logout:n}=Ae(),{locale:g,messages:t}=Te(),v=re(),h=re(),[O,Y]=d.useState(!1),[ye,z]=d.useState(!0),[ve,H]=d.useState(!1),[W,L]=d.useState(!1),[X,ee]=d.useState(!1),[A,Ne]=d.useState([]),[p,$]=d.useState(null),[E,I]=d.useState([]),[q,F]=d.useState([]),[se,r]=d.useState(null),[te,y]=d.useState(null),[V,ae]=d.useState(null),[D,ie]=d.useState(null),[m,j]=d.useState(Z(null)),[c,b]=d.useState(G(null));ze({title:`${t.catalog.title} | ${t.app.name}`,description:t.catalog.subtitle,locale:g});const M=d.useMemo(()=>A.find(s=>s.id===p)??null,[A,p]),Se=async()=>{Y(!0);try{await n()}finally{Y(!1)}},le=d.useCallback(async()=>{const s=C();if(!s){r(t.catalog.unauthorized),z(!1);return}z(!0),r(null);try{const a=await Oe(s);Ne(a.assistants),$(l=>l&&a.assistants.some(u=>u.id===l)?l:null)}catch(a){r(a instanceof k?a.message:t.catalog.loadAssistantsFailed)}finally{z(!1)}},[t.catalog.loadAssistantsFailed,t.catalog.unauthorized]),w=d.useCallback(async s=>{const a=C();if(!a){r(t.catalog.unauthorized);return}H(!0),r(null);try{const[l,u]=await Promise.all([Ie(a,s),qe(a,s)]);I(l.services),F(u.products)}catch(l){r(l instanceof k?l.message:t.catalog.loadCatalogFailed)}finally{H(!1)}},[t.catalog.loadCatalogFailed,t.catalog.unauthorized]);d.useEffect(()=>{le()},[le]),d.useEffect(()=>{if(!p){I([]),F([]);return}w(p)},[w,p]);const _e=async()=>{if(!p)return;const s=C();if(!s){r(t.catalog.unauthorized);return}const a=m.name.trim(),l=Number(m.price);if(a.length<2){r(t.catalog.validationName);return}if(Number.isNaN(l)||l<0){r(t.catalog.validationPrice);return}const u=[];for(const o of m.specialists){const f=o.name.trim(),B=o.price.trim();if(f===""&&B==="")continue;if(f.length<2){r(t.catalog.validationSpecialistName);return}if(B===""){u.push({name:f,price:l});continue}const J=Number(B);if(Number.isNaN(J)||J<0){r(t.catalog.validationSpecialistPrice);return}u.push({name:f,price:J})}L(!0),r(null),y(null);try{const o={assistant_id:p,name:a,description:m.description.trim(),terms_conditions:m.terms.trim(),price:l,currency:m.currency.trim().toUpperCase()||P,photo_urls:be(m.photoUrls),specialists:u,is_active:m.isActive};V?(await Ve(s,V.id,o),y(t.catalog.serviceUpdated)):(await Fe(s,o),y(t.catalog.serviceCreated)),await w(p),v.onClose()}catch(o){r(o instanceof k?o.message:t.catalog.saveFailed)}finally{L(!1)}},ke=async()=>{if(!p)return;const s=C();if(!s){r(t.catalog.unauthorized);return}const a=c.name.trim(),l=Number(c.price),u=Number(c.stockQuantity),o=c.productUrl.trim();if(a.length<2){r(t.catalog.validationName);return}if(Number.isNaN(l)||l<0){r(t.catalog.validationPrice);return}if(!c.isUnlimitedStock&&(Number.isNaN(u)||u<0)){r(t.catalog.validationStock);return}if(o!=="")try{new URL(o)}catch{r(t.catalog.validationProductLink);return}L(!0),r(null),y(null);try{const f={assistant_id:p,name:a,sku:c.sku.trim(),description:c.description.trim(),terms_conditions:c.terms.trim(),price:l,currency:c.currency.trim().toUpperCase()||P,product_url:o===""?void 0:o,photo_urls:be(c.photoUrls),is_unlimited_stock:c.isUnlimitedStock,stock_quantity:c.isUnlimitedStock?void 0:Math.floor(u),is_active:c.isActive};D?(await Be(s,D.id,f),y(t.catalog.productUpdated)):(await Me(s,f),y(t.catalog.productCreated)),await w(p),h.onClose()}catch(f){r(f instanceof k?f.message:t.catalog.saveFailed)}finally{L(!1)}},we=async s=>{if(!p)return;const a=C();if(!a){r(t.catalog.unauthorized);return}r(null),y(null);try{await De(a,s),y(t.catalog.serviceDeleted),await w(p)}catch(l){r(l instanceof k?l.message:t.catalog.deleteFailed)}},Ce=async s=>{if(!p)return;const a=C();if(!a){r(t.catalog.unauthorized);return}r(null),y(null);try{await Je(a,s),y(t.catalog.productDeleted),await w(p)}catch(l){r(l instanceof k?l.message:t.catalog.deleteFailed)}},Ue=s=>{$(s),ee(!0)},Pe=()=>{$(null),I([]),F([]),ee(!1),r(null),y(null)};return e.jsxs(Re,{title:t.catalog.title,user:i,onLogout:Se,isLoggingOut:O,defaultSelectedKey:"products-services",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-default-500",children:t.catalog.subtitle}),se?e.jsx(ue,{color:"danger",variant:"faded",title:t.catalog.errorTitle,description:se}):null,te?e.jsx(ue,{color:"success",variant:"faded",title:t.catalog.successTitle,description:te}):null,e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[320px_minmax(0,1fr)]",children:[e.jsx(T,{shadow:"none",className:`border border-default-200 bg-white ${X?"hidden lg:flex":"flex"}`,children:e.jsxs(R,{className:"gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold",children:t.catalog.assistantsTitle}),e.jsx("p",{className:"text-sm text-default-500",children:t.catalog.assistantsSubtitle})]}),ye?e.jsx("div",{className:"flex min-h-[160px] items-center justify-center",children:e.jsx(ne,{size:"sm"})}):A.length===0?e.jsx("p",{className:"text-sm text-default-500",children:t.catalog.noAssistants}):e.jsx("div",{className:"space-y-2",children:A.map(s=>e.jsxs("button",{type:"button",onClick:()=>{Ue(s.id)},className:`w-full rounded-large border px-3 py-2 text-left transition ${p===s.id?"border-primary bg-primary-50":"border-default-200 bg-white hover:bg-default-100"}`,children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),e.jsxs("p",{className:"text-xs text-default-500",children:["ID: ",s.id]})]},s.id))})]})}),e.jsx(T,{shadow:"none",className:`border border-default-200 bg-white ${X?"flex":"hidden lg:flex"}`,children:e.jsx(R,{children:M?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{isIconOnly:!0,size:"sm",variant:"light",onPress:Pe,"aria-label":t.catalog.backToAssistants,children:e.jsx(N,{icon:"solar:alt-arrow-left-linear",width:18})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:M.name}),e.jsxs("p",{className:"text-sm text-default-500",children:[t.catalog.selectedAssistantPrefix," #",M.id]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{size:"sm",variant:"flat",startContent:e.jsx(N,{icon:"solar:add-circle-linear",width:16}),onPress:()=>{ae(null),j(Z(null)),v.onOpen()},children:t.catalog.addService}),e.jsx(x,{size:"sm",color:"primary",variant:"flat",startContent:e.jsx(N,{icon:"solar:add-circle-linear",width:16}),onPress:()=>{ie(null),b(G(null)),h.onOpen()},children:t.catalog.addProduct})]})]}),ve?e.jsx("div",{className:"flex min-h-[220px] items-center justify-center",children:e.jsx(ne,{size:"sm"})}):e.jsxs($e,{radius:"full",size:"sm",variant:"bordered",children:[e.jsx(me,{title:`${t.catalog.servicesTab} (${E.length})`,children:E.length===0?e.jsx("p",{className:"py-4 text-sm text-default-500",children:t.catalog.emptyServices}):e.jsx("div",{className:"grid gap-3 py-1",children:E.map(s=>e.jsx(T,{shadow:"none",className:"border border-default-200",children:e.jsxs(R,{className:"gap-2 p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),e.jsx("p",{className:"text-xs text-default-600",children:je(s.price,s.currency,g)}),s.specialists.length>0?e.jsxs("p",{className:"text-xs text-default-500",children:[t.catalog.specialistsTitle,": ",s.specialists.length]}):null]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{size:"sm",variant:"flat",color:s.is_active?"success":"default",children:s.is_active?t.catalog.statusActive:t.catalog.statusInactive}),e.jsx(x,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{ae(s),j(Z(s)),v.onOpen()},children:e.jsx(N,{icon:"solar:pen-new-square-linear",width:18})}),e.jsx(x,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>{we(s.id)},children:e.jsx(N,{icon:"solar:trash-bin-trash-linear",width:18})})]})]}),s.description?e.jsx("p",{className:"line-clamp-2 text-xs text-default-500",children:s.description}):null,s.specialists.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.specialists.slice(0,4).map((a,l)=>e.jsx(K,{size:"sm",variant:"flat",children:a.name},`${a.name}-${l}`))}):null]})},s.id))})},"services"),e.jsx(me,{title:`${t.catalog.productsTab} (${q.length})`,children:q.length===0?e.jsx("p",{className:"py-4 text-sm text-default-500",children:t.catalog.emptyProducts}):e.jsx("div",{className:"grid gap-3 py-1",children:q.map(s=>e.jsx(T,{shadow:"none",className:"border border-default-200",children:e.jsxs(R,{className:"gap-2 p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),e.jsx("p",{className:"text-xs text-default-600",children:je(s.price,s.currency,g)}),s.sku?e.jsxs("p",{className:"text-xs text-default-500",children:["SKU: ",s.sku]}):null]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{size:"sm",variant:"flat",color:s.is_active?"success":"default",children:s.is_active?t.catalog.statusActive:t.catalog.statusInactive}),e.jsx(x,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{ie(s),b(G(s)),h.onOpen()},children:e.jsx(N,{icon:"solar:pen-new-square-linear",width:18})}),e.jsx(x,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>{Ce(s.id)},children:e.jsx(N,{icon:"solar:trash-bin-trash-linear",width:18})})]})]}),e.jsx("p",{className:"text-xs text-default-500",children:s.is_unlimited_stock?t.catalog.unlimitedStock:`${t.catalog.stockLabel}: ${s.stock_quantity??0}`}),s.product_url?e.jsx(x,{as:"a",href:s.product_url,target:"_blank",rel:"noopener noreferrer",size:"sm",variant:"light",className:"justify-start px-0",startContent:e.jsx(N,{icon:"solar:link-minimalistic-2-linear",width:16}),children:t.catalog.openProductLink}):null]})},s.id))})},"products")]})]}):e.jsx("div",{className:"flex min-h-[280px] items-center justify-center rounded-large border border-dashed border-default-300 bg-default-50 text-sm text-default-500",children:t.catalog.selectAssistant})})})]})]}),e.jsx(ce,{isOpen:v.isOpen,onOpenChange:v.onOpenChange,size:"2xl",children:e.jsxs(oe,{children:[e.jsx(pe,{children:V?t.catalog.editServiceTitle:t.catalog.newServiceTitle}),e.jsxs(de,{className:"gap-3",children:[e.jsx(S,{label:t.catalog.nameLabel,value:m.name,onValueChange:s=>{j(a=>({...a,name:s}))}}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsx(S,{label:t.catalog.priceLabel,value:m.price,onValueChange:s=>{j(a=>({...a,price:s}))}}),e.jsx(ge,{label:t.catalog.currencyLabel,selectedKeys:[m.currency],onSelectionChange:s=>{const a=String(Array.from(s)[0]??P);j(l=>({...l,currency:a}))},children:xe.map(s=>e.jsx(he,{children:s.label},s.key))})]}),e.jsx(U,{label:t.catalog.descriptionLabel,value:m.description,onValueChange:s=>{j(a=>({...a,description:s}))},minRows:2}),e.jsx(U,{label:t.catalog.termsLabel,value:m.terms,onValueChange:s=>{j(a=>({...a,terms:s}))},minRows:2}),e.jsx(U,{label:t.catalog.photoUrlsLabel,value:m.photoUrls,onValueChange:s=>{j(a=>({...a,photoUrls:s}))},minRows:2}),e.jsxs("div",{className:"space-y-2 rounded-large border border-default-200 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-sm font-semibold",children:t.catalog.specialistsTitle}),e.jsx(x,{size:"sm",variant:"flat",startContent:e.jsx(N,{icon:"solar:add-circle-linear",width:16}),onPress:()=>{j(s=>({...s,specialists:[...s.specialists,{name:"",price:""}]}))},children:t.catalog.addSpecialist})]}),m.specialists.length===0?e.jsx("p",{className:"text-xs text-default-500",children:t.catalog.noSpecialists}):e.jsx("div",{className:"space-y-2",children:m.specialists.map((s,a)=>e.jsxs("div",{className:"grid grid-cols-[1fr,1fr,40px] gap-2",children:[e.jsx(S,{label:t.catalog.specialistNameLabel,value:s.name,onValueChange:l=>{j(u=>({...u,specialists:u.specialists.map((o,f)=>f===a?{...o,name:l}:o)}))}}),e.jsx(S,{label:t.catalog.specialistPriceLabel,value:s.price,onValueChange:l=>{j(u=>({...u,specialists:u.specialists.map((o,f)=>f===a?{...o,price:l}:o)}))}}),e.jsx(x,{isIconOnly:!0,color:"danger",variant:"light",className:"self-end",onPress:()=>{j(l=>({...l,specialists:l.specialists.filter((u,o)=>o!==a)}))},children:e.jsx(N,{icon:"solar:trash-bin-trash-linear",width:18})})]},`specialist-${a}`))})]}),e.jsx(Q,{isSelected:m.isActive,onValueChange:s=>{j(a=>({...a,isActive:s}))},children:t.catalog.activeLabel})]}),e.jsxs(fe,{children:[e.jsx(x,{variant:"light",onPress:v.onClose,children:t.common.cancel}),e.jsx(x,{color:"primary",onPress:()=>{_e()},isLoading:W,children:t.catalog.saveButton})]})]})}),e.jsx(ce,{isOpen:h.isOpen,onOpenChange:h.onOpenChange,size:"2xl",children:e.jsxs(oe,{children:[e.jsx(pe,{children:D?t.catalog.editProductTitle:t.catalog.newProductTitle}),e.jsxs(de,{className:"gap-3",children:[e.jsx(S,{label:t.catalog.nameLabel,value:c.name,onValueChange:s=>{b(a=>({...a,name:s}))}}),e.jsx(S,{label:t.catalog.skuLabel,value:c.sku,onValueChange:s=>{b(a=>({...a,sku:s}))}}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsx(S,{label:t.catalog.priceLabel,value:c.price,onValueChange:s=>{b(a=>({...a,price:s}))}}),e.jsx(ge,{label:t.catalog.currencyLabel,selectedKeys:[c.currency],onSelectionChange:s=>{const a=String(Array.from(s)[0]??P);b(l=>({...l,currency:a}))},children:xe.map(s=>e.jsx(he,{children:s.label},s.key))})]}),e.jsx(S,{label:t.catalog.productLinkLabel,value:c.productUrl,onValueChange:s=>{b(a=>({...a,productUrl:s}))}}),e.jsx(Q,{isSelected:c.isUnlimitedStock,onValueChange:s=>{b(a=>({...a,isUnlimitedStock:s}))},children:t.catalog.unlimitedStockLabel}),c.isUnlimitedStock?null:e.jsx(S,{label:t.catalog.stockLabel,value:c.stockQuantity,onValueChange:s=>{b(a=>({...a,stockQuantity:s}))}}),e.jsx(U,{label:t.catalog.descriptionLabel,value:c.description,onValueChange:s=>{b(a=>({...a,description:s}))},minRows:2}),e.jsx(U,{label:t.catalog.termsLabel,value:c.terms,onValueChange:s=>{b(a=>({...a,terms:s}))},minRows:2}),e.jsx(U,{label:t.catalog.photoUrlsLabel,value:c.photoUrls,onValueChange:s=>{b(a=>({...a,photoUrls:s}))},minRows:2}),e.jsx(Q,{isSelected:c.isActive,onValueChange:s=>{b(a=>({...a,isActive:s}))},children:t.catalog.activeLabel})]}),e.jsxs(fe,{children:[e.jsx(x,{variant:"light",onPress:h.onClose,children:t.common.cancel}),e.jsx(x,{color:"primary",onPress:()=>{ke()},isLoading:W,children:t.catalog.saveButton})]})]})})]})}export{ms as default};
