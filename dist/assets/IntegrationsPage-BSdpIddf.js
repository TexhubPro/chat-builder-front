import{B as fe,A as x,l as he,n as pe,g as xe,k as be,r as i,C as j,j as t,z as te}from"./index-CzVjE_R5.js";import{D as ye,v as q,w as R,B as je,I as K,x as ve,y as _e,z as Ne}from"./DashboardLayout-CPKyjStX.js";import{b as we,c as k}from"./usePageSeo-CMtUVRUy.js";import{a as Ce}from"./chunk-VF35X3H6-Bm_P2K1X.js";import{c as T}from"./chunk-EIRINNCE-CB0dTtTa.js";import{s as ke}from"./chunk-I3A4XRYQ-bzHMCli8.js";import{d as Te}from"./index-D4ADvH-F.js";import{m as ze,a as Ae}from"./chunk-R7OT77UN-HKOY1R12.js";import{i as Se}from"./chunk-SQIAVXJX-BoEOq7fl.js";import"./index-BY8MoOwp.js";import"./useLabel-Ba2qxKBx.js";import"./useToggleState-C5z9MN-8.js";import"./chunk-ICU6NNET-C9LXNIYq.js";async function $e(u){return(u.headers.get("content-type")??"").includes("application/json")?u.json():null}async function z(u,d,m={}){const e=new Headers(m.headers??{});e.has("Accept")||e.set("Accept","application/json"),typeof m.body<"u"&&m.body!==null&&!e.has("Content-Type")&&e.set("Content-Type","application/json"),e.set("Authorization",`Bearer ${d}`);const b=await fetch(`${fe}${u}`,{...m,headers:e}),f=await $e(b);if(!b.ok){const F=typeof f=="object"&&f!==null&&"message"in f&&typeof f.message=="string"?f.message:"Request failed.";throw new x(F,b.status,f)}return f}async function se(u,d){const m=typeof d=="number"?`?assistant_id=${d}`:"";return z(`/assistant-channels${m}`,u,{method:"GET"})}async function De(u,d,m,e){return z(`/assistant-channels/${d}/${m}`,u,{method:"PATCH",body:JSON.stringify({enabled:e})})}async function Le(u,d,m){return z(`/assistant-channels/${d}/${m}`,u,{method:"DELETE"})}async function Fe(u,d){return z(`/assistant-channels/${d}/instagram/connect`,u,{method:"POST"})}async function Pe(u,d,m){return z(`/assistant-channels/${d}/telegram/connect`,u,{method:"POST",body:JSON.stringify({bot_token:m})})}function Ee(u){const d=(u??"").trim();if(d==="")return"?";const m=d.split(/\s+/u).filter(Boolean),e=m[0]?.[0]??"",b=m[1]?.[0]??"",f=`${e}${b}`.trim().toUpperCase();return f===""?d.slice(0,1).toUpperCase():f}function Qe(){const{user:u,logout:d}=he(),{locale:m,messages:e}=pe(),b=xe(),[f]=be(),[F,U]=i.useState(!1),[P,W]=i.useState(!0),[ne,J]=i.useState(!1),[G,E]=i.useState(!1),[A,H]=i.useState([]),[c,v]=i.useState(null),[_,p]=i.useState([]),[S,N]=i.useState(null),[ae,y]=i.useState({}),[ie,O]=i.useState(!1),[B,$]=i.useState(""),[D,V]=i.useState(!1),[Q,o]=i.useState(null),w=i.useMemo(()=>{const s=f.get("assistant_id");if(!s)return null;const n=Number.parseInt(s,10);return!Number.isFinite(n)||n<=0?null:n},[f]),I=f.get("instagram_status"),C=f.get("instagram_error");we({title:`${e.integrations.title} | ${e.app.name}`,description:e.integrations.subtitle,locale:m});const M=i.useMemo(()=>c!==null?A.find(s=>s.id===c)??null:null,[A,c]),re=i.useMemo(()=>({instagram:{title:e.integrations.channelInstagram,description:e.integrations.channelInstagramDescription,icon:"solar:instagram-linear",iconClass:"bg-pink-100 text-pink-600"},telegram:{title:e.integrations.channelTelegram,description:e.integrations.channelTelegramDescription,icon:"solar:plain-2-linear",iconClass:"bg-blue-100 text-blue-600"},widget:{title:e.integrations.channelWidget,description:e.integrations.channelWidgetDescription,icon:"solar:widget-2-outline",iconClass:"bg-violet-100 text-violet-600"},api:{title:e.integrations.channelApi,description:e.integrations.channelApiDescription,icon:"solar:code-square-linear",iconClass:"bg-emerald-100 text-emerald-600"}}),[e.integrations.channelApi,e.integrations.channelApiDescription,e.integrations.channelInstagram,e.integrations.channelInstagramDescription,e.integrations.channelTelegram,e.integrations.channelTelegramDescription,e.integrations.channelWidget,e.integrations.channelWidgetDescription]),le=async()=>{U(!0);try{await d()}finally{U(!1)}},X=i.useCallback(async()=>{const s=j();if(!s){o(e.integrations.unauthorized);return}W(!0);try{const n=await se(s);H(n.assistants),N(n.limits),p([]),v(null)}catch(n){n instanceof x&&n.status===401?o(e.integrations.unauthorized):o(n instanceof x?n.message:e.integrations.loadFailed)}finally{W(!1)}},[e.integrations.loadFailed,e.integrations.unauthorized]),L=i.useCallback(async s=>{const n=j();if(!n){o(e.integrations.unauthorized);return}J(!0);try{const a=await se(n,s);H(a.assistants),N(a.limits),p(a.channels),v(a.selected_assistant_id??s)}catch(a){a instanceof x&&a.status===401?o(e.integrations.unauthorized):o(a instanceof x?a.message:e.integrations.loadFailed)}finally{J(!1)}},[e.integrations.loadFailed,e.integrations.unauthorized]);i.useEffect(()=>{X()},[X]),i.useEffect(()=>{P||!(I!==null||C!==null||w!==null)||(C&&C.trim()!==""?o(C):o(null),I==="connected"&&w!==null&&(v(w),E(!0),L(w)),b("/integrations",{replace:!0}))},[w,C,I,P,L,b]);const oe=i.useCallback(s=>{o(null),v(s),E(!0),L(s)},[L]),ce=i.useCallback(()=>{v(null),p([]),E(!1),o(null)},[]),Y=i.useCallback(async(s,n)=>{if(!c)return;const a=j();if(!a){o(e.integrations.unauthorized);return}const g=`${c}:${s}`,r=_;y(l=>({...l,[g]:!0})),o(null),p(l=>l.map(h=>h.channel===s?{...h,is_connected:n?!0:h.is_connected,is_active:n}:h));try{const l=await De(a,c,s,n);p(h=>h.map(ee=>ee.channel===s?l.channel:ee)),N(l.limits)}catch(l){p(r),o(l instanceof x?l.message:e.integrations.updateFailed)}finally{y(l=>{const h={...l};return delete h[g],h})}},[_,e.integrations.unauthorized,e.integrations.updateFailed,c]),de=i.useCallback(async s=>{if(!c)return;const n=j();if(!n){o(e.integrations.unauthorized);return}const a=`${c}:${s}`,g=_;y(r=>({...r,[a]:!0})),o(null),p(r=>r.map(l=>l.channel===s?{...l,id:null,assistant_id:null,name:null,external_account_id:null,is_connected:!1,is_active:!1,settings:{},metadata:{},updated_at:null}:l));try{const r=await Le(n,c,s);p(l=>l.map(h=>h.channel===s?r.channel:h)),N(r.limits)}catch(r){p(g),o(r instanceof x?r.message:e.integrations.updateFailed)}finally{y(r=>{const l={...r};return delete l[a],l})}},[_,e.integrations.unauthorized,e.integrations.updateFailed,c]),ue=i.useCallback(async()=>{if(!c)return;const s=j();if(!s){o(e.integrations.unauthorized);return}const n=`${c}:instagram`;y(a=>({...a,[n]:!0})),o(null);try{const a=await Fe(s,c);if(!a.authorization_url)throw new Error(e.integrations.updateFailed);window.location.assign(a.authorization_url)}catch(a){o(a instanceof x||a instanceof Error?a.message:e.integrations.updateFailed),y(g=>{const r={...g};return delete r[n],r})}},[e.integrations.unauthorized,e.integrations.updateFailed,c]),ge=i.useCallback(()=>{$(""),O(!0)},[]),Z=i.useCallback(()=>{D||(O(!1),$(""))},[D]),me=i.useCallback(async()=>{if(!c)return;const s=B.trim();if(s===""){o(e.integrations.telegramTokenRequired);return}const n=j();if(!n){o(e.integrations.unauthorized);return}const a=`${c}:telegram`;y(g=>({...g,[a]:!0})),V(!0),o(null);try{const g=await Pe(n,c,s);p(r=>r.map(l=>l.channel==="telegram"?g.channel:l)),N(g.limits),O(!1),$("")}catch(g){o(g instanceof x?g.message:e.integrations.updateFailed)}finally{V(!1),y(g=>{const r={...g};return delete r[a],r})}},[e.integrations.telegramTokenRequired,e.integrations.unauthorized,e.integrations.updateFailed,c,B]);return t.jsxs(ye,{title:e.integrations.title,user:u,onLogout:le,isLoggingOut:F,defaultSelectedKey:"integrations",children:[t.jsxs("div",{className:"space-y-4",children:[Q?t.jsx(Ce,{color:"danger",variant:"faded",title:e.integrations.errorTitle,description:Q}):null,t.jsxs("div",{className:"grid gap-4 lg:grid-cols-[340px_minmax(0,1fr)]",children:[t.jsx(q,{shadow:"none",className:`border border-default-200 bg-white ${G?"hidden lg:flex":"flex"}`,children:t.jsxs(R,{className:"space-y-4 p-4 sm:p-5",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.assistantsTitle}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.assistantsSubtitle})]}),P?t.jsx("div",{className:"flex items-center justify-center py-10",children:t.jsx(te,{size:"sm",label:e.integrations.loadingAssistants})}):A.length===0?t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.noAssistants}):t.jsx("div",{className:"space-y-2",children:A.map(s=>{const n=s.id===c;return t.jsx("button",{type:"button",onClick:()=>{oe(s.id)},className:`w-full rounded-large border px-3 py-3 text-left transition ${n?"border-primary-300 bg-primary-50":"border-default-200 bg-white hover:border-default-300 hover:bg-default-50"}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(je,{name:s.name,showFallback:!0,fallback:t.jsx("span",{className:"text-xs font-semibold text-default-700",children:Ee(s.name)}),className:"h-10 w-10 shrink-0"}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.name}),t.jsx(T,{size:"sm",variant:"flat",color:s.is_active?"success":"default",className:"mt-1",children:s.is_active?e.integrations.assistantRunning:e.integrations.assistantStopped})]})]})},s.id)})})]})}),t.jsx(q,{shadow:"none",className:`border border-default-200 bg-white ${G?"flex":"hidden lg:flex"}`,children:t.jsx(R,{className:"p-0",children:M?t.jsxs("div",{className:"flex h-full flex-col",children:[t.jsxs("div",{className:"space-y-3 border-b border-default-200 px-4 py-4 sm:px-5",children:[t.jsx("div",{className:"flex items-center justify-between gap-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(k,{isIconOnly:!0,size:"sm",variant:"light",onPress:ce,"aria-label":e.integrations.backToAssistants,children:t.jsx(K,{icon:"solar:alt-arrow-left-linear",width:18})}),t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.channelsTitle})]})}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.channelsSubtitle}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx(T,{size:"sm",variant:"flat",color:"primary",children:M.name}),t.jsxs(T,{size:"sm",variant:"flat",color:"default",children:[e.integrations.activeIntegrationsLabel,":"," ",S?.active_integrations??0]}),t.jsxs(T,{size:"sm",variant:"flat",color:"default",children:[e.integrations.integrationLimitLabel,":"," ",S?.integrations_per_channel_limit??0]})]})]}),ne?t.jsx("div",{className:"flex flex-1 items-center justify-center py-14",children:t.jsx(te,{size:"sm",label:e.integrations.loadingChannels})}):t.jsx("div",{className:"grid gap-3 p-4 sm:grid-cols-2 sm:p-5",children:_.map(s=>{const n=s.channel,a=re[n],g=`${M.id}:${s.channel}`,r=!!ae[g],l=s.external_account_id??s.name??null;return t.jsx(q,{shadow:"none",className:"border border-default-200 bg-default-50",children:t.jsxs(R,{className:"space-y-3 p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:`flex h-11 w-11 shrink-0 items-center justify-center rounded-full ${a?.iconClass??"bg-default-200 text-default-700"}`,children:t.jsx(K,{icon:a?.icon??"solar:link-linear",width:22})}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-base font-semibold text-foreground",children:a?.title??s.channel}),t.jsx("p",{className:"text-sm text-default-500",children:a?.description??""})]})]}),t.jsx(ke,{size:"sm",isSelected:s.is_connected&&s.is_active,isDisabled:r||!S?.has_active_subscription||!s.is_connected,onValueChange:h=>{Y(n,h)},"aria-label":e.integrations.toggleLabel})]}),t.jsx(Te,{}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(T,{size:"sm",variant:"flat",color:s.is_active?"success":"default",children:s.is_active?e.integrations.statusEnabled:e.integrations.statusDisabled}),t.jsxs("p",{className:"text-xs text-default-500",children:[e.integrations.accountLabel,":"," ",t.jsx("span",{className:"text-default-700",children:l??e.integrations.noConnection})]})]}),s.is_connected?t.jsx(k,{color:"danger",variant:"solid",className:"w-full",onPress:()=>{de(n)},isLoading:r,children:e.integrations.disconnectButton}):t.jsx(k,{color:"primary",variant:"solid",className:"w-full",onPress:()=>{if(n==="instagram"){ue();return}if(n==="telegram"){ge();return}Y(n,!0)},isLoading:r,isDisabled:!S?.has_active_subscription,children:e.integrations.connectButton})]})},s.channel)})})]}):t.jsx("div",{className:"flex h-[calc(100vh-220px)] items-center justify-center px-6",children:t.jsxs("div",{className:"max-w-md space-y-2 text-center",children:[t.jsx(K,{icon:"solar:link-circle-linear",width:36,className:"mx-auto text-default-400"}),t.jsx("p",{className:"text-base font-semibold text-foreground",children:e.integrations.selectAssistantTitle}),t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.selectAssistantDescription})]})})})})]})]}),t.jsx(ve,{isOpen:ie,onOpenChange:s=>{s||Z()},children:t.jsxs(_e,{children:[t.jsx(ze,{children:e.integrations.telegramTokenModalTitle}),t.jsxs(Ne,{className:"space-y-3",children:[t.jsx("p",{className:"text-sm text-default-500",children:e.integrations.telegramTokenModalDescription}),t.jsx(Se,{autoFocus:!0,type:"password",label:e.integrations.telegramTokenLabel,placeholder:e.integrations.telegramTokenPlaceholder,value:B,onValueChange:$,autoComplete:"off"})]}),t.jsxs(Ae,{children:[t.jsx(k,{variant:"light",onPress:Z,isDisabled:D,children:e.common.cancel}),t.jsx(k,{color:"primary",onPress:()=>{me()},isLoading:D,children:e.integrations.connectButton})]})]})})]})}export{Qe as default};
