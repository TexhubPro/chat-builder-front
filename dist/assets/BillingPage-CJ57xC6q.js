import{t as De,A as me,l as Le,n as Ae,r as o,j as e,q}from"./index-BYGw2tT-.js";import{D as Fe,m as $e,d as Re,e as Oe,c as F,b as $,I as g}from"./DashboardLayout-B0b3pDXt.js";import{b as ze,d as _,c as de}from"./usePageSeo-Dj1hqvkY.js";import{p as Ee}from"./chunk-VFIJPDYX-DqT7_1pe.js";import{t as Ue,a as G}from"./chunk-ML27DD5T-CVUDbhZ1.js";import{m as Be}from"./chunk-R7OT77UN-Dr5yURyW.js";import{m as Me}from"./chunk-5LXTSPS7-BWiIBxNe.js";import{c as W}from"./chunk-EIRINNCE-D4yIvY_2.js";import"./index-B3eHIZ_o.js";import"./useLabel-ceVddHEZ.js";import"./useListState-CsLScgQT.js";async function qe(s){return(s.headers.get("content-type")??"").includes("application/json")?s.json():null}async function k(s,i,n={}){const t=new Headers(n.headers??{});t.has("Accept")||t.set("Accept","application/json"),typeof n.body<"u"&&n.body!==null&&!t.has("Content-Type")&&t.set("Content-Type","application/json"),t.set("Authorization",`Bearer ${i}`);const u=await fetch(`${De}${s}`,{...n,headers:t}),d=await qe(u);if(!u.ok){const l=typeof d=="object"&&d!==null&&"message"in d&&typeof d.message=="string"?d.message:"Request failed.";throw new me(l,u.status,d)}return d}async function Ge(s){return(await k("/billing/plans",s,{method:"GET"})).plans}async function We(s){return k("/billing/subscription",s,{method:"GET"})}async function Je(s){return(await k("/billing/invoices",s,{method:"GET"})).invoices}async function Qe(s,i){return k("/billing/checkout",s,{method:"POST",body:JSON.stringify(i)})}async function Ve(s,i){return k(`/billing/invoices/${i}/pay`,s,{method:"POST"})}function He(s){return s===90?"90":s===180?"180":"30"}function h(s,i,n){const t=typeof s=="number"?s:Number(s);return Number.isFinite(t)?new Intl.NumberFormat(n==="ru"?"ru-RU":"en-US",{style:"currency",currency:i,maximumFractionDigits:2}).format(t):`${s} ${i}`}function J(s,i){if(!s)return"-";const n=new Date(s);return Number.isNaN(n.getTime())?"-":new Intl.DateTimeFormat(i==="ru"?"ru-RU":"en-US",{dateStyle:"medium"}).format(n)}function ue(s,i){return s<=0?i==="ru"?"30 дней":"30 days":i==="ru"?`${s} дней`:`${s} days`}function Xe(s){return s?s.included_chats<=0?s.used_chats>0?100:0:Math.max(0,Math.min(100,Math.round(s.used_chats/s.included_chats*100))):0}function Ye(s,i,n,t){if(!s||!i||!n||!t||n.status!=="active"||s.currency!==i.currency)return 0;const u=Math.max(t.included_chats,0),d=Math.max(t.used_chats,0),l=Math.max(u-d,0);if(u<=0||l<=0)return 0;const b=Number(i.price),m=Math.max(n.quantity,1);if(!Number.isFinite(b)||b<=0)return 0;const w=b*m*l/u;if(!Number.isFinite(w)||w<=0)return 0;const v=Number(s.price);return!Number.isFinite(v)||v<=0?0:Math.min(w,v)}function Ze(s,i,n){if(!s||!i||!n||i.status!=="active")return 0;const t=Math.max(n.included_chats,0),u=Math.max(n.used_chats,0),d=Math.max(t-u,0);if(t<=0||d<=0)return 0;const l=Number(s.price),b=Math.max(i.quantity,1);if(!Number.isFinite(l)||l<=0)return 0;const m=l*b*d/t;return!Number.isFinite(m)||m<=0?0:m}function Ke(s,i,n){if(!s||!i||!n||n.status!=="active"||s.code===i.code)return!1;const t=Math.max(s.billing_period_days/30,1),u=Math.max(i.billing_period_days/30,1),d=Number(s.price)/t,l=Number(i.price)/u,b=s.included_chats<i.included_chats||s.assistant_limit<i.assistant_limit||s.integrations_per_channel_limit<i.integrations_per_channel_limit,m=Number.isFinite(d)&&Number.isFinite(l)&&d<l;return b||m}function et(s){if(!s.features||typeof s.features!="object")return 0;const i=s.features.discount_percent,n=typeof i=="number"?i:Number(i);return!Number.isFinite(n)||n<=0?0:Math.round(n)}function tt(s,i){switch(s){case"active":return{label:i.statusActive,color:"success"};case"pending_payment":return{label:i.statusPendingPayment,color:"warning"};case"inactive":return{label:i.statusInactive,color:"default"};case"past_due":return{label:i.statusPastDue,color:"danger"};case"unpaid":return{label:i.statusUnpaid,color:"danger"};case"expired":return{label:i.statusExpired,color:"danger"};case"canceled":return{label:i.statusCanceled,color:"default"};default:return{label:i.statusUnknown,color:"default"}}}function st(s,i){switch(s){case"pending":return{label:i.statusPending,color:"warning"};case"paid":return{label:i.statusPaid,color:"success"};case"issued":return{label:i.statusIssued,color:"warning"};case"overdue":return{label:i.statusOverdue,color:"danger"};case"failed":return{label:i.statusFailed,color:"danger"};case"void":return{label:i.statusVoid,color:"default"};default:return{label:i.statusUnknown,color:"default"}}}function P(s,i){const n=s.trim().toLowerCase();return n==="checkout created. complete payment to activate subscription."?i.checkoutCreated:n==="payment completed successfully."?i.paymentCompleted:n==="payment session created. continue in alif."?i.paymentSessionCreated:n==="invoice is already paid."?i.paymentAlreadyCompleted:n==="unauthenticated."?i.unauthorized:s}function Q(s,i){return s instanceof me||s instanceof Error?P(s.message,i):i.loadFailed}function nt(s){return s==="issued"||s==="overdue"||s==="failed"}function it(s,i){const n=document.createElement("form");n.method="POST",n.action=s,n.style.display="none";for(const[t,u]of Object.entries(i)){const d=document.createElement("input");d.type="hidden",d.name=t,d.value=u,n.appendChild(d)}document.body.appendChild(n),n.submit()}function gt(){const{user:s,logout:i}=Le(),{locale:n,messages:t}=Ae(),[u,d]=o.useState([]),[l,b]=o.useState(null),[m,w]=o.useState(null),[v,fe]=o.useState([]),[S,R]=o.useState(""),[he,O]=o.useState(!0),[xe,V]=o.useState(!1),[T,H]=o.useState(!1),[X,Y]=o.useState(null),[pe,Z]=o.useState(!1),[z,E]=o.useState(!1),[ge,I]=o.useState(!1),[C,K]=o.useState("30"),[ee,x]=o.useState(null),[te,N]=o.useState(null);ze({title:`${t.billing.title} | ${t.app.name}`,description:t.billing.subtitle,locale:n});const D=async a=>{const c=q();if(!c){x(t.billing.unauthorized),O(!1);return}a?O(!0):V(!0);try{const[r,p,B]=await Promise.all([Ge(c),We(c),Je(c)]);d(r),b(p.subscription),w(p.usage),fe(B);const ke=p.subscription?.status==="active";E(j=>ke?j:!0);const M=p.subscription?.plan?.code,A=M&&r.some(j=>j.code===M)?M:r[0]?.code??"",Te=r.find(j=>j.code===A)??null,ce=He(Te?.billing_period_days),oe=r.filter(j=>String(j.billing_period_days)===ce),Ie=oe.some(j=>j.code===A)?A:oe[0]?.code??A;K(ce),R(Ie)}catch(r){x(Q(r,t.billing))}finally{O(!1),V(!1)}};o.useEffect(()=>{D(!0)},[]);const f=o.useMemo(()=>u.find(a=>a.code===S)??null,[u,S]),se=o.useMemo(()=>u.filter(a=>String(a.billing_period_days)===C),[u,C]),y=o.useMemo(()=>{const a=l?.plan?.code;if(a){const c=u.find(r=>r.code===a);if(c)return c}return f},[u,f,l?.plan?.code]),ne=o.useMemo(()=>Ze(y,l,m),[y,l,m]),U=o.useMemo(()=>Ye(f,y,l,m),[f,y,l,m]),ie=o.useMemo(()=>f?Math.max(ne-Number(f.price),0):0,[ne,f]),be=f?Math.max(Number(f.price)-U,0):0,ae=Xe(m),L=l?.status==="active",ye=!L||z,je=o.useMemo(()=>Ke(f,y,l),[f,y,l])&&ie>0,re=tt(l?.status,t.billing),ve=[{key:"included",icon:"solar:chat-line-linear",label:t.billing.includedChats,value:String(m?.included_chats??0)},{key:"used",icon:"solar:chat-round-dots-linear",label:t.billing.usedChats,value:String(m?.used_chats??0)},{key:"remaining",icon:"solar:clock-circle-linear",label:t.billing.remainingChats,value:String(m?.remaining_chats??0)},{key:"overage",icon:"solar:danger-triangle-linear",label:t.billing.overageChats,value:String(m?.overage_chats??0)},{key:"assistants",icon:"solar:users-group-rounded-linear",label:t.billing.assistantLimit,value:String(m?.assistant_limit??0)},{key:"integrations",icon:"solar:link-minimalistic-2-linear",label:t.billing.integrationLimit,value:String(m?.integrations_per_channel_limit??0)}],Ne=async()=>{Z(!0);try{await i()}finally{Z(!1)}},_e=async()=>{x(null),N(null),await D(!1)},le=async()=>{if(x(null),N(null),!S){x(t.billing.checkoutFailed);return}const a=q();if(!a){x(t.billing.unauthorized);return}H(!0);try{const c=await Qe(a,{plan_code:S,quantity:1});N(P(c.message,t.billing)),await D(!1)}catch(c){x(Q(c,t.billing))}finally{H(!1)}},we=async()=>{if(je){I(!0);return}await le()},Se=async()=>{I(!1),await le()},Ce=a=>{if(a!=="30"&&a!=="90"&&a!=="180")return;const c=a,r=u.filter(p=>String(p.billing_period_days)===c);K(c),R(p=>r.some(B=>B.code===p)?p:r[0]?.code??p)},Pe=async a=>{x(null),N(null);const c=q();if(!c){x(t.billing.unauthorized);return}Y(a);try{const r=await Ve(c,a);if(r.payment?.provider==="alifbank"&&r.payment.method==="post"&&r.payment.checkout_url){N(P(r.message,t.billing)),it(r.payment.checkout_url,r.payment.payload);return}N(P(r.message,t.billing)),E(!1),await D(!1)}catch(r){x(Q(r,t.billing))}finally{Y(null)}};return e.jsx(Fe,{title:t.billing.title,user:s,onLogout:Ne,isLoggingOut:pe,defaultSelectedKey:"billing",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx($e,{isOpen:ge,onOpenChange:I,placement:"center",children:e.jsxs(Re,{children:[e.jsx(Be,{children:t.billing.downgradeWarningTitle}),e.jsxs(Oe,{children:[e.jsx("p",{className:"text-sm text-default-700",children:t.billing.downgradeWarningDescription}),e.jsxs("p",{className:"text-sm font-semibold text-danger-600",children:[t.billing.downgradeWarningForfeit,":"," ",f?h(ie,f.currency,n):h("0","USD",n)]})]}),e.jsxs(Me,{children:[e.jsx(_,{variant:"light",onPress:()=>I(!1),isDisabled:T,children:t.billing.downgradeCancelButton}),e.jsx(_,{color:"danger",onPress:Se,isLoading:T,children:t.billing.downgradeConfirmButton})]})]})}),ee?e.jsx(de,{color:"danger",title:t.billing.errorTitle,description:ee,variant:"flat"}):null,te?e.jsx(de,{color:"success",title:t.billing.successTitle,description:te,variant:"flat"}):null,e.jsxs("div",{className:`grid grid-cols-1 gap-4 ${L?"xl:grid-cols-[minmax(0,1fr)_minmax(0,1fr)]":""}`,children:[L?e.jsx(F,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs($,{className:"space-y-3 p-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{children:e.jsx("p",{className:"text-sm font-medium text-default-500",children:t.billing.currentSubscriptionTitle})}),e.jsx(W,{size:"sm",color:re.color,variant:"flat",children:re.label})]}),e.jsxs("div",{className:"rounded-large bg-gradient-to-br from-indigo-600 via-violet-600 to-fuchsia-600 p-4 text-white",children:[e.jsxs("div",{className:"flex items-end justify-between gap-3",children:[e.jsx("div",{children:e.jsx("p",{className:"text-xl font-semibold",children:l?.plan?.name??"-"})}),e.jsx("p",{className:"text-xl font-bold",children:y?h(y.price,y.currency,n):h("0","TJS",n)})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-xs text-white/90",children:[e.jsxs("p",{children:[t.billing.cycleLabel,":"," ",e.jsx("strong",{children:ue(l?.billing_cycle_days??30,n)})]}),e.jsxs("p",{children:[t.billing.expiresLabel,":"," ",e.jsx("strong",{children:J(l?.expires_at??null,n)})]})]}),e.jsxs("div",{className:"mt-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-white/85",children:[e.jsx("span",{children:t.billing.usageProgress}),e.jsxs("span",{className:"font-semibold text-white",children:[ae,"%"]})]}),e.jsx(Ee,{"aria-label":t.billing.usageProgress,value:ae,size:"sm",color:"default",classNames:{track:"bg-white/25",indicator:"bg-white"}})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(_,{variant:"bordered",onPress:_e,isLoading:xe,children:t.billing.refreshButton}),e.jsx(_,{color:"primary",variant:z?"solid":"flat",onPress:()=>E(a=>!a),children:z?t.billing.hidePlanUpdateButton:t.billing.updatePlanButton})]})]})}):null,L?e.jsx(F,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs($,{className:"space-y-3 p-5",children:[e.jsx("p",{className:"text-sm font-medium text-default-500",children:t.billing.usageTitle}),e.jsx("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3",children:ve.map(a=>e.jsxs("div",{className:"rounded-medium border border-default-200 bg-default-50 p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-default-500",children:[e.jsx(g,{icon:a.icon,width:14}),e.jsx("p",{className:"text-[11px] leading-tight",children:a.label})]}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-foreground",children:a.value})]},a.key))})]})}):null]}),ye?e.jsx(F,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs($,{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:n==="ru"?"Доступные тарифы для вас":"Available plans for you"}),e.jsx("p",{className:"text-sm text-default-500",children:n==="ru"?"Выберите подходящий тариф и выставьте счет.":"Choose the right plan and create an invoice."})]}),e.jsxs(Ue,{"aria-label":n==="ru"?"Период тарифа":"Plan duration",selectedKey:C,onSelectionChange:a=>Ce(String(a)),color:"primary",variant:"bordered",radius:"full",size:"sm",fullWidth:!0,disableAnimation:!0,children:[e.jsx(G,{title:n==="ru"?"1 месяц":"1 month"},"30"),e.jsx(G,{title:e.jsxs("span",{className:`inline-flex items-center gap-2 ${C==="90"?"py-0.5 pr-0.5":""}`,children:[e.jsx("span",{children:n==="ru"?"3 месяца":"3 months"}),e.jsx("span",{className:"rounded-full bg-success-100 px-2 py-0 text-[11px] font-semibold text-success-700",children:"-10%"})]})},"90"),e.jsx(G,{title:e.jsxs("span",{className:`inline-flex items-center gap-2 ${C==="180"?"py-0.5 pr-0":""}`,children:[e.jsx("span",{children:n==="ru"?"6 месяцев":"6 months"}),e.jsx("span",{className:"rounded-full bg-success-100 px-2 py-0.5 text-[11px] font-semibold text-success-700",children:"-20%"})]})},"180")]}),se.length===0?e.jsx("p",{className:"text-sm text-default-500",children:t.billing.noPlansAvailable}):e.jsx("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 lg:grid-cols-3",children:se.map(a=>{const c=S===a.code,r=et(a);return e.jsxs("button",{type:"button",onClick:()=>R(a.code),className:`rounded-large border p-4 text-left transition-colors ${c?"border-primary bg-primary/10":"border-default-200 bg-white hover:bg-default-50"}`,children:[e.jsxs("div",{className:"mb-3 flex items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:a.name}),e.jsxs("div",{className:"mt-0.5 flex flex-wrap items-center gap-2",children:[e.jsx("p",{className:"text-xs text-default-500",children:ue(a.billing_period_days,n)}),r>0?e.jsx(W,{size:"sm",color:"success",variant:"flat",children:n==="ru"?`Скидка ${r}%`:`Save ${r}%`}):null]})]}),e.jsx("p",{className:"text-lg font-bold text-foreground",children:h(a.price,a.currency,n)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:chat-line-linear",width:16}),e.jsxs("span",{children:[t.billing.includedChats,":"," ",a.included_chats]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:users-group-rounded-linear",width:16}),e.jsxs("span",{children:[t.billing.assistantLimit,":"," ",a.assistant_limit]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:link-minimalistic-2-linear",width:16}),e.jsxs("span",{children:[t.billing.integrationLimit,":"," ",a.integrations_per_channel_limit]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:dollar-minimalistic-linear",width:16}),e.jsx("span",{children:n==="ru"?`После исчерпания лимита: ${h(a.overage_chat_price,a.currency,n)} за 1 чат`:`After included limit: ${h(a.overage_chat_price,a.currency,n)} per extra chat`})]}),e.jsx("div",{className:"pt-1 text-xs font-medium text-default-500",children:n==="ru"?"Доступные каналы интеграции":"Available channels"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"fa6-brands:instagram",width:15}),e.jsx("span",{children:"Instagram"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:plain-2-linear",width:16}),e.jsx("span",{children:"Telegram"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:widget-2-linear",width:16}),e.jsx("span",{children:n==="ru"?"Виджет чата для сайта":"Website chat widget"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-default-700",children:[e.jsx(g,{icon:"solar:code-square-linear",width:16}),e.jsx("span",{children:n==="ru"?"API интеграция":"API integration"})]})]}),c?e.jsxs("div",{className:"mt-3 inline-flex items-center gap-1 rounded-full bg-primary/15 px-2 py-1 text-xs font-medium text-primary",children:[e.jsx(g,{icon:"solar:check-circle-linear",width:14}),e.jsx("span",{children:t.billing.selectedPlan})]}):null]},a.id)})}),e.jsxs("div",{className:"flex flex-col gap-3 rounded-medium border border-default-200 bg-default-50 p-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-default-500",children:t.billing.totalToPayLabel}),e.jsx("p",{className:"text-xl font-semibold text-foreground",children:f?h(be,f.currency,n):h("0","TJS",n)}),U>0&&f?e.jsxs("p",{className:"text-xs text-success-600",children:[t.billing.creditAppliedLabel,":"," ",h(U,f.currency,n)]}):null]}),e.jsx(_,{color:"primary",isLoading:T,onPress:we,children:T?t.billing.checkoutProcessing:t.billing.checkoutButton})]})]})}):null,e.jsx(F,{shadow:"none",className:"border border-default-200 bg-white",children:e.jsxs($,{className:"space-y-3 p-5",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t.billing.invoicesTitle}),e.jsx("p",{className:"text-sm text-default-500",children:t.billing.invoicesSubtitle})]}),he?e.jsx("p",{className:"text-sm text-default-500",children:t.common.loadingSession}):v.length===0?e.jsx("p",{className:"text-sm text-default-500",children:t.billing.noInvoices}):e.jsx("div",{className:"space-y-2",children:v.map(a=>{const c=st(a.status,t.billing),r=nt(a.status);return e.jsxs("div",{className:"flex flex-col gap-3 rounded-medium border border-default-200 p-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:a.number}),e.jsxs("p",{className:"text-xs text-default-500",children:[t.billing.invoiceDate,":"," ",J(a.created_at,n)]}),e.jsxs("p",{className:"text-xs text-default-500",children:[t.billing.invoiceDue,":"," ",J(a.due_at,n)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:h(a.total,a.currency,n)}),e.jsx(W,{size:"sm",color:c.color,variant:"flat",children:c.label}),r?e.jsx(_,{size:"sm",color:"primary",isLoading:X===a.id,onPress:()=>Pe(a.id),children:X===a.id?t.billing.payingButton:t.billing.payButton}):null]})]},a.id)})})]})})]})})}export{gt as default};
